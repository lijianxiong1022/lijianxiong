<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ç§åŸŸæŠ¥å•ç³»ç»Ÿ - æ‰€æœ‰é¡µé¢</title>
    <link rel="stylesheet" href="/static/css/site.css">
    <script src="user_api.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 0;
        margin: 0;
        color: #333;
        padding-bottom: 120px; /* å¢åŠ åº•éƒ¨paddingï¼Œé¿å…è¢«åº•éƒ¨æŒ‰é’®é®æŒ¡ */
      }
      
      #orders-page {
        padding-bottom: 80px; /* æŠ¥å•é¡µé¢éœ€è¦æ›´å¤šåº•éƒ¨ç©ºé—´ */
      }
      
      .page {
        display: none;
        max-width: 1080px;
        margin: 0 auto;
        padding: 15px;
      }
      
      .page.active {
        display: block;
      }
      
      .page-header {
        margin-bottom: 20px;
        padding: 15px 0 10px;
        text-align: center;
      }
      
      .page-header h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        color: #333;
      }
      
      .nav-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      
      .nav-btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      
      .nav-btn:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        transform: translateY(-2px);
      }
      
      .nav-btn:active {
        transform: translateY(0);
      }
      
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      
      .nav-item {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        font-size: 14px;
        color: #6c757d;
        text-decoration: none;
        transition: all 0.3s;
      }
      
      .nav-item.active {
        color: #007bff;
        font-weight: 500;
      }
      
      .nav-item:hover {
        color: #007bff;
      }
      
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 15px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 14px;
      }
      
      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
      }
      
      .form-control:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }
      
      .action-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }
      
      .action-btn {
        padding: 14px 18px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        text-align: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }
      
      .action-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }
      
      .action-btn:active::before {
        width: 300px;
        height: 300px;
      }
      
      .action-btn:active {
        transform: scale(0.98);
      }
      
      /* åº•éƒ¨æ“ä½œæŒ‰é’®æ  */
      .bottom-action-buttons {
        position: fixed;
        bottom: 60px;
        left: 0;
        right: 0;
        display: flex;
        gap: 8px;
        padding: 10px 15px;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }
      
      .bottom-action-btn {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        position: relative;
        pointer-events: auto;
        z-index: 1000;
      }
      
      .bottom-action-btn:active {
        transform: scale(0.96);
      }
      
      .badge-count {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
        min-width: 20px;
        text-align: center;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-primary:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
      }
      
      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        font-weight: 600;
      }
      
      .btn-success:hover {
        background: linear-gradient(135deg, #0d7a70 0%, #2dd469 100%);
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.35);
      }
      
      .btn-secondary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }
      
      .btn-secondary:hover {
        background: linear-gradient(135deg, #3d8be8 0%, #00d4e6 100%);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.35);
      }
      
      .btn-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
      }
      
      .btn-danger:hover {
        background: linear-gradient(135deg, #e85d88 0%, #e6c82a 100%);
        box-shadow: 0 4px 12px rgba(250, 112, 154, 0.35);
      }
      
      .status-filter {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
      }
      
      .filter-item {
        padding: 12px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 1px solid #eee;
      }
      
      .filter-item:last-child {
        border-bottom: none;
      }
      
      .filter-item.active {
        background-color: #007bff;
        color: white;
      }
      
      .filter-item:not(.active):hover {
        background-color: #e9ecef;
      }
      
      .order-card, .agent-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 15px;
      }
      
      .order-header, .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }
      
      .order-name, .agent-name {
        font-weight: 600;
        font-size: 16px;
      }
      
      .order-status, .agent-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        background-color: #e9ecef;
      }
      
      .order-status.pending, .agent-status.pending {
        background-color: #fff3cd;
        color: #856404;
      }
      
      .order-status.approved, .agent-status.active {
        background-color: #d4edda;
        color: #155724;
      }
      
      .order-status.rejected {
        background-color: #f8d7da;
        color: #721c24;
      }
      
      .order-status.settled {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      
      .order-details, .agent-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .order-detail, .agent-detail {
        font-size: 14px;
      }
      
      .order-detail-label, .agent-detail-label {
        color: #6c757d;
        margin-bottom: 2px;
      }
      
      .order-detail-value, .agent-detail-value {
        font-weight: 500;
      }
      
      .order-actions, .agent-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }
      
      .order-action-btn, .agent-action-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        border: none;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      
      .order-action-btn:hover, .agent-action-btn:hover {
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.35);
        transform: translateY(-2px);
      }
      
      .order-action-btn.delete, .agent-action-btn.delete {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
      }
      
      .order-action-btn.delete:hover, .agent-action-btn.delete:hover {
        box-shadow: 0 4px 12px rgba(250, 112, 154, 0.35);
      }
      
      .agent-stats {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
        text-align: center;
      }
      
      .stat-item {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }
      
      .stat-value {
        font-weight: 600;
        font-size: 16px;
        color: #007bff;
      }
      
      .stat-label {
        font-size: 12px;
        color: #6c757d;
      }
      
      /* Toasté€šçŸ¥æ ·å¼ */
      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #52c41a;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        font-size: 14px;
        animation: toastSlideIn 0.3s ease-out;
        max-width: 90%;
        text-align: center;
      }
      
      .toast.error {
        background: #ff4d4f;
      }
      
      .toast.warning {
        background: #faad14;
      }
      
      @keyframes toastSlideIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      /* ç¡®è®¤å¼¹çª—å±…ä¸­æ ·å¼ */
      .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      
      .confirm-modal.active {
        display: flex;
      }
      
      .confirm-modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #eee;
      }
      
      .modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }
      
      .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
      }
      
      .modal-body {
        padding: 16px;
      }
      
      .modal-footer {
        padding: 16px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #ddd;
      }
      
      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="page active">
      <div class="page-header">
        <h1>ç”¨æˆ·ç™»å½•</h1>
      </div>
      
      <div class="card">
        <div class="form-group">
          <label for="login-phone" class="form-label">æ‰‹æœºå·</label>
          <input type="text" id="login-phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
        </div>
        
        <div class="form-group">
          <label for="login-password" class="form-label">å¯†ç </label>
          <input type="password" id="login-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " />
        </div>
        
        <button class="nav-btn" onclick="handleLogin()">ç™»å½•</button>
      </div>
      
      <div class="card" style="text-align: center;">
        <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showPage('register-page')">ç«‹å³æ³¨å†Œ</a></p>
      </div>
    </div>
    
    <!-- æ³¨å†Œé¡µé¢ -->
    <div id="register-page" class="page">
      <div class="page-header">
        <h1>ç”¨æˆ·æ³¨å†Œ</h1>
      </div>
      
      <div class="card">
        <div class="form-group">
          <label for="register-name" class="form-label">å§“å <span style="color: #dc3545;">*</span></label>
          <input type="text" id="register-name" class="form-control" placeholder="è¯·è¾“å…¥å§“å" required />
        </div>
        
        <div class="form-group">
          <label for="register-phone" class="form-label">æ‰‹æœºå· <span style="color: #dc3545;">*</span></label>
          <input type="text" id="register-phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" required />
        </div>
        
        <div class="form-group">
          <label for="register-password" class="form-label">å¯†ç  <span style="color: #dc3545;">*</span></label>
          <input type="password" id="register-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </div>
        
        <div class="form-group">
          <label for="register-promo" class="form-label">æ¨å¹¿ç  <span style="color: #dc3545;">*</span></label>
          <input type="text" id="register-promo" class="form-control" placeholder="è¯·è¾“å…¥6ä½æ•°å­—æ¨å¹¿ç " maxlength="6" pattern="[0-9]{6}" required />
        </div>
        
        <div class="form-group">
          <label for="register-pay-password" class="form-label">æ”¯ä»˜å¯†ç  <span style="color: #dc3545;">*</span></label>
          <input type="password" id="register-pay-password" class="form-control" placeholder="è¯·è¾“å…¥æ”¯ä»˜å¯†ç ï¼ˆ6ä½æ•°å­—ï¼‰" maxlength="6" required />
        </div>
        
        <button class="nav-btn" onclick="handleRegister()">æ³¨å†Œ</button>
      </div>
      
      <div class="card" style="text-align: center;">
        <p>å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showPage('login-page')">ç«‹å³ç™»å½•</a></p>
      </div>
    </div>
    
    <!-- æŠ¥å•é¡µé¢ -->
    <div id="orders-page" class="page">
      <div class="page-header">
        <h1>æŠ¥å•ç³»ç»Ÿ</h1>
      </div>
      
      <!-- ç›´æ¨é¡µé¢å†…å®¹ -->
      <div id="direct-content">
        <!-- è®¢å•åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
        
        <!-- åº•éƒ¨æ“ä½œæŒ‰é’®æ  -->
        <div class="bottom-action-buttons">
          <button class="bottom-action-btn btn-secondary" onclick="toggleSelectAllOrders()">
            <span>å…¨é€‰</span>
          </button>
          <button class="bottom-action-btn btn-danger" onclick="deleteSelectedOrders()">
            <span>åˆ é™¤é€‰ä¸­</span>
          </button>
          <button class="bottom-action-btn btn-primary" onclick="openSelectDirectUserModal()">
            <span>æ·»åŠ ç”¨æˆ·</span>
          </button>
          <button class="bottom-action-btn btn-success" id="settleButton" type="button" onclick="settleOrders(); return false;" style="pointer-events: auto; cursor: pointer;">
            <span>æŠ¥å•</span>
            <span class="badge-count" id="settleCount">0</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- è®¢å•å†å²é¡µé¢ -->
    <div id="order-history-page" class="page">
      <div class="page-header">
        <h1>è®¢å•å†å²</h1>
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); flex-direction: column;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: 500;">æäº¤æ—¶é—´ç­›é€‰</label>
            <input type="date" id="historyDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" onchange="filterHistoryOrders()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: 500;">æŠ¥å•æ—¥æœŸç­›é€‰</label>
            <input type="date" id="settlementDateFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" onchange="filterHistoryOrders()" />
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: 500;">çŠ¶æ€ç­›é€‰</label>
            <select id="orderStatusFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" onchange="filterHistoryOrders()">
              <option value="">å…¨éƒ¨</option>
              <option value="pending">å¾…å®¡æ ¸</option>
              <option value="approved">å·²é€šè¿‡</option>
              <option value="exception_pending">å¼‚å¸¸å¾…å®¡æ ¸</option>
              <option value="exception_approved">å¼‚å¸¸å·²å—ç†</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666; font-weight: 500;">å…³é”®è¯æœç´¢</label>
            <input type="text" id="orderKeywordSearch" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="æ¨å¹¿ç /å§“å/ç¢°ç¢°é“¾æ¥" onkeyup="if(event.key==='Enter') filterHistoryOrders()" />
          </div>
        </div>
        <!-- å½“æ—¥ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="order-statistics" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
            <div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æäº¤æ¬¡æ•°</div>
              <div style="font-size: 20px; font-weight: bold; color: #007bff;" id="stat-submission-count">0</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»æ•°é‡</div>
              <div style="font-size: 20px; font-weight: bold; color: #28a745;" id="stat-total-quantity">0</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»é‡‘å¸</div>
              <div style="font-size: 20px; font-weight: bold; color: #ff4d4f;" id="stat-total-points">0.00</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- è®¢å•å†å²åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
      <div id="order-history-list"></div>
    </div>
    
    <!-- æˆ‘çš„ä»£ç†é¡µé¢ -->
    <div id="agents-page" class="page">
      <div class="page-header">
        <h1>æˆ‘çš„ä»£ç†</h1>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn btn-primary" onclick="document.getElementById('addAgentModal').style.display = 'flex'">æ–°å¢ä»£ç†</button>
      </div>
      
      <div class="agent-card">
        <div class="agent-header">
          <div class="agent-name">ä»£ç†A</div>
          <div class="agent-status active">æ­£å¸¸</div>
        </div>
        <div class="agent-details">
          <div class="agent-detail">
            <div class="agent-detail-label">æ‰‹æœºå·</div>
            <div class="agent-detail-value">138****1234</div>
          </div>
          <div class="agent-detail">
            <div class="agent-detail-label">æ¨å¹¿ç </div>
            <div class="agent-detail-value">A1B2C3</div>
          </div>
        </div>
        <div class="agent-stats">
          <div class="stat-item">
            <div class="stat-value">5</div>
            <div class="stat-label">ä»Šæ—¥æŠ¥å•æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">Â¥120.00</div>
            <div class="stat-label">ä»Šæ—¥æ€»ä»·</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">Â¥2560.00</div>
            <div class="stat-label">ç´¯è®¡æ€»ä»·</div>
          </div>
        </div>
        <div class="agent-actions">
          <button class="agent-action-btn" onclick="document.getElementById('agentDetailModal').style.display = 'flex'">æŸ¥çœ‹è¯¦æƒ…</button>
          <button class="agent-action-btn delete">åˆ é™¤</button>
        </div>
      </div>
    </div>
    
    <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
    <div id="profile-page" class="page">
      <div class="page-header">
        <h1>ä¸ªäººä¸­å¿ƒ</h1>
      </div>
      
      <div class="card">
        <div style="font-weight: 600; margin-bottom: 20px; font-size: 16px; color: #333;">ä¸ªäººä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
          <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #007bff;">
            <div style="color: #6c757d; font-size: 12px; margin-bottom: 6px;">å§“å</div>
            <div id="userNameDisplay" style="font-weight: 500; color: #333; font-size: 15px;">--</div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #28a745;">
            <div style="color: #6c757d; font-size: 12px; margin-bottom: 6px;">æ‰‹æœºå·</div>
            <div id="userPhoneDisplay" style="font-weight: 500; color: #333; font-size: 15px;">--</div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #ffc107; position: relative;">
            <div style="color: #6c757d; font-size: 12px; margin-bottom: 6px;">æ¨å¹¿ç </div>
            <div id="userPromoCode" style="font-weight: 500; color: #333; font-size: 15px; font-family: 'Courier New', monospace; padding-right: 30px;">--</div>
            <button onclick="copyPromoCode(); event.stopPropagation();" style="position: absolute; top: 12px; right: 12px; background: #1890ff; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;" title="å¤åˆ¶æ¨å¹¿ç ">
              ğŸ“‹
            </button>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #17a2b8;">
            <div style="color: #6c757d; font-size: 12px; margin-bottom: 6px;">æ³¨å†Œæ—¶é—´</div>
            <div id="userRegisterDate" style="font-weight: 500; color: #333; font-size: 15px;">--</div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #dc3545;">
            <div style="color: #6c757d; font-size: 12px; margin-bottom: 6px;">ä¼šå‘˜ç±»å‹</div>
            <div id="userRole" style="font-weight: 500; color: #333; font-size: 15px;">--</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div style="font-weight: 600; margin-bottom: 15px;">è´¦æˆ·ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          <div class="stat-item" style="position: relative;">
            <div class="stat-value" id="currentPointsValue">0</div>
            <button onclick="refreshPointsInfo(); event.stopPropagation();" style="position: absolute; top: 5px; right: 5px; background: #1890ff; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;" title="åˆ·æ–°é‡‘å¸ä½™é¢">
              ğŸ”„
            </button>
            <div class="stat-label">å½“å‰é‡‘å¸</div>
          </div>
          <div class="stat-item" style="cursor: pointer;" onclick="showCashProfitList()">
            <div class="stat-value" id="cashProfit">0.00</div>
            <div class="stat-label">ç°é‡‘æ”¶ç›Š <span style="font-size: 12px; color: #1890ff;">(ç‚¹å‡»æŸ¥çœ‹)</span></div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="todayPoints">1200</div>
            <div class="stat-label">ä»Šæ—¥æ¶ˆè€—é‡‘å¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="yesterdayPoints">800</div>
            <div class="stat-label">æ˜¨æ—¥æ¶ˆè€—é‡‘å¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="monthPoints">12800</div>
            <div class="stat-label">æœ¬æœˆæ¶ˆè€—é‡‘å¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="lastMonthPoints">8600</div>
            <div class="stat-label">ä¸Šæœˆæ¶ˆè€—é‡‘å¸</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-weight: 600;">ä»£ç†å¥–åŠ±</div>
          <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="showRewardDetailModal()">æŸ¥çœ‹æ˜ç»†</button>
        </div>
        <div class="agent-stats" style="margin-bottom: 0;">
          <div class="stat-item">
            <div class="stat-value" id="directRewardToday">Â¥0.00</div>
            <div class="stat-label">ä»Šæ—¥ç›´æ¨å¥–åŠ±</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="indirectRewardToday">Â¥0.00</div>
            <div class="stat-label">ä»Šæ—¥é—´æ¨å¥–åŠ±</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalRewardValue">Â¥0.00</div>
            <div class="stat-label">ç´¯è®¡å¥–åŠ±</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div style="font-weight: 600; margin-bottom: 15px;">åŠŸèƒ½æ“ä½œ</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="nav-btn" onclick="document.getElementById('transferPointsModal').style.display = 'flex'">é‡‘å¸è½¬è´¦</button>
          <button class="nav-btn" onclick="loadPointsHistory()">é‡‘å¸æŸ¥è¯¢</button>
          <button class="nav-btn" onclick="document.getElementById('contactBusinessModal').style.display = 'flex'">è”ç³»å•†å®¶</button>
          <button class="nav-btn" onclick="document.getElementById('changePasswordModal').style.display = 'flex'">ä¿®æ”¹ç™»å½•å¯†ç </button>
          <button class="nav-btn" onclick="document.getElementById('changePayPasswordModal').style.display = 'flex'">ä¿®æ”¹æ”¯ä»˜å¯†ç </button>
          <button class="nav-btn" style="background-color: #dc3545;" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </div>
    
    <!-- ä¿®æ”¹ç™»å½•å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePasswordModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä¿®æ”¹ç™»å½•å¯†ç </h5>
          <button type="button" class="btn-close" onclick="document.getElementById('changePasswordModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="old-password" class="form-label">å½“å‰å¯†ç </label>
            <input type="password" id="old-password" class="form-control" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " />
          </div>
          <div class="form-group">
            <label for="new-password" class="form-label">æ–°å¯†ç </label>
            <input type="password" id="new-password" class="form-control" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" />
          </div>
          <div class="form-group">
            <label for="confirm-password" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirm-password" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('changePasswordModal').style.display = 'none'">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="confirmChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
      </div>
    </div>
    
    <!-- ä¿®æ”¹æ”¯ä»˜å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePayPasswordModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä¿®æ”¹æ”¯ä»˜å¯†ç </h5>
          <button type="button" class="btn-close" onclick="document.getElementById('changePayPasswordModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="old-pay-password" class="form-label">å½“å‰æ”¯ä»˜å¯†ç </label>
            <input type="password" id="old-pay-password" class="form-control" placeholder="è¯·è¾“å…¥å½“å‰æ”¯ä»˜å¯†ç ï¼ˆ6ä½æ•°å­—ï¼‰" maxlength="6" />
          </div>
          <div class="form-group">
            <label for="new-pay-password" class="form-label">æ–°æ”¯ä»˜å¯†ç </label>
            <input type="password" id="new-pay-password" class="form-control" placeholder="è¯·è¾“å…¥æ–°æ”¯ä»˜å¯†ç ï¼ˆ6ä½æ•°å­—ï¼‰" maxlength="6" />
          </div>
          <div class="form-group">
            <label for="confirm-pay-password" class="form-label">ç¡®è®¤æ–°æ”¯ä»˜å¯†ç </label>
            <input type="password" id="confirm-pay-password" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°æ”¯ä»˜å¯†ç " maxlength="6" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('changePayPasswordModal').style.display = 'none'">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="confirmChangePayPassword()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
      </div>
    </div>
    
    <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
    <div id="users-page" class="page">
      <div class="page-header">
        <h1>ç”¨æˆ·ç®¡ç†</h1>
      </div>
      
      <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
      <div style="display: flex; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; overflow: hidden;">
        <div id="tab-nonmember" style="flex: 1; text-align: center; padding: 12px 0; font-weight: 500; cursor: pointer; background-color: #007bff; color: white;" onclick="switchUserTab('nonmember')">éä¼šå‘˜ç”¨æˆ·</div>
        <div id="tab-ordinary" style="flex: 1; text-align: center; padding: 12px 0; font-weight: 500; cursor: pointer; background-color: #e9ecef;" onclick="switchUserTab('ordinary')">æ™®é€šç”¨æˆ·</div>
        <div id="tab-agent" style="flex: 1; text-align: center; padding: 12px 0; font-weight: 500; cursor: pointer; background-color: #e9ecef;" onclick="switchUserTab('agent')">ä»£ç†ç”¨æˆ·</div>
      </div>
      
      <!-- éä¼šå‘˜ç”¨æˆ·å†…å®¹ -->
      <div id="nonmember-users-content">
        <div class="action-buttons">
          <button class="action-btn btn-primary" onclick="document.getElementById('addNonmemberUserModal').style.display = 'flex'">æ–°å¢éä¼šå‘˜ç”¨æˆ·</button>
        </div>
        
        <!-- éä¼šå‘˜åˆ—è¡¨å®¹å™¨ -->
        <div id="nonmember-list"></div>
      </div>
      
      <!-- æ™®é€šç”¨æˆ·å†…å®¹ -->
      <div id="ordinary-users-content" style="display: none;">
        <!-- æ™®é€šç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
        <div id="ordinary-users-list"></div>
      </div>
      
      <!-- ä»£ç†ç”¨æˆ·å†…å®¹ -->
      <div id="agent-users-content" style="display: none;">
        <div id="agent-content-display">
          <!-- æ ¹æ®å½“å‰ç”¨æˆ·ç±»å‹åŠ¨æ€æ˜¾ç¤ºå†…å®¹ -->
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <a href="#" class="nav-item active" onclick="showPage('orders-page')">æŠ¥å•</a>
      <a href="#" class="nav-item" onclick="showPage('order-history-page')">è®¢å•</a>
      <a href="#" class="nav-item" onclick="showPage('users-page')">ç”¨æˆ·ç®¡ç†</a>
      <a href="#" class="nav-item" onclick="showPage('profile-page')">æˆ‘çš„</a>
    </div>
    
    <!-- å¼‚å¸¸æŠ¥å•æ¨¡æ€æ¡† -->
    <div class="modal" id="exceptionOrderModal" style="display: none;">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h5 class="modal-title">å¼‚å¸¸æŠ¥å•</h5>
          <button type="button" class="btn-close" onclick="closeExceptionOrderModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="exceptionOrderId" />
          <div class="form-group">
            <label for="exceptionDescription" class="form-label">å¼‚å¸¸è¯´æ˜ <span style="color: red;">*</span></label>
            <textarea id="exceptionDescription" class="form-control" rows="4" placeholder="è¯·è¯¦ç»†æè¿°å¼‚å¸¸æƒ…å†µ" style="resize: vertical;"></textarea>
          </div>
          <div class="form-group">
            <label for="exceptionImageFiles" class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
            <input type="file" id="exceptionImageFiles" class="form-control" accept="image/*" multiple onchange="previewExceptionImages(this)" />
            <div id="exceptionImagePreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
            <small style="color: #666; font-size: 12px;">æ”¯æŒå¤šå¼ å›¾ç‰‡ï¼Œæ ¼å¼ï¼šPNGã€JPGã€JPEGã€GIFã€WEBP</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeExceptionOrderModal()">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitExceptionOrder()">æäº¤</button>
        </div>
      </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="addUserModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ·»åŠ ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('addUserModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="name" class="form-label">å§“å</label>
            <input type="text" id="name" class="form-control" placeholder="è¯·è¾“å…¥å§“å" />
          </div>
          
          <div class="form-group">
            <label for="phone" class="form-label">æ‰‹æœºå·</label>
            <input type="text" id="phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
          
          <div class="form-group">
            <label for="alipay_code" class="form-label">æ”¯ä»˜å®é‚€è¯·ç </label>
            <input type="text" id="alipay_code" class="form-control" placeholder="è¯·è¾“å…¥æ”¯ä»˜å®é‚€è¯·ç " />
          </div>
          
          <div class="form-group">
            <label for="days" class="form-label">å¤©æ•°</label>
            <select id="days" class="form-control">
              <option value="1" selected>1å¤©</option>
              <option value="2">2å¤©</option>
              <option value="3">3å¤©</option>
              <option value="4">4å¤©</option>
              <option value="5">5å¤©</option>
              <option value="6">6å¤©</option>
              <option value="7">7å¤©</option>
              <option value="8">8å¤©</option>
              <option value="9">9å¤©</option>
              <option value="10">10å¤©</option>
              <option value="11">11å¤©</option>
              <option value="12">12å¤©</option>
              <option value="13">13å¤©</option>
              <option value="14">14å¤©</option>
              <option value="15">15å¤©</option>
              <option value="16">16å¤©</option>
              <option value="17">17å¤©</option>
              <option value="18">18å¤©</option>
              <option value="19">19å¤©</option>
              <option value="20">20å¤©</option>
              <option value="21">21å¤©</option>
              <option value="22">22å¤©</option>
              <option value="23">23å¤©</option>
              <option value="24">24å¤©</option>
              <option value="25">25å¤©</option>
              <option value="26">26å¤©</option>
              <option value="27">27å¤©</option>
              <option value="28">28å¤©</option>
              <option value="29">29å¤©</option>
              <option value="30">30å¤©</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('addUserModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
        </div>
      </div>
    </div>
    
    <!-- é€‰æ‹©ç›´æ¨ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="selectDirectUserModal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h5 class="modal-title">æ·»åŠ ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('selectDirectUserModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <!-- æ ‡ç­¾é¡µï¼ˆä»£ç†ä¼šå‘˜æ˜¾ç¤ºï¼Œæ™®é€šä¼šå‘˜ä¸æ˜¾ç¤ºï¼‰ -->
          <div id="order-user-tabs" style="display: none; margin-bottom: 15px; border-bottom: 1px solid #eee;">
            <div style="display: flex; gap: 0;">
              <div class="order-user-tab active" id="order-tab-nonmember" onclick="switchOrderUserTab('nonmember')" style="padding: 10px 20px; cursor: pointer; border-bottom: 2px solid #007bff; color: #007bff; font-weight: 500;">éä¼šå‘˜</div>
              <div class="order-user-tab" id="order-tab-ordinary" onclick="switchOrderUserTab('ordinary')" style="padding: 10px 20px; cursor: pointer; color: #666;">æ™®é€šä¼šå‘˜</div>
              <div class="order-user-tab" id="order-tab-agent" onclick="switchOrderUserTab('agent')" style="padding: 10px 20px; cursor: pointer; color: #666;">ä»£ç†ä¼šå‘˜</div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <input type="text" id="searchDirectUser" placeholder="æœç´¢ç”¨æˆ·å§“å" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" oninput="searchDirectUsers()" />
          </div>
          
          <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <input type="checkbox" id="selectAllDirect" style="margin-right: 8px;" onchange="toggleSelectAllDirect()" />
            <label for="selectAllDirect" style="margin-right: 12px; cursor: pointer;">å…¨é€‰</label>
          </div>
          
          <!-- éä¼šå‘˜åˆ—è¡¨ -->
          <div id="order-nonmember-list" class="order-user-list">
            <!-- éä¼šå‘˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </div>
          
          <!-- æ™®é€šä¼šå‘˜åˆ—è¡¨ï¼ˆä»…ä»£ç†ä¼šå‘˜å¯è§ï¼‰ -->
          <div id="order-ordinary-list" class="order-user-list" style="display: none;">
            <!-- æ™®é€šä¼šå‘˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </div>
          
          <!-- ä»£ç†ä¼šå‘˜åˆ—è¡¨ï¼ˆä»…ä»£ç†ä¼šå‘˜å¯è§ï¼‰ -->
          <div id="order-agent-list" class="order-user-list" style="display: none;">
            <!-- ä»£ç†ä¼šå‘˜åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('selectDirectUserModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="openAddDirectUserModal()">æ–°å¢</button>
          <button type="button" class="btn btn-success" onclick="addSelectedDirectUsers()">ä¿å­˜</button>
        </div>
      </div>
    </div>
    
    <!-- æ–°å¢ç›´æ¨ç”¨æˆ·æ¨¡æ€æ¡†ï¼ˆæŠ¥å•é¡µé¢ä½¿ç”¨ï¼‰ -->
    <div class="modal" id="addDirectUserModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('addDirectUserModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="directUserName" class="form-label">å§“å</label>
            <input type="text" id="directUserName" class="form-control" placeholder="è¯·è¾“å…¥å§“å" />
          </div>
          
          <div class="form-group">
            <label for="directUserLink" class="form-label">ç¢°ç¢°é“¾æ¥</label>
            <input type="text" id="directUserLink" class="form-control" placeholder="è¯·è¾“å…¥ç¢°ç¢°é“¾æ¥" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('addDirectUserModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="addDirectUserBtn" onclick="saveAndSelectDirectUser()">ä¿å­˜å¹¶é€‰æ‹©</button>
        </div>
      </div>
    </div>
    
    <!-- æ–°å¢éä¼šå‘˜ç”¨æˆ·æ¨¡æ€æ¡†ï¼ˆç”¨æˆ·ç®¡ç†é¡µé¢ä½¿ç”¨ï¼‰ -->
    <div class="modal" id="addNonmemberUserModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢éä¼šå‘˜ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('addNonmemberUserModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="nonmemberUserName" class="form-label">å§“å</label>
            <input type="text" id="nonmemberUserName" class="form-control" placeholder="è¯·è¾“å…¥å§“å" />
          </div>
          
          <div class="form-group">
            <label for="nonmemberUserLink" class="form-label">ç¢°ç¢°é“¾æ¥</label>
            <input type="text" id="nonmemberUserLink" class="form-control" placeholder="è¯·è¾“å…¥ç¢°ç¢°é“¾æ¥" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('addNonmemberUserModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveNonmemberUser()">ç¡®å®š</button>
        </div>
      </div>
    </div>
    
    <!-- æ·»åŠ ä»£ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="addAgentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢ä»£ç†</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('addAgentModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="agentName" class="form-label">ä»£ç†å§“å</label>
            <input type="text" id="agentName" class="form-control" placeholder="è¯·è¾“å…¥ä»£ç†å§“å" />
          </div>
          
          <div class="form-group">
            <label for="agentPhone" class="form-label">æ‰‹æœºå·</label>
            <input type="text" id="agentPhone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
          
          <div class="form-group">
            <label for="agentPromoCode" class="form-label">æ¨å¹¿ç </label>
            <input type="text" id="agentPromoCode" class="form-control" placeholder="è¯·è¾“å…¥æ¨å¹¿ç " />
          </div>
          
          <div class="form-group">
            <label for="agentInitialPrice" class="form-label">åˆå§‹å•ä»·</label>
            <input type="number" id="agentInitialPrice" class="form-control" placeholder="è¯·è¾“å…¥åˆå§‹å•ä»·" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAgentModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </div>
    </div>
    
    <!-- ä»£ç†è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="agentDetailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä»£ç†è¯¦æƒ…</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('agentDetailModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="agent-card">
            <div class="agent-header">
              <div class="agent-name">ä»£ç†A</div>
              <div class="agent-status active">æ­£å¸¸</div>
            </div>
            <div class="agent-details">
              <div class="agent-detail">
                <div class="agent-detail-label">æ‰‹æœºå·</div>
                <div class="agent-detail-value">138****1234</div>
              </div>
              <div class="agent-detail">
                <div class="agent-detail-label">æ¨å¹¿ç </div>
                <div class="agent-detail-value">A1B2C3</div>
              </div>
            </div>
            <div class="agent-stats">
              <div class="stat-item">
                <div class="stat-value">5</div>
                <div class="stat-label">ä»Šæ—¥æŠ¥å•æ•°</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">Â¥120.00</div>
                <div class="stat-label">ä»Šæ—¥æ€»ä»·</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">Â¥2560.00</div>
                <div class="stat-label">ç´¯è®¡æ€»ä»·</div>
              </div>
            </div>
          </div>
          
          <h3 style="margin: 20px 0 10px; font-size: 18px;">ä»Šæ—¥æŠ¥å•è¯¦æƒ…</h3>
          <!-- ä»Šæ—¥æŠ¥å•è¯¦æƒ…å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
          <div id="today-order-details"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('agentDetailModal').style.display = 'none'">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <!-- æ–°å¢ä»£ç†ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="addAgentUserModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢ä»£ç†ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('addAgentUserModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="agentUserName" class="form-label">å§“å</label>
            <input type="text" id="agentUserName" class="form-control" placeholder="è¯·è¾“å…¥å§“å" />
          </div>
          
          <div class="form-group">
            <label for="agentUserPhone" class="form-label">æ‰‹æœºå·</label>
            <input type="text" id="agentUserPhone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
          
          <div class="form-group">
            <label for="agentUserLink" class="form-label">ç¢°ç¢°é“¾æ¥</label>
            <input type="text" id="agentUserLink" class="form-control" placeholder="è¯·è¾“å…¥ç¢°ç¢°é“¾æ¥" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAgentUserModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveAgentUser()">ä¿å­˜</button>
        </div>
      </div>
    </div>
    
    <!-- å‡çº§ä¸ºæ™®é€šç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="upgradeToOrdinaryModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å‡çº§ä¸ºæ™®é€šç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('upgradeToOrdinaryModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="upgradeToOrdinaryPhone" class="form-label">æ‰‹æœºå·</label>
            <input type="text" id="upgradeToOrdinaryPhone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
          <div style="color: #6c757d; font-size: 13px; margin-top: 10px;">
            å¡«å†™æ‰‹æœºå·åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç»‘å®šä¸Šä¸‹çº§å…³ç³»ï¼Œè¯¥ç”¨æˆ·æ³¨å†Œæ—¶ä¸Šçº§æ¨å¹¿ç å°†è‡ªåŠ¨å¡«å†™ä¸”ä¸å¯æ›´æ”¹ã€‚
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('upgradeToOrdinaryModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="confirmUpgradeToOrdinary()">ç¡®è®¤å‡çº§</button>
        </div>
      </div>
    </div>
    
    <!-- å‡çº§ä¸ºä»£ç†ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="upgradeToAgentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å‡çº§ä¸ºä»£ç†ç”¨æˆ·</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('upgradeToAgentModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="upgradeToAgentPhone" class="form-label">æ‰‹æœºå·</label>
            <input type="text" id="upgradeToAgentPhone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('upgradeToAgentModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="confirmUpgradeToAgent()">ç¡®è®¤å‡çº§</button>
        </div>
      </div>
    </div>
    
    <!-- ç”³è¯·æˆä¸ºä»£ç†æç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="applyAgentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ç”³è¯·æˆä¸ºä»£ç†</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('applyAgentModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px;">
            <p>è¯·è”ç³»æ‚¨çš„ä¸Šçº§ä»£ç†ç”³è¯·æˆä¸ºä»£ç†ç”¨æˆ·ã€‚</p>
            <div style="margin-top: 20px;">
              <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">ä¸Šçº§å§“åï¼š<span id="parentContactName">--</span></p>
              <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">ä¸Šçº§ç”µè¯ï¼š<span id="parentContactPhone">--</span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('applyAgentModal').style.display = 'none'">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <!-- é‡‘å¸è½¬è´¦æ¨¡æ€æ¡† -->
    <div class="modal" id="transferPointsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é‡‘å¸è½¬è´¦</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('transferPointsModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="transferToPhone" class="form-label">è½¬è´¦ç»™ï¼ˆæ‰‹æœºå·ï¼‰</label>
            <input type="text" id="transferToPhone" class="form-control" placeholder="è¯·è¾“å…¥å¯¹æ–¹æ‰‹æœºå·" />
          </div>
          
          <div class="form-group">
            <label for="transferQuantity" class="form-label">è½¬è´¦æ•°é‡</label>
            <input type="number" id="transferQuantity" class="form-control" placeholder="è¯·è¾“å…¥è½¬è´¦æ•°é‡" min="0" step="1" />
          </div>

          <div class="form-group">
            <label for="transferUnitPrice" class="form-label">è½¬è´¦å•ä»·ï¼ˆå…ƒ/é‡‘å¸ï¼‰</label>
            <input type="number" id="transferUnitPrice" class="form-control" placeholder="è¯·è¾“å…¥è½¬è´¦å•ä»·" min="0" step="0.1" />
            <small style="color: #999; font-size: 12px;">è½¬è´¦å•ä»·ä¸èƒ½é«˜äºåå°è®¾å®šçš„æœ€é«˜å•ä»·ï¼Œä¸èƒ½ä½äºæ‚¨çš„è´­ä¹°ä»·æ ¼ï¼ˆç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„å……å€¼è®°å½•è®¡ç®—è´­ä¹°ä»·æ ¼ï¼‰</small>
          </div>
          
          <div class="form-group">
            <label for="transferPointsPassword" class="form-label">æ”¯ä»˜å¯†ç </label>
            <input type="password" id="transferPointsPassword" class="form-control" placeholder="è¯·è¾“å…¥æ”¯ä»˜å¯†ç " />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('transferPointsModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="transferPoints()">ç¡®è®¤è½¬è´¦</button>
        </div>
      </div>
    </div>
    
    <!-- é‡‘å¸ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="pointsConfirmationModal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
          <h5 class="modal-title" style="color: white; font-size: 18px; font-weight: 600;">é‡‘å¸æŠ¥å•ç¡®è®¤</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('pointsConfirmationModal').style.display = 'none'" style="color: white;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <!-- æŠ¥å•ä¿¡æ¯å¡ç‰‡ -->
          <div style="background: #f8f9fa; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="color: #6c757d; font-size: 14px;">æŠ¥å•æ•°é‡</span>
              <span style="font-size: 20px; font-weight: 600; color: #007bff;" id="todayOrderCount">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #6c757d; font-size: 14px;">æŠ¥å•æ—¥æœŸ</span>
              <input type="date" id="settlementDate" class="form-control" style="width: auto; padding: 6px 12px; font-size: 14px;" />
            </div>
          </div>
          
          <!-- é‡‘å¸è®¡ç®—è¯¦æƒ… -->
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 12px; color: #333; font-size: 15px;">è´¹ç”¨æ˜ç»†</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px;">
                <div style="color: #6c757d; font-size: 12px; margin-bottom: 4px;">åŸºç¡€å•ä»·</div>
                <div style="font-size: 16px; font-weight: 600; color: #333;" id="initialPointPrice">0</div>
                <div style="color: #999; font-size: 11px;">é‡‘å¸</div>
              </div>
              <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px;">
                <div style="color: #6c757d; font-size: 12px; margin-bottom: 4px;">ä¼˜æƒ æŠ˜æ‰£</div>
                <div style="font-size: 16px; font-weight: 600; color: #28a745;" id="discountPointPrice">0%</div>
                <div style="color: #999; font-size: 11px;">æŠ˜æ‰£ç‡</div>
              </div>
            </div>
          </div>
          
          <!-- é‡‘å¸ä½™é¢ä¿¡æ¯ -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 16px; color: white; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 14px; opacity: 0.9;">å½“å‰é‡‘å¸</span>
              <span style="font-size: 20px; font-weight: 600;" id="currentPointsBalance">0</span>
            </div>
            <div style="height: 1px; background: rgba(255, 255, 255, 0.3); margin: 12px 0;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 14px; opacity: 0.9;">æ‰£é™¤é‡‘å¸</span>
              <span style="font-size: 20px; font-weight: 600; color: #ffd700;" id="totalDeductionPoints">0</span>
            </div>
            <div style="height: 1px; background: rgba(255, 255, 255, 0.3); margin: 12px 0;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 14px; opacity: 0.9;">å‰©ä½™é‡‘å¸</span>
              <span style="font-size: 24px; font-weight: 700;" id="remainingPointsBalance">0</span>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #f0f0f0; display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('pointsConfirmationModal').style.display = 'none'" style="padding: 10px 20px;">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="confirmPointsDeduction()" style="padding: 10px 24px; font-weight: 600;">ç¡®è®¤æŠ¥å•</button>
        </div>
      </div>
    </div>
    
    <!-- æŠ¥å•æˆåŠŸæ¨¡æ€æ¡† -->
    <div class="modal" id="orderSuccessModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æŠ¥å•æˆåŠŸ</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('orderSuccessModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; color: #28a745; margin-bottom: 10px;">âœ“</div>
            <h3>æŠ¥å•æˆåŠŸ</h3>
            <p>æ‚¨çš„è®¢å•å·²æˆåŠŸæäº¤</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('orderSuccessModal').style.display = 'none';">ç¡®å®š</button>
        </div>
      </div>
    </div>
    
    <!-- å¼‚å¸¸æŠ¥é”™æ¨¡æ€æ¡† -->
    <div class="modal" id="exceptionReportModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å¼‚å¸¸æŠ¥é”™</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('exceptionReportModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="exceptionDescription" class="form-label">å¼‚å¸¸è¯´æ˜</label>
            <textarea id="exceptionDescription" class="form-control" rows="4" placeholder="è¯·è¯¦ç»†æè¿°å¼‚å¸¸æƒ…å†µ"></textarea>
          </div>
          
          <div class="form-group">
            <label for="exceptionImage" class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
            <input type="file" id="exceptionImage" class="form-control" accept="image/*" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('exceptionReportModal').style.display = 'none'">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitExceptionReport()">ç¡®è®¤æäº¤</button>
        </div>
      </div>
    </div>
    
    <!-- å¼‚å¸¸æŠ¥é”™æˆåŠŸæ¨¡æ€æ¡† -->
    <div class="modal" id="exceptionSuccessModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æäº¤æˆåŠŸ</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('exceptionSuccessModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; color: #28a745; margin-bottom: 10px;">âœ“</div>
            <h3>æäº¤æˆåŠŸ</h3>
            <p>å¼‚å¸¸æŠ¥å‘Šå·²æˆåŠŸæäº¤ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('exceptionSuccessModal').style.display = 'none'">ç¡®å®š</button>
        </div>
      </div>
    </div>
    
    <!-- é‡‘å¸å†å²è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="pointsHistoryModal">
      <div class="modal-content" style="width: 90%; max-width: 600px;">
        <div class="modal-header">
          <h5 class="modal-title">é‡‘å¸ä½¿ç”¨è®°å½•</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('pointsHistoryModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #f8f9fa;">
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ—¶é—´</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ç±»å‹</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é‡‘å¸å˜åŠ¨</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ä½™é¢</th>
                </tr>
              </thead>
              <tbody id="pointsHistoryTable">
                <!-- é‡‘å¸å†å²è®°å½•å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
                <tr>
                  <td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— äº¤æ˜“è®°å½•</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('pointsHistoryModal').style.display = 'none'">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <!-- è”ç³»å•†å®¶æ¨¡æ€æ¡† -->
    <div class="modal" id="contactBusinessModal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">è”ç³»å•†å®¶</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('contactBusinessModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">å•†å®¶è”ç³»æ–¹å¼</div>
            <div style="margin-bottom: 15px;">
              <div style="font-weight: bold; margin-bottom: 5px;">å®¢æœå¾®ä¿¡</div>
              <div id="businessWeChat">kefu123456</div>
            </div>
            <div style="margin-bottom: 15px;">
              <div style="font-weight: bold; margin-bottom: 5px;">å®¢æœç”µè¯</div>
              <div id="businessPhone">400-123-4567</div>
            </div>
            <div>
              <div style="font-weight: bold; margin-bottom: 5px;">QQç¾¤</div>
              <div id="businessQQGroup">123456789</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('contactBusinessModal').style.display = 'none'">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <!-- å¥–åŠ±æ˜ç»†æ¨¡æ€æ¡† -->
    <div class="modal" id="rewardDetailModal">
      <div class="modal-content" style="width: 90%; max-width: 600px;">
        <div class="modal-header">
          <h5 class="modal-title">å¥–åŠ±æ˜ç»†</h5>
          <button type="button" class="btn-close" onclick="document.getElementById('rewardDetailModal').style.display = 'none'">&times;</button>
        </div>
        <div class="modal-body">
          <div style="max-height: 400px; overflow-y: auto;">
            <table class="table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #f8f9fa;">
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ—¶é—´</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ç”¨æˆ·</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ç±»å‹</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">å¥–åŠ±</th>
                </tr>
              </thead>
              <tbody id="rewardDetailTableModal">
                <tr>
                  <td style="padding: 10px; border: 1px solid #ddd;" colspan="4" style="text-align: center; color: #6c757d;">åŠ è½½ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('rewardDetailModal').style.display = 'none'">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <script>
      const backendSettings = {
        basePointPrice: {
          default: 1,
          friday: 1.5,
        },
        discountRules: [
          { minOrders: 20, discount: 0.4 },
          { minOrders: 10, discount: 0.25 },
          { minOrders: 5, discount: 0.1 },
        ],
        rewardRates: {
          direct: 0.03,
          indirect: 0.01,
        },
        transferLimits: {
          minQuantity: 10,
          maxUnitPrice: 1.5, // æœ€é«˜è½¬è´¦å•ä»·ï¼ˆå…ƒ/é‡‘å¸ï¼‰ï¼Œä»åç«¯è·å–
        },
        coinExchangeRate: 10.0, // é‡‘å¸ä¸ç°é‡‘å…‘æ¢ç‡ï¼ˆå…ƒ/é‡‘å¸ï¼‰ï¼Œä»åç«¯è·å–
        rechargeDiscountRules: [], // å……å€¼ä¼˜æƒ è§„åˆ™ï¼Œä»åç«¯è·å–
      };

      const rewardSummary = {
        directToday: 0,
        indirectToday: 0,
        directTotal: 0,
        indirectTotal: 0,
        details: [],
      };

      let pendingOrderCount = 0;
      let existingTodayOrderCount = 0;
      let cachedCurrentPoints = 0;

      // é¡µé¢åˆ‡æ¢å‡½æ•°
      function showPage(pageId) {
        // éšè—æ‰€æœ‰é¡µé¢
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
        document.getElementById(pageId).classList.add('active');
        
        // ç™»å½•å’Œæ³¨å†Œé¡µé¢éšè—åº•éƒ¨å¯¼èˆª
        const bottomNav = document.querySelector('.bottom-nav');
        if (pageId === 'login-page' || pageId === 'register-page') {
          if (bottomNav) {
            bottomNav.style.display = 'none';
          }
        } else {
          if (bottomNav) {
            bottomNav.style.display = 'flex';
          }
        }
        
        // æ›´æ–°åº•éƒ¨å¯¼èˆªé«˜äº®
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // æ ¹æ®é¡µé¢IDè®¾ç½®å¯¹åº”çš„å¯¼èˆªé¡¹ä¸ºactive
        const navMap = {
          'orders-page': 0,
          'order-history-page': 1,
          'users-page': 2,
          'profile-page': 3
        };
        
        const navItems = document.querySelectorAll('.nav-item');
        if (navMap.hasOwnProperty(pageId) && navItems[navMap[pageId]]) {
          navItems[navMap[pageId]].classList.add('active');
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°è®¢å•å†å²é¡µé¢ï¼ŒåŠ è½½è®¢å•æ•°æ®
        if (pageId === 'order-history-page' && userApiService.isAuthenticated()) {
          // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
          setTimeout(() => {
            loadOrderHistory();
          }, 50);
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°æˆ‘çš„é¡µé¢ï¼ŒåŠ è½½å¥–åŠ±ç»Ÿè®¡ï¼ˆä»…ä»£ç†ç”¨æˆ·ï¼‰
        if (pageId === 'profile-page' && userApiService.isAuthenticated() && currentUserRole === 'agent') {
          setTimeout(() => {
            loadRewardStatistics();
          }, 50);
        }
      }
      
      // é¢‘é“åˆ‡æ¢å‡½æ•°
      function switchChannel(channel) {
        if (channel === 'direct') {
          document.getElementById('direct-content').style.display = 'block';
          document.getElementById('agent-content').style.display = 'none';
        } else {
          document.getElementById('direct-content').style.display = 'none';
          document.getElementById('agent-content').style.display = 'block';
        }
      }
      
      // å½“å‰ç”¨æˆ·ç±»å‹ï¼ˆä»åç«¯è·å–ï¼Œè¿™é‡Œæ¨¡æ‹Ÿï¼‰
      let currentUserRole = 'agent'; // 'ordinary' æˆ– 'agent'
      
      // ç”Ÿæˆ6ä½éšæœºæ•°å­—æ¨å¹¿ç 
      function generatePromoCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }
      
      // ç”¨æˆ·æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
      function switchUserTab(tab) {
        // é‡ç½®æ‰€æœ‰tabæ ·å¼
        document.getElementById('tab-nonmember').style.backgroundColor = '#e9ecef';
        document.getElementById('tab-nonmember').style.color = '#333';
        document.getElementById('tab-ordinary').style.backgroundColor = '#e9ecef';
        document.getElementById('tab-ordinary').style.color = '#333';
        document.getElementById('tab-agent').style.backgroundColor = '#e9ecef';
        document.getElementById('tab-agent').style.color = '#333';
        
        // éšè—æ‰€æœ‰å†…å®¹
        document.getElementById('nonmember-users-content').style.display = 'none';
        document.getElementById('ordinary-users-content').style.display = 'none';
        document.getElementById('agent-users-content').style.display = 'none';
        
        // æ˜¾ç¤ºå¯¹åº”å†…å®¹å¹¶é«˜äº®tab
        if (tab === 'nonmember') {
          document.getElementById('tab-nonmember').style.backgroundColor = '#007bff';
          document.getElementById('tab-nonmember').style.color = 'white';
          document.getElementById('nonmember-users-content').style.display = 'block';
          updateNonmemberActions();
        } else if (tab === 'ordinary') {
          document.getElementById('tab-ordinary').style.backgroundColor = '#007bff';
          document.getElementById('tab-ordinary').style.color = 'white';
          document.getElementById('ordinary-users-content').style.display = 'block';
          updateOrdinaryActions();
        } else if (tab === 'agent') {
          document.getElementById('tab-agent').style.backgroundColor = '#007bff';
          document.getElementById('tab-agent').style.color = 'white';
          document.getElementById('agent-users-content').style.display = 'block';
          updateAgentContent();
        }
      }
      
      // æ›´æ–°éä¼šå‘˜ç”¨æˆ·æ“ä½œæŒ‰é’®
      function updateNonmemberActions() {
        const actionsContainer = document.getElementById('nonmember-actions');
        if (currentUserRole === 'ordinary') {
          // æ™®é€šç”¨æˆ·ï¼šæ˜¾ç¤º"å‡çº§æ™®é€šä¼šå‘˜"
          const upgradeBtn = document.getElementById('upgradeNonmemberBtn');
          if (upgradeBtn) {
            upgradeBtn.textContent = 'å‡çº§æ™®é€šä¼šå‘˜';
            upgradeBtn.onclick = () => document.getElementById('upgradeToOrdinaryModal').style.display = 'flex';
          }
        } else if (currentUserRole === 'agent') {
          // ä»£ç†ç”¨æˆ·ï¼šæ˜¾ç¤º"å‡çº§æ™®é€šä¼šå‘˜"
          const upgradeBtn = document.getElementById('upgradeNonmemberBtn');
          if (upgradeBtn) {
            upgradeBtn.textContent = 'å‡çº§æ™®é€šä¼šå‘˜';
            upgradeBtn.onclick = () => document.getElementById('upgradeToOrdinaryModal').style.display = 'flex';
          }
        }
      }
      
      // æ›´æ–°æ™®é€šç”¨æˆ·æ“ä½œæŒ‰é’®å¹¶åŠ è½½æ™®é€šç”¨æˆ·åˆ—è¡¨
      async function updateOrdinaryActions() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        // åŠ è½½æ™®é€šç”¨æˆ·åˆ—è¡¨
        await loadOrdinaryMembers();
      }
      
      // åŠ è½½æ™®é€šç”¨æˆ·åˆ—è¡¨
      async function loadOrdinaryMembers() {
        try {
          const response = await userApiService.getSubordinates();
          if (response.success && response.data) {
            const ordinaryList = document.getElementById('ordinary-users-list');
            if (ordinaryList) {
              ordinaryList.innerHTML = '';
              
              const members = response.data.ordinaryMembers || [];
              if (members.length === 0) {
                ordinaryList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— æ™®é€šç”¨æˆ·</div>';
              } else {
                members.forEach(member => {
                  const card = createUserCard(member, 'ordinary');
                  ordinaryList.appendChild(card);
                });
              }
            }
          } else {
            const ordinaryList = document.getElementById('ordinary-users-list');
            if (ordinaryList) {
              ordinaryList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
            }
          }
        } catch (error) {
          console.error('åŠ è½½æ™®é€šç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
          const ordinaryList = document.getElementById('ordinary-users-list');
          if (ordinaryList) {
            ordinaryList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        }
      }
      
      // åˆ›å»ºç”¨æˆ·å¡ç‰‡ï¼ˆæ™®é€šç”¨æˆ·æˆ–ä»£ç†ç”¨æˆ·ï¼‰
      function createUserCard(user, type) {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div class="order-header">
            <div class="order-name">${sanitizeInput(user.name)}</div>
            <div class="order-status ${type === 'agent' ? 'approved' : 'pending'}">${type === 'agent' ? 'ä»£ç†' : 'æ™®é€šä¼šå‘˜'}</div>
          </div>
          <div class="order-details">
            <div class="order-detail">
              <div class="order-detail-label">æ¨å¹¿ç </div>
              <div class="order-detail-value">${user.id || '--'}</div>
            </div>
            <div class="order-detail">
              <div class="order-detail-label">æ‰‹æœºå·</div>
              <div class="order-detail-value">${user.phoneDisplay || user.phone || '--'}</div>
            </div>
            <div class="order-detail">
              <div class="order-detail-label">æ³¨å†Œæ—¶é—´</div>
              <div class="order-detail-value">${user.registerDate || '--'}</div>
            </div>
            <div class="order-detail">
              <div class="order-detail-label">é‡‘å¸ä½™é¢</div>
              <div class="order-detail-value">${(user.points || 0).toFixed(2)}</div>
            </div>
            <div class="order-detail">
              <div class="order-detail-label">éä¼šå‘˜æ•°</div>
              <div class="order-detail-value">${user.nonmemberCount || 0}</div>
            </div>
          </div>
          <div class="order-actions">
            <button class="order-action-btn" onclick="openTransferModal('${user.phone || ''}', '${user.name || ''}')">è½¬è´¦</button>
          </div>
        `;
        return card;
      }
      
      // æ›´æ–°ä»£ç†ç”¨æˆ·å†…å®¹å¹¶åŠ è½½ä»£ç†ç”¨æˆ·åˆ—è¡¨
      async function updateAgentContent() {
        const agentContent = document.getElementById('agent-content-display');
        if (currentUserRole === 'ordinary') {
          // æ™®é€šç”¨æˆ·ï¼šæ˜¾ç¤ºç”³è¯·æˆä¸ºä»£ç†çš„æç¤º
          agentContent.innerHTML = `
            <div class="card" style="text-align: center; padding: 40px 20px;">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">æ‚¨è¿˜ä¸æ˜¯ä»£ç†ç”¨æˆ·</div>
              <p style="color: #6c757d; margin-bottom: 20px;">è¯·è”ç³»æ‚¨çš„ä¸Šçº§ä»£ç†ç”³è¯·æˆä¸ºä»£ç†ç”¨æˆ·</p>
              <button class="nav-btn" onclick="openApplyAgentModal()">è”ç³»ç”³è¯·æˆä¸ºä»£ç†</button>
            </div>
          `;
        } else if (currentUserRole === 'agent') {
          // ä»£ç†ç”¨æˆ·ï¼šæ˜¾ç¤ºæ——ä¸‹å…¶ä»–ä»£ç†ç”¨æˆ·
          agentContent.innerHTML = `
            <div class="action-buttons">
              <button class="action-btn btn-primary" onclick="document.getElementById('addAgentUserModal').style.display = 'flex'">æ–°å¢ä»£ç†ç”¨æˆ·</button>
            </div>
            <!-- ä»£ç†ç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ï¼Œåˆå§‹ä¸ºç©º -->
            <div id="agent-users-list"></div>
          `;
          // åŠ è½½ä»£ç†ç”¨æˆ·åˆ—è¡¨
          await loadAgentMembers();
        }
      }
      
      // åŠ è½½ä»£ç†ç”¨æˆ·åˆ—è¡¨
      async function loadAgentMembers() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        try {
          const response = await userApiService.getSubordinates();
          if (response.success && response.data) {
            const agentList = document.getElementById('agent-users-list');
            if (agentList) {
              agentList.innerHTML = '';
              
              const members = response.data.agentMembers || [];
              if (members.length === 0) {
                agentList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— ä»£ç†ç”¨æˆ·</div>';
              } else {
                members.forEach(member => {
                  const card = createUserCard(member, 'agent');
                  agentList.appendChild(card);
                });
              }
            }
          } else {
            const agentList = document.getElementById('agent-users-list');
            if (agentList) {
              agentList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
            }
          }
        } catch (error) {
          console.error('åŠ è½½ä»£ç†ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
          const agentList = document.getElementById('agent-users-list');
          if (agentList) {
            agentList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        }
      }

      function getBasePointPrice(dateString) {
        const date = dateString ? new Date(dateString) : new Date();
        const isFriday = date.getDay() === 5;
        
        // å…¼å®¹ä¸¤ç§æ•°æ®ç»“æ„
        const basePointPrice = backendSettings.basePointPrice || {};
        if (isFriday) {
          return basePointPrice.friday || basePointPrice.fridayPrice || 1.5;
        } else {
          return basePointPrice.default || basePointPrice.basePrice || 1.0;
        }
      }

      function getDiscountByOrderCount(orderCount) {
        // æ‰¾åˆ°é€‚ç”¨çš„ä¼˜æƒ è§„åˆ™ï¼ˆè®¢å•æ•°æœ€å¤§çš„é€‚ç”¨è§„åˆ™ï¼‰
        const applicableRules = backendSettings.discountRules.filter(r => orderCount >= r.minOrders);
        if (applicableRules.length === 0) return 0;
        // è¿”å›è®¢å•æ•°æœ€å¤§çš„è§„åˆ™çš„æŠ˜æ‰£
        const maxRule = applicableRules.reduce((max, rule) => rule.minOrders > max.minOrders ? rule : max);
        return maxRule.discount; // æŠ˜æ‰£å€¼ï¼ˆä¾‹å¦‚0.4è¡¨ç¤º40%æŠ˜æ‰£ï¼Œå³æ‰“6æŠ˜ï¼‰
      }

      function recalculateOrderPricing() {
        const settlementDateInput = document.getElementById('settlementDate');
        if (!settlementDateInput) return;

        const dateValue = settlementDateInput.value || new Date().toISOString().split('T')[0];
        let basePrice = getBasePointPrice(dateValue);
        
        // ç¡®ä¿basePriceæ˜¯æœ‰æ•ˆæ•°å­—
        if (!basePrice || isNaN(basePrice)) {
          console.error('basePriceæ— æ•ˆ:', basePrice, 'backendSettings:', backendSettings);
          basePrice = 1.0; // ä½¿ç”¨é»˜è®¤å€¼
        }
        
        const totalOrders = (existingTodayOrderCount || 0) + (pendingOrderCount || 0);
        const discountRate = getDiscountByOrderCount(totalOrders); // æŠ˜æ‰£ç‡ï¼ˆä¾‹å¦‚0.4è¡¨ç¤º40%æŠ˜æ‰£ï¼‰
        
        // è®¡ç®—ä¼˜æƒ åçš„å•ä»·ï¼šå•ä»· * æŠ˜æ‰£ç‡
        // ä¾‹å¦‚ï¼šå•ä»·1ï¼ŒæŠ˜æ‰£0.9ï¼ˆ90%ï¼‰ï¼Œä¼˜æƒ åå•ä»· = 1 * 0.9 = 0.9
        const effectivePrice = basePrice * discountRate;
        
        // æ‰£é™¤é‡‘å¸ = æ•°é‡ * å•ä»· * æŠ˜æ‰£ç‡
        // ä½¿ç”¨Math.roundç¡®ä¿ç²¾åº¦ï¼Œé¿å…æµ®ç‚¹æ•°é—®é¢˜
        const totalDeductionPoints = Math.round((basePrice * discountRate * (pendingOrderCount || 0)) * 100) / 100;
        const currentPointsBalance = parseFloat(document.getElementById('currentPointsValue')?.textContent) || cachedCurrentPoints || 0;
        // ä½¿ç”¨Math.roundç¡®ä¿ç²¾åº¦
        const remainingPointsBalance = Math.round((currentPointsBalance - totalDeductionPoints) * 100) / 100;

        // æ›´æ–°æ˜¾ç¤ºï¼ˆä½¿ç”¨textContentè€Œä¸æ˜¯valueï¼Œå› ä¸ºç°åœ¨æ˜¯spanå…ƒç´ ï¼‰
        const initialPointPriceEl = document.getElementById('initialPointPrice');
        const discountPointPriceEl = document.getElementById('discountPointPrice');
        const totalDeductionPointsEl = document.getElementById('totalDeductionPoints');
        const currentPointsBalanceEl = document.getElementById('currentPointsBalance');
        const remainingPointsBalanceEl = document.getElementById('remainingPointsBalance');
        
        if (initialPointPriceEl) initialPointPriceEl.textContent = basePrice.toFixed(2);
        if (discountPointPriceEl) discountPointPriceEl.textContent = (discountRate * 100).toFixed(0) + '%'; // æ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”
        if (totalDeductionPointsEl) totalDeductionPointsEl.textContent = totalDeductionPoints.toFixed(2);
        if (currentPointsBalanceEl) currentPointsBalanceEl.textContent = currentPointsBalance.toFixed(2);
        if (remainingPointsBalanceEl) remainingPointsBalanceEl.textContent = remainingPointsBalance.toFixed(2);
      }

      function populateRewardInfo() {
        // å®‰å…¨åœ°æ›´æ–°å…ƒç´ ï¼Œå¦‚æœå…ƒç´ ä¸å­˜åœ¨åˆ™è·³è¿‡
        const directRewardRateLabel = document.getElementById('directRewardRateLabel');
        const indirectRewardRateLabel = document.getElementById('indirectRewardRateLabel');
        const directRewardToday = document.getElementById('directRewardToday');
        const indirectRewardToday = document.getElementById('indirectRewardToday');
        const totalRewardValue = document.getElementById('totalRewardValue');
        const rewardBody = document.getElementById('rewardDetailTable');
        
        if (directRewardRateLabel) {
          directRewardRateLabel.textContent = (backendSettings.rewardRates.direct * 100).toFixed(0) + '%';
        }
        if (indirectRewardRateLabel) {
          indirectRewardRateLabel.textContent = (backendSettings.rewardRates.indirect * 100).toFixed(0) + '%';
        }
        if (directRewardToday) {
          directRewardToday.textContent = 'Â¥' + rewardSummary.directToday.toFixed(2);
        }
        if (indirectRewardToday) {
          indirectRewardToday.textContent = 'Â¥' + rewardSummary.indirectToday.toFixed(2);
        }
        if (totalRewardValue) {
          totalRewardValue.textContent = 'Â¥' + (rewardSummary.directTotal + rewardSummary.indirectTotal).toFixed(2);
        }

        if (!rewardBody) {
          return; // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        }
        
        if (!rewardSummary.details.length) {
          rewardBody.innerHTML = '<tr><td style="padding: 8px; border: 1px solid #eee;" colspan="4">æš‚æ— å¥–åŠ±è®°å½•</td></tr>';
          return;
        }

        rewardBody.innerHTML = rewardSummary.details.map(detail => `
          <tr>
            <td style="padding: 8px; border: 1px solid #eee;">${detail.time}</td>
            <td style="padding: 8px; border: 1px solid #eee;">${detail.user}</td>
            <td style="padding: 8px; border: 1px solid #eee;">${detail.type}</td>
            <td style="padding: 8px; border: 1px solid #eee; text-align: right; color: ${detail.type === 'ç›´æ¨' ? '#28a745' : '#17a2b8'};">+${detail.amount.toFixed(2)}</td>
          </tr>
        `).join('');
      }
      
      
      // æ·»åŠ é€‰ä¸­çš„ç”¨æˆ·åˆ°è®¢å•ï¼ˆæ”¯æŒå¤šä¸ªåˆ—è¡¨ï¼‰
      function addSelectedDirectUsers() {
        try {
          const selectedUsers = [];
          
          // è·å–æ‰€æœ‰åˆ—è¡¨ä¸­çš„æ‰€æœ‰å¤é€‰æ¡†ï¼ˆåŒ…æ‹¬éä¼šå‘˜ã€æ™®é€šä¼šå‘˜ã€ä»£ç†ä¼šå‘˜ï¼‰
          const allLists = document.querySelectorAll('.order-user-list');
          
          if (allLists.length === 0) {
            alert('æœªæ‰¾åˆ°ç”¨æˆ·åˆ—è¡¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }
          
          allLists.forEach(list => {
            // æ£€æŸ¥åˆ—è¡¨æ˜¯å¦å¯è§
            const computedStyle = window.getComputedStyle(list);
            const isVisible = computedStyle.display !== 'none' && 
                             list.offsetParent !== null;
            
            if (isVisible) {
              const userCheckboxes = list.querySelectorAll('input[type="checkbox"]');
              
              userCheckboxes.forEach(checkbox => {
                if (checkbox && checkbox.checked && checkbox.id !== 'selectAllDirect') {
                  // ä½¿ç”¨å¤šç§æ–¹æ³•è·å–labelï¼Œç¡®ä¿å…¼å®¹æ€§
                  let label = null;
                  
                  // æ–¹æ³•1: ä½¿ç”¨nextElementSibling
                  if (checkbox.nextElementSibling && checkbox.nextElementSibling.tagName === 'LABEL') {
                    label = checkbox.nextElementSibling;
                  }
                  // æ–¹æ³•2: ä½¿ç”¨çˆ¶å…ƒç´ æŸ¥æ‰¾label
                  else if (checkbox.parentElement) {
                    label = checkbox.parentElement.querySelector('label[for="' + checkbox.id + '"]');
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°forå±æ€§çš„labelï¼Œå°è¯•æ‰¾ä¸‹ä¸€ä¸ªlabelå…ƒç´ 
                    if (!label) {
                      const nextLabel = checkbox.parentElement.querySelector('label');
                      if (nextLabel) label = nextLabel;
                    }
                  }
                  
                  if (label && label.textContent) {
                    const nonMemberId = checkbox.getAttribute('data-nonmember-id');
                    const memberId = checkbox.getAttribute('data-member-id');
                    const memberType = checkbox.getAttribute('data-member-type');
                    
                    // ä»checkbox idä¸­æå–IDï¼ˆæ ¼å¼ï¼šnonmember-1ï¼‰
                    let extractedId = null;
                    if (checkbox.id && checkbox.id.startsWith('nonmember-')) {
                      extractedId = parseInt(checkbox.id.replace('nonmember-', ''));
                    }
                    // ä¼˜å…ˆä½¿ç”¨dataå±æ€§ï¼Œå…¶æ¬¡ä½¿ç”¨idæå–
                    const finalNonMemberId = nonMemberId ? parseInt(nonMemberId) : (extractedId || null);
                    // è·å–é“¾æ¥
                    const link = checkbox.getAttribute('data-nonmember-link') || '';
                    
                    selectedUsers.push({
                      id: checkbox.id,
                      name: label.textContent.trim(),
                      nonMemberId: finalNonMemberId,
                      memberId: memberId,
                      memberType: memberType, // 'ordinary' or 'agent'
                      link: link
                    });
                  }
                }
              });
            }
          });
          
          if (selectedUsers.length > 0) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåç”¨æˆ·
            const existingCards = document.querySelectorAll('#direct-content .order-name');
            const existingNames = Array.from(existingCards).map(card => card.textContent.trim());
            
            const uniqueUsers = selectedUsers.filter(user => !existingNames.includes(user.name));
            const duplicateUsers = selectedUsers.filter(user => existingNames.includes(user.name));
            
            if (duplicateUsers.length > 0) {
              const duplicateNames = duplicateUsers.map(user => user.name).join(', ');
              alert(`ä»¥ä¸‹ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ : ${duplicateNames}`);
            }
            
            if (uniqueUsers.length > 0) {
              // åˆ›å»ºç”¨æˆ·å¡ç‰‡å¹¶è‡ªåŠ¨å‹¾é€‰
              uniqueUsers.forEach(user => {
                if (typeof createOrderCard === 'function') {
                  // ä»APIå“åº”ä¸­è·å–é“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
                  const link = user.link || '';
                  const cardElement = createOrderCard(user.name, link, user.nonMemberId);
                  
                  // è‡ªåŠ¨å‹¾é€‰æ–°æ·»åŠ çš„å¡ç‰‡
                  if (cardElement) {
                    const checkbox = cardElement.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                      checkbox.checked = true;
                    }
                  }
                } else {
                  console.error('createOrderCardå‡½æ•°ä¸å­˜åœ¨');
                }
              });
              
              // æ›´æ–°æŠ¥å•æ•°é‡
              if (typeof updateSettleCount === 'function') {
                updateSettleCount();
              }
              
              // å…³é—­æ¨¡æ€æ¡†
              document.getElementById('selectDirectUserModal').style.display = 'none';
              
              showToast(`å·²æ·»åŠ  ${uniqueUsers.length} ä¸ªæ–°ç”¨æˆ·åˆ°è®¢å•åˆ—è¡¨ï¼Œå·²è‡ªåŠ¨å‹¾é€‰`);
            }
          } else {
            alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç”¨æˆ·');
            return;
          }
          
          const modal = document.getElementById('selectDirectUserModal');
          if (modal) {
            modal.style.display = 'none';
          }
          
          if (typeof updateSettleCount === 'function') {
            updateSettleCount();
          }
        } catch (error) {
          console.error('æ·»åŠ ç”¨æˆ·æ—¶å‡ºé”™:', error);
          alert('æ·»åŠ ç”¨æˆ·æ—¶å‡ºé”™: ' + error.message);
        }
      }
      
      // æœç´¢ç”¨æˆ·ï¼ˆæ”¯æŒå¤šä¸ªåˆ—è¡¨ï¼‰
      function searchDirectUsers() {
        const searchTerm = document.getElementById('searchDirectUser').value.toLowerCase();
        const allLists = document.querySelectorAll('.order-user-list');
        
        allLists.forEach(list => {
          const userItems = list.children;
          for (let i = 0; i < userItems.length; i++) {
            const item = userItems[i];
            const label = item.querySelector('label');
            if (label) {
              const userName = label.textContent.toLowerCase();
              if (searchTerm === '' || userName.includes(searchTerm)) {
                item.style.display = 'flex';
              } else {
                item.style.display = 'none';
              }
            }
          }
        });
      }
      
      // å…¨é€‰åŠŸèƒ½ï¼ˆæ”¯æŒå½“å‰æ˜¾ç¤ºçš„åˆ—è¡¨ï¼‰
      function toggleSelectAllDirect() {
        const selectAllCheckbox = document.getElementById('selectAllDirect');
        const allLists = document.querySelectorAll('.order-user-list');
        
        allLists.forEach(list => {
          // æ£€æŸ¥åˆ—è¡¨æ˜¯å¦å¯è§
          const isVisible = list.offsetParent !== null || 
                           window.getComputedStyle(list).display !== 'none' ||
                           !list.style.display || 
                           list.style.display !== 'none';
          
          if (isVisible) {
            const checkboxes = list.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
              if (checkbox.id !== 'selectAllDirect') {
                checkbox.checked = selectAllCheckbox.checked;
              }
            });
          }
        });
      }
      
      // ä¿å­˜å¹¶é€‰æ‹©ç›´æ¨ç”¨æˆ·ï¼ˆæŠ¥å•é¡µé¢æ–°å¢ç”¨æˆ·ï¼‰
      async function saveAndSelectDirectUser() {
        if (!userApiService.isAuthenticated()) {
          alert('è¯·å…ˆç™»å½•');
          showPage('login-page');
          return;
        }
        
        try {
          const nameInput = document.getElementById('directUserName');
          if (!nameInput) {
            alert('æ‰¾ä¸åˆ°å§“åè¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }
          
          const name = nameInput.value.trim();
          const linkInput = document.getElementById('directUserLink');
          const link = linkInput ? linkInput.value.trim() : '';
          
          if (!name) {
            alert('è¯·è¾“å…¥å§“å');
            nameInput.focus();
            return;
          }
          
          // æ£€æŸ¥æŠ¥å•åˆ—è¡¨ä¸­æ˜¯å¦å·²å­˜åœ¨åŒåç”¨æˆ·
          const existingCards = document.querySelectorAll('#direct-content .order-name');
          const existingNames = Array.from(existingCards).map(card => card.textContent.trim());
          
          if (existingNames.includes(name)) {
            alert('è¯¥ç”¨æˆ·å·²åœ¨æŠ¥å•åˆ—è¡¨ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ ');
            const addModal = document.getElementById('addDirectUserModal');
            if (addModal) addModal.style.display = 'none';
            return;
          }
          
          // è°ƒç”¨APIæ·»åŠ éä¼šå‘˜
          const response = await userApiService.addNonMember(name, link);
          
          if (response.success) {
            const nonMember = response.data;
            
            // åˆ·æ–°é€‰æ‹©ç”¨æˆ·æ¨¡æ€æ¡†ä¸­çš„éä¼šå‘˜åˆ—è¡¨ï¼Œè®©æ–°æ·»åŠ çš„ç”¨æˆ·å‡ºç°åœ¨åˆ—è¡¨ä¸­
            await loadOrderNonMembers();
            
            // åˆ›å»ºè®¢å•å¡ç‰‡å¹¶æ·»åŠ åˆ°æŠ¥å•åˆ—è¡¨
            if (typeof createOrderCard === 'function') {
              createOrderCard(name, link, nonMember.id);
            } else {
              console.error('createOrderCardå‡½æ•°ä¸å­˜åœ¨');
              alert('åˆ›å»ºè®¢å•å¡ç‰‡å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
              return;
            }
            
            // å…³é—­æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡†ï¼Œè¿”å›é€‰æ‹©ç”¨æˆ·æ¨¡æ€æ¡†
            const addModal = document.getElementById('addDirectUserModal');
            const selectModal = document.getElementById('selectDirectUserModal');
            
            if (addModal) addModal.style.display = 'none';
            if (selectModal) selectModal.style.display = 'flex';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            nameInput.value = '';
            if (linkInput) linkInput.value = '';
            
            // æ›´æ–°æŠ¥å•æ•°é‡
            if (typeof updateSettleCount === 'function') {
              updateSettleCount();
            }
            
            // è‡ªåŠ¨å‹¾é€‰æ–°æ·»åŠ çš„ç”¨æˆ·
            const newCheckbox = document.getElementById(`nonmember-${nonMember.id}`);
            if (newCheckbox) {
              newCheckbox.checked = true;
            }
            
            alert(`ç”¨æˆ· ${name} å·²æ·»åŠ åˆ°æŠ¥å•åˆ—è¡¨`);
          } else {
            alert(response.message || 'æ·»åŠ å¤±è´¥');
          }
        } catch (error) {
          console.error('ä¿å­˜ç”¨æˆ·æ—¶å‡ºé”™:', error);
          alert('ä¿å­˜ç”¨æˆ·æ—¶å‡ºé”™: ' + error.message);
        }
      }
      
      // åˆ‡æ¢æŠ¥å•é¡µé¢çš„ç”¨æˆ·æ ‡ç­¾é¡µ
      async function switchOrderUserTab(tab) {
        // é‡ç½®æ‰€æœ‰æ ‡ç­¾é¡µæ ·å¼
        document.querySelectorAll('.order-user-tab').forEach(t => {
          t.style.borderBottom = 'none';
          t.style.color = '#666';
          t.style.fontWeight = 'normal';
        });
        
        // éšè—æ‰€æœ‰åˆ—è¡¨
        document.querySelectorAll('.order-user-list').forEach(list => {
          list.style.display = 'none';
        });
        
        // æ˜¾ç¤ºå¯¹åº”æ ‡ç­¾é¡µå’Œåˆ—è¡¨
        if (tab === 'nonmember') {
          document.getElementById('order-tab-nonmember').style.borderBottom = '2px solid #007bff';
          document.getElementById('order-tab-nonmember').style.color = '#007bff';
          document.getElementById('order-tab-nonmember').style.fontWeight = '500';
          document.getElementById('order-nonmember-list').style.display = 'block';
        } else if (tab === 'ordinary') {
          document.getElementById('order-tab-ordinary').style.borderBottom = '2px solid #007bff';
          document.getElementById('order-tab-ordinary').style.color = '#007bff';
          document.getElementById('order-tab-ordinary').style.fontWeight = '500';
          document.getElementById('order-ordinary-list').style.display = 'block';
          // åŠ è½½æ™®é€šä¼šå‘˜åˆ—è¡¨
          await loadOrderOrdinaryMembers();
        } else if (tab === 'agent') {
          document.getElementById('order-tab-agent').style.borderBottom = '2px solid #007bff';
          document.getElementById('order-tab-agent').style.color = '#007bff';
          document.getElementById('order-tab-agent').style.fontWeight = '500';
          document.getElementById('order-agent-list').style.display = 'block';
          // åŠ è½½ä»£ç†ä¼šå‘˜åˆ—è¡¨
          await loadOrderAgentMembers();
        }
      }
      
      // æ‰“å¼€é€‰æ‹©ç”¨æˆ·æ¨¡æ€æ¡†
      async function openSelectDirectUserModal() {
        if (!userApiService.isAuthenticated()) {
          alert('è¯·å…ˆç™»å½•');
          showPage('login-page');
          return;
        }
        
        try {
          const tabsContainer = document.getElementById('order-user-tabs');
          if (!tabsContainer) {
            console.error('æ‰¾ä¸åˆ°order-user-tabså…ƒç´ ');
            return;
          }
          
          // æ¯æ¬¡æ‰“å¼€æ—¶éƒ½é‡æ–°åŠ è½½éä¼šå‘˜åˆ—è¡¨ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
          await loadOrderNonMembers();
          
          if (currentUserRole === 'agent') {
            // ä»£ç†ä¼šå‘˜ï¼šæ˜¾ç¤ºæ ‡ç­¾é¡µ
            tabsContainer.style.display = 'block';
            // é»˜è®¤æ˜¾ç¤ºéä¼šå‘˜åˆ—è¡¨
            switchOrderUserTab('nonmember');
          } else {
            // æ™®é€šä¼šå‘˜ï¼šéšè—æ ‡ç­¾é¡µï¼Œåªæ˜¾ç¤ºéä¼šå‘˜åˆ—è¡¨
            tabsContainer.style.display = 'none';
            const nonmemberList = document.getElementById('order-nonmember-list');
            const ordinaryList = document.getElementById('order-ordinary-list');
            const agentList = document.getElementById('order-agent-list');
            
            if (nonmemberList) nonmemberList.style.display = 'block';
            if (ordinaryList) ordinaryList.style.display = 'none';
            if (agentList) agentList.style.display = 'none';
          }
          
          const modal = document.getElementById('selectDirectUserModal');
          if (modal) {
            modal.style.display = 'flex';
          } else {
            console.error('æ‰¾ä¸åˆ°selectDirectUserModalå…ƒç´ ');
          }
        } catch (error) {
          console.error('æ‰“å¼€é€‰æ‹©ç”¨æˆ·æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
          alert('æ‰“å¼€é€‰æ‹©ç”¨æˆ·çª—å£æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
      }
      
      // åŠ è½½æŠ¥å•é¡µé¢çš„éä¼šå‘˜åˆ—è¡¨
      async function loadOrderNonMembers() {
        try {
          // æ¯æ¬¡åŠ è½½å‰å…ˆæ¸…ç©ºåˆ—è¡¨ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
          const nonmemberList = document.getElementById('order-nonmember-list');
          if (nonmemberList) {
            nonmemberList.innerHTML = '';
          }
          
          const response = await userApiService.getNonMembers();
          if (response.success && response.data && response.data.list) {
            if (nonmemberList) {
              // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
              if (response.data.list.length === 0) {
                nonmemberList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— éä¼šå‘˜ç”¨æˆ·ï¼Œè¯·åœ¨ç”¨æˆ·ç®¡ç†ä¸­æ·»åŠ </div>';
              } else {
                response.data.list.forEach(nm => {
                  const item = document.createElement('div');
                  item.className = 'order-user-item';
                  // ä¿å­˜å®Œæ•´æ•°æ®åˆ°dataå±æ€§ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
                  item.setAttribute('data-nonmember-data', JSON.stringify(nm));
                  item.innerHTML = `
                    <input type="checkbox" id="nonmember-${nm.id}" data-nonmember-id="${nm.id}" data-nonmember-link="${nm.link || ''}" />
                    <label for="nonmember-${nm.id}">${sanitizeInput(nm.name)}</label>
                  `;
                  nonmemberList.appendChild(item);
                });
              }
            }
          } else {
            if (nonmemberList) {
              nonmemberList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
          }
        } catch (error) {
          console.error('åŠ è½½éä¼šå‘˜åˆ—è¡¨é”™è¯¯:', error);
          const nonmemberList = document.getElementById('order-nonmember-list');
          if (nonmemberList) {
            nonmemberList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        }
      }
      
      // åŠ è½½æŠ¥å•é¡µé¢çš„æ™®é€šä¼šå‘˜åˆ—è¡¨
      async function loadOrderOrdinaryMembers() {
        try {
          const ordinaryList = document.getElementById('order-ordinary-list');
          if (!ordinaryList) return;
          
          // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œä¸å†é‡å¤åŠ è½½
          if (ordinaryList.querySelector('.order-user-item')) {
            return;
          }
          
          ordinaryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½ä¸­...</div>';
          
          const response = await userApiService.getSubordinates();
          console.log('æ™®é€šä¼šå‘˜APIå“åº”:', response);
          if (response.success && response.data) {
            const ordinaryMembers = response.data.ordinaryMembers || [];
            
            if (ordinaryMembers.length === 0) {
              ordinaryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— æ™®é€šä¼šå‘˜</div>';
            } else {
              ordinaryList.innerHTML = '';
              ordinaryMembers.forEach(member => {
                const item = document.createElement('div');
                item.className = 'order-user-item';
                item.innerHTML = `
                  <input type="checkbox" id="ordinary-${member.id}" data-member-id="${member.id}" data-member-type="ordinary" />
                  <label for="ordinary-${member.id}">${sanitizeInput(member.name)}</label>
                `;
                ordinaryList.appendChild(item);
              });
            }
          } else {
            ordinaryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        } catch (error) {
          console.error('åŠ è½½æ™®é€šä¼šå‘˜åˆ—è¡¨é”™è¯¯:', error);
          const ordinaryList = document.getElementById('order-ordinary-list');
          if (ordinaryList) {
            ordinaryList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        }
      }
      
      // åŠ è½½æŠ¥å•é¡µé¢çš„ä»£ç†ä¼šå‘˜åˆ—è¡¨
      async function loadOrderAgentMembers() {
        try {
          const agentList = document.getElementById('order-agent-list');
          if (!agentList) return;
          
          // æ¯æ¬¡åˆ‡æ¢æ ‡ç­¾æ—¶éƒ½é‡æ–°åŠ è½½ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
          // ç§»é™¤ç¼“å­˜æ£€æŸ¥ï¼Œæ¯æ¬¡éƒ½é‡æ–°åŠ è½½
          
          agentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">åŠ è½½ä¸­...</div>';
          
          const response = await userApiService.getSubordinates();
          console.log('ä»£ç†ä¼šå‘˜APIå“åº”:', response);
          if (response.success && response.data) {
            const agentMembers = response.data.agentMembers || [];
            console.log('ä»£ç†ä¼šå‘˜åˆ—è¡¨:', agentMembers);
            
            if (agentMembers.length === 0) {
              agentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— ä»£ç†ä¼šå‘˜</div>';
            } else {
              agentList.innerHTML = '';
              agentMembers.forEach(member => {
                const item = document.createElement('div');
                item.className = 'order-user-item';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.marginBottom = '10px';
                item.innerHTML = `
                  <input type="checkbox" id="agent-${member.id}" data-member-id="${member.id}" data-member-type="agent" style="margin-right: 8px;" />
                  <label for="agent-${member.id}" style="cursor: pointer;">${sanitizeInput(member.name)}</label>
                `;
                agentList.appendChild(item);
              });
            }
          } else {
            console.error('åŠ è½½ä»£ç†ä¼šå‘˜å¤±è´¥:', response);
            agentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
          }
        } catch (error) {
          console.error('åŠ è½½ä»£ç†ä¼šå‘˜åˆ—è¡¨é”™è¯¯:', error);
          const agentList = document.getElementById('order-agent-list');
          if (agentList) {
            agentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
          }
        }
      }
      
      // æ‰“å¼€æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡†ï¼ˆæŠ¥å•é¡µé¢ï¼‰
      function openAddDirectUserModal() {
        document.getElementById('selectDirectUserModal').style.display = 'none';
        document.getElementById('addDirectUserModal').style.display = 'flex';
        // è®¾ç½®æŒ‰é’®æ–‡æœ¬ä¸º"ä¿å­˜å¹¶é€‰æ‹©"
        const btn = document.getElementById('addDirectUserBtn');
        if (btn) {
          btn.textContent = 'ä¿å­˜å¹¶é€‰æ‹©';
          btn.onclick = saveAndSelectDirectUser;
        }
      }
      
      // ä¿å­˜éä¼šå‘˜ç”¨æˆ·ï¼ˆç”¨æˆ·ç®¡ç†é¡µé¢ï¼‰
      async function saveNonmemberUser() {
        if (!userApiService.isAuthenticated()) {
          alert('è¯·å…ˆç™»å½•');
          showPage('login-page');
          return;
        }
        
        const name = document.getElementById('nonmemberUserName').value.trim();
        const link = document.getElementById('nonmemberUserLink').value.trim();
        
        if (!name) {
          alert('è¯·è¾“å…¥å§“å');
          return;
        }
        
        try {
          const response = await userApiService.addNonMember(name, link);
          
          if (response.success) {
            alert('æ·»åŠ æˆåŠŸï¼');
            
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œç­‰å¾…ç”¨æˆ·å¡«å†™ä¸‹ä¸€ä¸ª
            document.getElementById('nonmemberUserName').value = '';
            document.getElementById('nonmemberUserLink').value = '';
            
            // èšç„¦åˆ°å§“åè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç»§ç»­æ·»åŠ 
            document.getElementById('nonmemberUserName').focus();
            
            // åˆ·æ–°éä¼šå‘˜åˆ—è¡¨
            loadNonMembers();
          } else {
            alert(response.message || 'æ·»åŠ å¤±è´¥');
          }
        } catch (error) {
          console.error('æ·»åŠ éä¼šå‘˜é”™è¯¯:', error);
          alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // åˆ›å»ºè®¢å•å¡ç‰‡
      function createOrderCard(userName, link = '', nonMemberId = null) {
        try {
          // åˆ›å»ºå¡ç‰‡å®¹å™¨
          const container = document.createElement('div');
          container.className = 'order-card';
          container.style.position = 'relative';
          container.style.padding = '15px';
          container.style.marginBottom = '15px';
          
          // ä¿å­˜nonMemberIdåˆ°dataå±æ€§
          if (nonMemberId) {
            container.setAttribute('data-nonmember-id', nonMemberId);
          }
          
          const displayLink = link || 'https://t.cn/R123456';
          
          container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="order-name">${sanitizeInput(userName)}</div>
                <div class="order-details" style="grid-template-columns: 1fr 1fr; margin: 10px 0;">
                  <div class="order-detail">
                    <div class="order-detail-label">ç¢°ç¢°é“¾æ¥</div>
                    <div class="order-detail-value">${sanitizeInput(displayLink)}</div>
                  </div>
                </div>
              </div>
              <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <input type="checkbox" style="transform: scale(1.3);" onchange="updateSettleCount()" />
              </div>
            </div>
          `;
          
          // æ·»åŠ åˆ°è®¢å•åˆ—è¡¨ä¸­
          const directContent = document.getElementById('direct-content');
          if (!directContent) {
            console.error('æ‰¾ä¸åˆ°direct-contentå…ƒç´ ');
            return;
          }
          
          // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªè®¢å•å¡ç‰‡ï¼ˆ.order-cardï¼‰
          const firstOrderCard = directContent.querySelector('.order-card');
          
          if (firstOrderCard) {
            // å¦‚æœå­˜åœ¨è®¢å•å¡ç‰‡ï¼Œæ’å…¥åˆ°ç¬¬ä¸€ä¸ªä¹‹å‰
            directContent.insertBefore(container, firstOrderCard);
          } else {
            // å¦‚æœæ²¡æœ‰è®¢å•å¡ç‰‡ï¼Œç›´æ¥æ·»åŠ åˆ°direct-contentçš„å¼€å¤´ï¼ˆåœ¨åº•éƒ¨æŒ‰é’®ä¹‹å‰ï¼‰
            const bottomButtons = directContent.querySelector('.bottom-action-buttons');
            if (bottomButtons) {
              directContent.insertBefore(container, bottomButtons);
          } else {
            // å¦‚æœè¿åº•éƒ¨æŒ‰é’®éƒ½æ‰¾ä¸åˆ°ï¼Œç›´æ¥è¿½åŠ 
              directContent.appendChild(container);
            }
          }
          
          pendingOrderCount++;
          updateSettleCount();
          
          // è¿”å›å®¹å™¨å…ƒç´ ï¼Œæ–¹ä¾¿åç»­æ“ä½œï¼ˆå¦‚è‡ªåŠ¨å‹¾é€‰ï¼‰
          return container;
        } catch (error) {
          console.error('åˆ›å»ºè®¢å•å¡ç‰‡æ—¶å‡ºé”™:', error);
          alert('åˆ›å»ºè®¢å•å¡ç‰‡æ—¶å‡ºé”™: ' + error.message);
        }
      }
      
      // æ›´æ–°æŠ¥å•æ•°é‡æ˜¾ç¤º
      function updateSettleCount() {
        const checkedCount = document.querySelectorAll('#direct-content input[type="checkbox"]:checked').length;
        document.getElementById('settleCount').textContent = checkedCount;
      }
      
      // å…¨é€‰è®¢å•
      function toggleSelectAllOrders() {
        const checkboxes = document.querySelectorAll('#direct-content input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = !allChecked;
        });
        
        updateSettleCount();
      }
      
      // ä¿å­˜ç›´æ¨ç”¨æˆ·åˆ°è®¢å•
      function saveDirectUserToOrder() {
        alert('ä¿å­˜ç›´æ¨ç”¨æˆ·åˆ°è®¢å•åŠŸèƒ½å·²è§¦å‘');
        document.getElementById('addDirectUserModal').style.display = 'none';
        // ä¿å­˜åç›´æ¥è¿›è¡Œå‹¾é€‰çš„é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
      }
      
      // å…¨é€‰åŠŸèƒ½
      function selectAllOrders() {
        const checkboxes = document.querySelectorAll('#ordersList input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = !allChecked;
        });
        
        updateSettleCount();
      }
      
      // æ¸…ç©ºè®¢å•åˆ—è¡¨
      function clearOrderList() {
        const directContent = document.getElementById('direct-content');
        if (directContent) {
          // æ¸…ç©ºæ‰€æœ‰è®¢å•å¡ç‰‡ï¼Œä½†ä¿ç•™åº•éƒ¨æŒ‰é’®
          const orderCards = directContent.querySelectorAll('.order-card');
          orderCards.forEach(card => card.remove());
        }
        pendingOrderCount = 0;
        updateSettleCount();
      }
      
      // åˆ é™¤é€‰ä¸­è®¢å•
      function deleteSelectedOrders() {
        const checkedOrders = document.querySelectorAll('#direct-content input[type="checkbox"]:checked');
        
        if (checkedOrders.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®¢å•');
          return;
        }
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedOrders.length} ä¸ªè®¢å•å—ï¼Ÿ`)) {
          checkedOrders.forEach(checkbox => {
            const orderCard = checkbox.closest('.order-card');
            if (orderCard) {
              orderCard.remove();
            }
          });
          updateSettleCount();
          alert(`å·²åˆ é™¤ ${checkedOrders.length} ä¸ªè®¢å•`);
        }
      }
      
      // æŠ¥å•
      function settleOrders() {
        console.log('settleOrderså‡½æ•°è¢«è°ƒç”¨');
        const checkedOrders = document.querySelectorAll('#direct-content input[type="checkbox"]:checked');
        const orderCount = checkedOrders.length;
        
        console.log('é€‰ä¸­çš„è®¢å•æ•°é‡:', orderCount);
        
        if (orderCount === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦æŠ¥å•çš„ç”¨æˆ·');
          return;
        }
        
        pendingOrderCount = orderCount;
        const settlementDateInput = document.getElementById('settlementDate');
        const today = new Date();
        // ä½¿ç”¨æœ¬åœ°æ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        if (settlementDateInput) {
          settlementDateInput.value = todayString;
          // è®¾ç½®æœ€å°æ—¥æœŸä¸ºä»Šå¤©ï¼Œä¸å…è®¸é€‰æ‹©ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ
          settlementDateInput.setAttribute('min', todayString);
          
          // ç›‘å¬æ—¥æœŸå˜åŒ–ï¼Œç¡®ä¿ä¸èƒ½é€‰æ‹©ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ
          settlementDateInput.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate < todayString) {
              alert('ä¸èƒ½é€‰æ‹©ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ');
              this.value = todayString;
              recalculateOrderPricing();
            } else {
              recalculateOrderPricing();
            }
          });
        }
        
        // åªæ˜¾ç¤ºé€‰æ‹©çš„æ•°é‡ï¼Œä¸æ˜¾ç¤º3+1æ ¼å¼
        document.getElementById('todayOrderCount').textContent = orderCount;
        
        // ä»APIè·å–æœ€æ–°çš„é‡‘å¸ä½™é¢
        (async () => {
          try {
            const balanceResponse = await userApiService.getPointsBalance();
            if (balanceResponse.success) {
              cachedCurrentPoints = parseFloat(balanceResponse.data.points) || 0;
              const currentPointsValueEl = document.getElementById('currentPointsValue');
              if (currentPointsValueEl) {
                currentPointsValueEl.textContent = cachedCurrentPoints.toFixed(2);
              }
            }
          } catch (error) {
            console.error('è·å–é‡‘å¸ä½™é¢å¤±è´¥:', error);
            // ä½¿ç”¨ç¼“å­˜çš„ä½™é¢
            const currentPointsBalance = parseFloat(document.getElementById('currentPointsValue')?.textContent) || cachedCurrentPoints || 0;
            cachedCurrentPoints = currentPointsBalance;
          }
          
          recalculateOrderPricing();
          document.getElementById('pointsConfirmationModal').style.display = 'flex';
        })();
      }
      
      // ç¡®è®¤é‡‘å¸æ‰£é™¤
      async function confirmPointsDeduction() {
        const settlementDateInput = document.getElementById('settlementDate');
        if (!settlementDateInput || !settlementDateInput.value) {
          alert('è¯·é€‰æ‹©æŠ¥å•æ—¥æœŸ');
          return;
        }
        
        // å†æ¬¡éªŒè¯æ—¥æœŸä¸èƒ½æ˜¯ä»Šå¤©ä¹‹å‰çš„
        const today = new Date();
        // ä½¿ç”¨æœ¬åœ°æ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const selectedDate = settlementDateInput.value;
        
        if (selectedDate < todayString) {
          alert('ä¸èƒ½é€‰æ‹©ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ');
          settlementDateInput.value = todayString;
          recalculateOrderPricing();
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (!userApiService.isAuthenticated()) {
          alert('è¯·å…ˆç™»å½•');
          showPage('login-page');
          return;
        }
        
        // è·å–é€‰ä¸­çš„è®¢å•ï¼ˆéä¼šå‘˜IDåˆ—è¡¨ï¼‰
        const selectedOrders = [];
        // ä»æŠ¥å•åˆ—è¡¨åŒºåŸŸæŸ¥æ‰¾è®¢å•å¡ç‰‡
        const orderCards = document.querySelectorAll('#direct-content .order-card');
        
        if (orderCards.length === 0) {
          alert('è¯·å…ˆæ·»åŠ ç”¨æˆ·åˆ°æŠ¥å•åˆ—è¡¨');
          return;
        }
        
        orderCards.forEach(card => {
          const checkbox = card.querySelector('input[type="checkbox"]');
          if (checkbox && checkbox.checked) {
            const nonMemberId = card.getAttribute('data-nonmember-id');
            if (nonMemberId) {
              selectedOrders.push(parseInt(nonMemberId));
            } else {
              console.warn('è®¢å•å¡ç‰‡ç¼ºå°‘nonMemberId:', card);
            }
          }
        });
        
        if (selectedOrders.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç”¨æˆ·ï¼ˆè¯·ç¡®ä¿ç”¨æˆ·å·²æ­£ç¡®æ·»åŠ åˆ°æŠ¥å•åˆ—è¡¨ï¼‰');
          return;
        }
        
        console.log('é€‰ä¸­çš„éä¼šå‘˜ID:', selectedOrders);
        
        const quantity = selectedOrders.length;
        
        // æ³¨æ„ï¼šåç«¯è®¡ç®—æŠ˜æ‰£æ—¶ä½¿ç”¨çš„æ˜¯ settlement_date å½“å¤©çš„è®¢å•æ•°ï¼Œä¸æ˜¯"ä»Šæ—¥"è®¢å•æ•°
        // å‰ç«¯æ— æ³•æå‰è·å–æœªæ¥æ—¥æœŸçš„è®¢å•æ•°ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨0ï¼Œè®©åç«¯è‡ªå·±è®¡ç®—
        // åç«¯ä¼šåœ¨ create_order æ—¶æŸ¥è¯¢ settlement_date å½“å¤©çš„è®¢å•æ•°
        let todayOrders = 0;
        console.log('å‰ç«¯ä½¿ç”¨è®¢å•æ•°:', todayOrders, '(åç«¯ä¼šæ ¹æ®æŠ¥å•æ—¥æœŸé‡æ–°è®¡ç®—)');
        
        // é‡æ–°è®¡ç®—ä»·æ ¼ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œå®é™…è®¡ç®—ç”±åç«¯å®Œæˆï¼‰
        const basePrice = getBasePointPrice(selectedDate);
        const totalOrderCount = todayOrders + quantity;
        const discountRate = getDiscountByOrderCount(totalOrderCount);
        // è®¡ç®—è§„åˆ™ï¼šæ•°é‡ * å•ä»· * æŠ˜æ‰£ç‡
        const calculatedTotalPoints = Math.round((quantity * basePrice * discountRate) * 100) / 100;
        // æŠ˜æ‰£åçš„å•ä»·ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        const effectivePrice = basePrice * discountRate;
        
        console.log('å‰ç«¯è®¡ç®—éªŒè¯ï¼ˆä»…ä¾›å‚è€ƒï¼Œå®é™…ä»¥åç«¯ä¸ºå‡†ï¼‰:', {
          basePrice,
          discountRate,
          quantity,
          effectivePrice,
          totalPoints: calculatedTotalPoints,
          todayOrders,
          totalOrderCount
        });
        
        // è°ƒç”¨åç«¯APIæäº¤è®¢å•ï¼ˆåç«¯ä¼šé‡æ–°è®¡ç®—æ­£ç¡®çš„æŠ˜æ‰£ï¼‰
        try {
          const response = await userApiService.submitOrder(
            selectedOrders,
            selectedDate,
            quantity
          );
          
          if (response.success) {
            // æ›´æ–°é‡‘å¸ä½™é¢
            cachedCurrentPoints = response.data.remainingPoints;
            
            // å…³é—­ç¡®è®¤æ¨¡æ€æ¡†
            document.getElementById('pointsConfirmationModal').style.display = 'none';
            
            // æ˜¾ç¤ºæŠ¥å•æˆåŠŸæ¨¡æ€æ¡†
            document.getElementById('orderSuccessModal').style.display = 'flex';
            
            // ä¸æ¸…ç©ºè®¢å•åˆ—è¡¨ï¼Œä¿ç•™æ•°æ®
            // clearOrderList();
            
            // ä¸åˆ·æ–°ä»»ä½•æ•°æ®ï¼Œé¿å…å¯èƒ½çš„401é”™è¯¯å¯¼è‡´è·³è½¬
            // é‡‘å¸ä½™é¢å·²ç»åœ¨response.data.remainingPointsä¸­æ›´æ–°äº†
            
            // æ›´æ–°ä»Šæ—¥è®¢å•æ•°é‡
            existingTodayOrderCount += quantity;
            pendingOrderCount = 0;
            
            // åˆ·æ–°é‡‘å¸ä¿¡æ¯
            await refreshPointsInfo();
          } else {
            alert(response.message || 'æŠ¥å•å¤±è´¥');
          }
        } catch (error) {
          console.error('æŠ¥å•é”™è¯¯:', error);
          alert('æŠ¥å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // ä¿å­˜ç”¨æˆ·
      function saveUser() {
        alert('ä¿å­˜ç”¨æˆ·åŠŸèƒ½å·²è§¦å‘');
        document.getElementById('addUserModal').style.display = 'none';
      }
      
      // ä¿å­˜ç›´æ¨ç”¨æˆ·
      function saveDirectUser() {
        alert('ä¿å­˜ç›´æ¨ç”¨æˆ·åŠŸèƒ½å·²è§¦å‘');
        document.getElementById('addDirectUserModal').style.display = 'none';
      }
      
      // ä¿å­˜ä»£ç†ç”¨æˆ·
      function saveAgentUser() {
        alert('ä¿å­˜ä»£ç†ç”¨æˆ·åŠŸèƒ½å·²è§¦å‘');
        document.getElementById('addAgentUserModal').style.display = 'none';
      }
      
      // ç¡®è®¤å‡çº§ä¸ºæ™®é€šç”¨æˆ·
      async function confirmUpgradeToOrdinary() {
        const phone = document.getElementById('upgradeToOrdinaryPhone').value;
        if (!phone) {
          alert('è¯·è¾“å…¥æ‰‹æœºå·');
          return;
        }
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!/^1[3-9]\d{9}$/.test(phone)) {
          alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
          return;
        }
        
        try {
          // ä¿å­˜å½“å‰ç”¨æˆ·çš„tokenå’ŒuserInfoï¼Œé¿å…è¢«è¦†ç›–
          const currentToken = userApiService.token;
          const currentUserInfo = userApiService.userInfo;
          
          // è·å–å½“å‰ç”¨æˆ·çš„æ¨å¹¿ç 
          const currentUserPromoCode = currentUserInfo?.promoCode || currentUserInfo?.promo_code;
          if (!currentUserPromoCode) {
            alert('è·å–æ¨å¹¿ç å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }
          
          // ç”Ÿæˆéšæœºå§“åï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰æä¾›ï¼‰
          const defaultName = `ç”¨æˆ·${phone.slice(-4)}`;
          
          // è°ƒç”¨æ³¨å†ŒAPIï¼Œç›´æ¥åœ¨åå°æ³¨å†Œ
          const registerData = {
            name: defaultName,
            phone: phone,
            password: '123456',
            payPassword: '123456',
            promoCode: currentUserPromoCode
          };
          
          const response = await userApiService.register(registerData);
          
          // æ¢å¤å½“å‰ç”¨æˆ·çš„tokenå’ŒuserInfo
          if (currentToken) {
            userApiService.token = currentToken;
            localStorage.setItem('user_token', currentToken);
          }
          if (currentUserInfo) {
            userApiService.userInfo = currentUserInfo;
            localStorage.setItem('user_info', JSON.stringify(currentUserInfo));
          }
          
          if (response && response.success) {
            showToast('å‡çº§æˆåŠŸï¼è¯¥ç”¨æˆ·å·²æ³¨å†Œä¸ºæ™®é€šä¼šå‘˜ï¼Œç™»å½•å¯†ç å’Œæ”¯ä»˜å¯†ç å‡ä¸ºï¼š123456');
            document.getElementById('upgradeToOrdinaryModal').style.display = 'none';
            document.getElementById('upgradeToOrdinaryPhone').value = '';
            
            // åˆ·æ–°éä¼šå‘˜åˆ—è¡¨
            await loadNonMembers();
          } else {
            showToast('å‡çº§å¤±è´¥ï¼š' + (response?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        } catch (error) {
          console.error('å‡çº§æ™®é€šä¼šå‘˜é”™è¯¯:', error);
          showToast('å‡çº§å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'), 'error');
        }
      }
      
      // ç¡®è®¤å‡çº§ä¸ºä»£ç†ç”¨æˆ·
      function confirmUpgradeToAgent() {
        const phone = document.getElementById('upgradeToAgentPhone').value;
        if (!phone) {
          alert('è¯·è¾“å…¥æ‰‹æœºå·');
          return;
        }
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!/^1[3-9]\d{9}$/.test(phone)) {
          alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
          return;
        }
        
        // è¿™é‡Œè°ƒç”¨åç«¯API
        alert(`æ™®é€šç”¨æˆ·å‡çº§ä¸ºä»£ç†ç”¨æˆ·åŠŸèƒ½å·²è§¦å‘ï¼Œæ‰‹æœºå·ï¼š${phone}`);
        document.getElementById('upgradeToAgentModal').style.display = 'none';
        document.getElementById('upgradeToAgentPhone').value = '';
        
        // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        // refreshUserList();
      }
      
      // åŠ è½½ç”¨æˆ·æ•°æ®
      async function loadUserData() {
        if (!userApiService.isAuthenticated()) {
          // å¦‚æœæœªç™»å½•ï¼Œä¸è·³è½¬ï¼Œåªæ˜¯é™é»˜è¿”å›
          return;
        }
        
        try {
          // è·å–ç”¨æˆ·ä¿¡æ¯
          const profileResponse = await userApiService.getUserProfile();
          if (!profileResponse || !profileResponse.success) {
            // å¦‚æœè·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸï¼Œä½†ä¸ä¸»åŠ¨è·³è½¬
            console.warn('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', profileResponse?.message);
            return;
          }
          
          if (profileResponse.success) {
            const user = profileResponse.data;
            currentUserRole = user.userType === 'agent' ? 'agent' : 'ordinary';
            currentUserPromoCode = user.promoCode;
            cachedCurrentPoints = parseFloat(user.points) || 0;
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°userApiService
            if (userApiService) {
              userApiService.userInfo = user;
              if (user.parent) {
                userApiService.parentInfo = user.parent;
              }
            }
            
            // æ›´æ–°ä¼šå‘˜ç±»å‹æ˜¾ç¤º
            const roleDisplay = document.getElementById('userRole');
            if (roleDisplay) {
              if (currentUserRole === 'agent') {
                roleDisplay.textContent = 'ä»£ç†ä¼šå‘˜';
              } else {
                roleDisplay.textContent = 'æ™®é€šä¼šå‘˜';
              }
            }
            
            // å¦‚æœæ˜¯ä»£ç†ç”¨æˆ·ï¼ŒåŠ è½½å¥–åŠ±ç»Ÿè®¡
            if (currentUserRole === 'agent') {
              await loadRewardStatistics();
            }
            
            // æ›´æ–°ç°é‡‘æ”¶ç›Šæ˜¾ç¤º
            const cashProfitElement = document.getElementById('cashProfit');
            if (cashProfitElement) {
              if (user.cashProfit !== undefined) {
                cashProfitElement.textContent = (user.cashProfit || 0).toFixed(2);
              } else {
                cashProfitElement.textContent = '0.00';
              }
            }
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            updateUserInfoDisplay();
          }
          
          // è·å–é‡‘å¸ä½™é¢
          const balanceResponse = await userApiService.getPointsBalance();
          if (balanceResponse.success) {
            cachedCurrentPoints = parseFloat(balanceResponse.data.points) || 0;
            updateUserInfoDisplay();
          }
        } catch (error) {
          console.error('åŠ è½½ç”¨æˆ·æ•°æ®é”™è¯¯:', error);
        }
      }
      
      // åˆ›å»ºéä¼šå‘˜å¡ç‰‡
      function createNonMemberCard(nm) {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div class="order-header">
            <div class="order-name">${sanitizeInput(nm.name)}</div>
            <div class="order-status pending">éä¼šå‘˜</div>
          </div>
          <div class="order-details">
            <div class="order-detail">
              <div class="order-detail-label">ç¢°ç¢°é“¾æ¥</div>
              <div class="order-detail-value">${sanitizeInput(nm.link || 'https://t.cn/R123456')}</div>
            </div>
            <div class="order-detail">
              <div class="order-detail-label">æ·»åŠ æ—¶é—´</div>
              <div class="order-detail-value">${nm.created_at ? new Date(nm.created_at).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
            </div>
          </div>
          <div class="order-actions">
            <button class="order-action-btn" onclick="document.getElementById('upgradeToOrdinaryModal').style.display = 'flex'">å‡çº§æ™®é€šä¼šå‘˜</button>
            <button class="order-action-btn delete" onclick="deleteNonMember(${nm.id})">åˆ é™¤</button>
          </div>
        `;
        return card;
      }
      
      // åˆ é™¤éä¼šå‘˜
      async function deleteNonMember(id) {
        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        const modal = document.createElement('div');
        modal.className = 'confirm-modal active';
        modal.innerHTML = `
          <div class="confirm-modal-content">
            <div style="font-size: 16px; margin-bottom: 20px; color: #333;">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªéä¼šå‘˜å—ï¼Ÿ</div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button class="btn btn-secondary" style="padding: 8px 16px;">å–æ¶ˆ</button>
              <button class="btn btn-danger" style="padding: 8px 16px;">ç¡®è®¤åˆ é™¤</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // è¿”å›Promiseï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤
        return new Promise((resolve) => {
          const cancelBtn = modal.querySelector('.btn-secondary');
          const confirmBtn = modal.querySelector('.btn-danger');
          
          // å–æ¶ˆæŒ‰é’®
          cancelBtn.onclick = function() {
            modal.remove();
            resolve(false);
          };
          
          // ç¡®è®¤æŒ‰é’®
          confirmBtn.onclick = async function() {
            modal.remove();
            try {
              const response = await userApiService.deleteNonMember(id);
              if (response.success) {
                showToast('åˆ é™¤æˆåŠŸï¼');
                loadNonMembers();
                resolve(true);
              } else {
                showToast(response.message || 'åˆ é™¤å¤±è´¥', 'error');
                resolve(false);
              }
            } catch (error) {
              console.error('åˆ é™¤éä¼šå‘˜é”™è¯¯:', error);
              showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
              resolve(false);
            }
          };
          
          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
              resolve(false);
            }
          });
        });
      }
      
      // ä¿ç•™åŸå‡½æ•°ç”¨äºå…¼å®¹ï¼ˆå·²åºŸå¼ƒï¼‰
      async function deleteNonMember_old(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªéä¼šå‘˜å—ï¼Ÿ')) {
          return;
        }
        
        try {
          const response = await userApiService.deleteNonMember(id);
          if (response.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            loadNonMembers();
          } else {
            alert(response.message || 'åˆ é™¤å¤±è´¥');
          }
        } catch (error) {
          console.error('åˆ é™¤éä¼šå‘˜é”™è¯¯:', error);
          alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // åŠ è½½éä¼šå‘˜åˆ—è¡¨
      async function loadNonMembers() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        try {
          const response = await userApiService.getNonMembers();
          if (response.success) {
            // æ›´æ–°éä¼šå‘˜åˆ—è¡¨æ˜¾ç¤ºï¼ˆåœ¨ç”¨æˆ·ç®¡ç†é¡µé¢ï¼‰
            const nonMemberList = document.getElementById('nonmember-list');
            if (nonMemberList) {
              nonMemberList.innerHTML = '';
              response.data.list.forEach(nm => {
                const card = createNonMemberCard(nm);
                nonMemberList.appendChild(card);
              });
            }
          }
        } catch (error) {
          console.error('åŠ è½½éä¼šå‘˜åˆ—è¡¨é”™è¯¯:', error);
        }
      }
      
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
      function updateUserInfoDisplay() {
        // æ›´æ–°é‡‘å¸ä½™é¢æ˜¾ç¤º
        const pointsElements = document.querySelectorAll('.points-balance');
        pointsElements.forEach(el => {
          el.textContent = cachedCurrentPoints.toFixed(2);
        });
        
        // æ›´æ–°æ¨å¹¿ç æ˜¾ç¤º
        if (currentUserPromoCode) {
          const promoElements = document.querySelectorAll('.user-promo-code');
          promoElements.forEach(el => {
            el.textContent = currentUserPromoCode;
          });
        }
        
        // æ›´æ–°ç°é‡‘æ”¶ç›Šæ˜¾ç¤º
        const cashProfitElement = document.getElementById('cashProfit');
        if (cashProfitElement) {
          if (userApiService && userApiService.userInfo && userApiService.userInfo.cashProfit !== undefined) {
            cashProfitElement.textContent = (userApiService.userInfo.cashProfit || 0).toFixed(2);
          } else {
            cashProfitElement.textContent = '0.00';
          }
        }
        
        // æ›´æ–°ä¸ªäººä¸­å¿ƒæ˜¾ç¤º
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userPhoneDisplay = document.getElementById('userPhoneDisplay');
        const userPromoCodeDisplay = document.getElementById('userPromoCode');
        const userRegisterDateDisplay = document.getElementById('userRegisterDate');
        
        if (userApiService && userApiService.userInfo) {
          const userInfo = userApiService.userInfo;
          
          // æ›´æ–°å§“å
          if (userNameDisplay) {
            userNameDisplay.textContent = userInfo.name || '--';
          }
          
          // æ›´æ–°æ‰‹æœºå·ï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰
          if (userPhoneDisplay) {
            userPhoneDisplay.textContent = userInfo.phone || '--';
          }
          
          // æ›´æ–°æ¨å¹¿ç 
          if (userPromoCodeDisplay) {
            userPromoCodeDisplay.textContent = userInfo.promoCode || currentUserPromoCode || '--';
          }
          
          // æ›´æ–°æ³¨å†Œæ—¶é—´
          if (userRegisterDateDisplay) {
            userRegisterDateDisplay.textContent = userInfo.registerDate || '--';
          }
        }
      }
      
      // å…³é—­æ¨¡æ€æ¡†
      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.remove();
        }
      }
      
      // æ˜¾ç¤ºç°é‡‘æ”¶ç›Šæ¸…å•
      async function showCashProfitList() {
        try {
          // ä»åç«¯è·å–ç°é‡‘æ”¶ç›Šæ¸…å•ï¼ˆå·²è®¡ç®—å¥½æ”¶ç›Šï¼‰
          const response = await userApiService.getCashProfitList();
          
          if (!response || !response.success || !response.data) {
            alert('è·å–æ”¶ç›Šæ¸…å•å¤±è´¥ï¼š' + (response?.message || 'æœªçŸ¥é”™è¯¯'));
            return;
          }
          
          const profitList = response.data.list || [];
          const totalProfit = response.data.totalProfit || 0;
          
          if (profitList.length === 0) {
            alert('æš‚æ— è½¬è´¦è®°å½•');
            return;
          }
          
          // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºæ”¶ç›Šæ¸…å•
          let modalHtml = `
            <div class="modal" id="cash-profit-modal" style="display: flex;">
              <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                  <h3>ç°é‡‘æ”¶ç›Šæ¸…å•</h3>
                  <button class="modal-close" onclick="closeModal('cash-profit-modal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                </div>
                <div class="modal-body">
                  <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æ€»æ”¶ç›Š</div>
                    <div style="font-size: 32px; font-weight: bold;">Â¥${totalProfit.toFixed(2)}</div>
                  </div>
                  <div style="max-height: 500px; overflow-y: auto; padding: 10px 0;">
                    <div id="cash-profit-cards-container" style="display: grid; gap: 15px;">
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary" onclick="closeModal('cash-profit-modal')">å…³é—­</button>
                </div>
              </div>
            </div>
          `;
          
          // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
          const existingModal = document.getElementById('cash-profit-modal');
          if (existingModal) {
            existingModal.remove();
          }
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          
          // å¡«å……å¡ç‰‡æ•°æ®
          const container = document.getElementById('cash-profit-cards-container');
          if (container) {
            container.innerHTML = '';
            
            if (profitList.length === 0) {
              container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— è½¬è´¦è®°å½•</div>';
            } else {
              // éå†è®°å½•
              profitList.forEach(item => {
                const isMultiPrice = item.isMultiPrice && item.purchaseDetails && item.purchaseDetails.length > 1;
                
                // å¦‚æœæ˜¯å¤šå•ä»·ï¼Œåˆå¹¶æ˜¾ç¤º
                if (isMultiPrice && item.purchaseDetails) {
                  // åˆå¹¶ç›¸åŒå•ä»·çš„è´­ä¹°è®°å½•
                  const mergedDetails = {};
                  item.purchaseDetails.forEach(detail => {
                    const priceKey = detail.unit_price.toFixed(2);
                    if (!mergedDetails[priceKey]) {
                      mergedDetails[priceKey] = {
                        unit_price: detail.unit_price,
                        quantity: 0
                      };
                    }
                    mergedDetails[priceKey].quantity += detail.quantity;
                  });
                  
                  // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å•ä»·æ’åº
                  const mergedArray = Object.values(mergedDetails).sort((a, b) => a.unit_price - b.unit_price);
                  
                  // åˆå¹¶æ•°é‡æ˜¾ç¤ºï¼ˆå¦‚"5+15"ï¼Œç›¸åŒå•ä»·çš„æ•°é‡å·²åˆå¹¶ï¼‰
                  const quantityDisplay = mergedArray.map(detail => detail.quantity.toFixed(0)).join('+');
                  // åˆå¹¶è´­ä¹°å•ä»·æ˜¾ç¤ºï¼ˆå¦‚"Â¥8.00/é‡‘å¸ã€Â¥9.00/é‡‘å¸"ï¼‰
                  const purchasePriceDisplay = mergedArray.map(detail => `Â¥${detail.unit_price.toFixed(2)}/é‡‘å¸`).join('ã€');
                  
                  // ç”Ÿæˆè®¡ç®—å…¬å¼ï¼ˆä½¿ç”¨åˆå¹¶åçš„æ•°æ®ï¼‰
                  const formulaParts = mergedArray.map(detail => {
                    const diff = (item.transferUnitPrice - detail.unit_price).toFixed(2);
                    return `(${item.transferUnitPrice.toFixed(2)}-${detail.unit_price.toFixed(2)})Ã—${detail.quantity.toFixed(0)}`;
                  });
                  const formula = formulaParts.join('+') + `=Â¥${item.profit.toFixed(2)}`;
                  
                  // è½¬è´¦æ•°é‡æ˜¾ç¤ºï¼šæ€»æ•°é‡ï¼ˆåˆå¹¶åçš„æ•°é‡ï¼‰
                  const totalQuantity = mergedArray.reduce((sum, detail) => sum + detail.quantity, 0);
                  const quantityWithBreakdown = `${totalQuantity.toFixed(0)} é‡‘å¸ï¼ˆ${quantityDisplay}ï¼‰`;
                  
                  const card = document.createElement('div');
                  card.style.cssText = 'background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #52c41a;';
                  card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                      <div>
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${sanitizeInput(item.receiverName || item.toUserName || 'æœªçŸ¥ç”¨æˆ·')}</div>
                        <div style="font-size: 12px; color: #999;">${item.createdAt || '--'}</div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: bold; color: #52c41a;">+Â¥${item.profit.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #999;">æ”¶ç›Š</div>
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è½¬è´¦æ•°é‡</div>
                        <div style="font-size: 14px; font-weight: 500; color: #333;">${quantityWithBreakdown}</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è½¬è´¦å•ä»·</div>
                        <div style="font-size: 14px; font-weight: 500; color: #333;">Â¥${item.transferUnitPrice.toFixed(2)}/é‡‘å¸</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è´­ä¹°å•ä»·</div>
                        <div style="font-size: 14px; font-weight: 500; color: #666;">${purchasePriceDisplay}</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">åˆè®¡</div>
                        <div style="font-size: 14px; font-weight: 500; color: #52c41a;">Â¥${item.profit.toFixed(2)}</div>
                      </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                      <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è®¡ç®—å…¬å¼</div>
                      <div style="font-size: 13px; font-weight: 500; color: #666; word-break: break-all;">${formula}</div>
                    </div>
                  `;
                  container.appendChild(card);
                } else {
                  // å•å•ä»·ï¼Œæ­£å¸¸æ˜¾ç¤º
                  const card = document.createElement('div');
                  card.style.cssText = 'background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #52c41a;';
                  card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                      <div>
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${sanitizeInput(item.receiverName || item.toUserName || 'æœªçŸ¥ç”¨æˆ·')}</div>
                        <div style="font-size: 12px; color: #999;">${item.createdAt || '--'}</div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: bold; color: #52c41a;">+Â¥${item.profit.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #999;">æ”¶ç›Š</div>
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è½¬è´¦æ•°é‡</div>
                        <div style="font-size: 14px; font-weight: 500; color: #333;">${item.quantity.toFixed(2)} é‡‘å¸</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è½¬è´¦å•ä»·</div>
                        <div style="font-size: 14px; font-weight: 500; color: #333;">Â¥${item.transferUnitPrice.toFixed(2)}/é‡‘å¸</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">è´­ä¹°å•ä»·</div>
                        <div style="font-size: 14px; font-weight: 500; color: #666;">Â¥${item.purchaseUnitPrice.toFixed(2)}/é‡‘å¸</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">å·®ä»·</div>
                        <div style="font-size: 14px; font-weight: 500; color: #52c41a;">Â¥${(item.transferUnitPrice - item.purchaseUnitPrice).toFixed(2)}/é‡‘å¸</div>
                      </div>
                    </div>
                  `;
                  container.appendChild(card);
                }
              });
            }
          }
          
        } catch (error) {
          console.error('æ˜¾ç¤ºæ”¶ç›Šæ¸…å•å¤±è´¥:', error);
          alert('æ˜¾ç¤ºæ”¶ç›Šæ¸…å•å¤±è´¥ï¼š' + error.message);
        }
      }
      
      // æ‰“å¼€ç”³è¯·æˆä¸ºä»£ç†æ¨¡æ€æ¡†
      function openApplyAgentModal() {
        try {
          // åŠ è½½ä¸Šçº§è”ç³»æ–¹å¼
          loadParentContact();
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          const modal = document.getElementById('applyAgentModal');
          if (modal) {
            modal.style.display = 'flex';
          }
        } catch (error) {
          console.error('æ‰“å¼€ç”³è¯·æˆä¸ºä»£ç†æ¨¡æ€æ¡†é”™è¯¯:', error);
          alert('æ‰“å¼€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // åŠ è½½ä¸Šçº§è”ç³»æ–¹å¼ï¼ˆç”¨äºç”³è¯·æˆä¸ºä»£ç†ï¼‰
      function loadParentContact() {
        try {
          const parentName = document.getElementById('parentContactName');
          const parentPhone = document.getElementById('parentContactPhone');
          
          // ä»userApiServiceè·å–ä¸Šçº§ä¿¡æ¯
          if (userApiService && userApiService.parentInfo) {
            if (parentName) parentName.textContent = userApiService.parentInfo.name || '--';
            if (parentPhone) parentPhone.textContent = userApiService.parentInfo.phone || '--';
          } else if (userApiService && userApiService.userInfo && userApiService.userInfo.parent) {
            // å¦‚æœæ²¡æœ‰parentInfoï¼Œå°è¯•ä»userInfoä¸­è·å–
            if (parentName) parentName.textContent = userApiService.userInfo.parent.name || '--';
            if (parentPhone) parentPhone.textContent = userApiService.userInfo.parent.phone || '--';
          } else {
            // å¦‚æœæ²¡æœ‰ä¸Šçº§ä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤º
            if (parentName) parentName.textContent = 'æš‚æ— ä¸Šçº§ä¿¡æ¯';
            if (parentPhone) parentPhone.textContent = 'æš‚æ— ä¸Šçº§ä¿¡æ¯';
          }
        } catch (error) {
          console.error('åŠ è½½ä¸Šçº§è”ç³»æ–¹å¼é”™è¯¯:', error);
          const parentName = document.getElementById('parentContactName');
          const parentPhone = document.getElementById('parentContactPhone');
          if (parentName) parentName.textContent = 'åŠ è½½å¤±è´¥';
          if (parentPhone) parentPhone.textContent = 'åŠ è½½å¤±è´¥';
        }
      }
      
      // é€€å‡ºç™»å½•
      function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          userApiService.logout();
          currentUserRole = 'ordinary';
          currentUserPromoCode = '';
          cachedCurrentPoints = 0;
          clearOrderList();
          showPage('login-page');
          // ä¾‹å¦‚å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨æ³¨é”€ä¼šè¯
          alert('é€€å‡ºç™»å½•æˆåŠŸ');
          // è·³è½¬åˆ°ç™»å½•é¡µé¢
          showPage('login-page');
        }
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®é»˜è®¤æ—¥æœŸå’Œé‡‘å¸ä¿¡æ¯
      document.addEventListener('DOMContentLoaded', function() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (userApiService.isAuthenticated()) {
          // å·²ç™»å½•ï¼ŒåŠ è½½ç”¨æˆ·æ•°æ®
          loadUserData();
          loadNonMembers();
          loadSystemSettings();
        } else {
          // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
          showPage('login-page');
        }
        
        // ç¡®ä¿ç™»å½•å’Œæ³¨å†Œé¡µé¢éšè—åº•éƒ¨å¯¼èˆª
        const currentPage = document.querySelector('.page.active');
        const bottomNav = document.querySelector('.bottom-nav');
        if (currentPage && (currentPage.id === 'login-page' || currentPage.id === 'register-page')) {
          if (bottomNav) {
            bottomNav.style.display = 'none';
          }
        } else {
          // å…¶ä»–é¡µé¢æ˜¾ç¤ºåº•éƒ¨å¯¼èˆª
          if (bottomNav) {
            bottomNav.style.display = 'flex';
          }
        }
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©ï¼ˆä½¿ç”¨æœ¬åœ°æ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜ï¼‰
        const today = new Date();
        const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const settlementDateInput = document.getElementById('settlementDate');
        if (settlementDateInput) {
          settlementDateInput.value = dateString;
          // è®¾ç½®æœ€å°æ—¥æœŸä¸ºä»Šå¤©
          settlementDateInput.setAttribute('min', dateString);
          settlementDateInput.addEventListener('change', () => {
            // éªŒè¯æ—¥æœŸä¸èƒ½æ˜¯ä»Šå¤©ä¹‹å‰çš„
            const selectedDate = settlementDateInput.value;
            if (selectedDate < dateString) {
              alert('ä¸èƒ½é€‰æ‹©ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ');
              settlementDateInput.value = dateString;
            }
            if (pendingOrderCount > 0) {
              recalculateOrderPricing();
            }
          });
        }
        const historyDateInput = document.getElementById('historyDate');
        if (historyDateInput) {
          historyDateInput.value = dateString;
        }
        
        // åˆå§‹åŒ–é‡‘å¸ä¿¡æ¯ï¼ˆä»åç«¯è·å–çœŸå®æ•°æ®ï¼‰
        if (userApiService.isAuthenticated()) {
          refreshPointsInfo();
        }
        populateRewardInfo();
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²æ›´æ–°æ˜¾ç¤º
        updateRoleDisplay();
        
        // åˆå§‹åŒ–æ¨å¹¿ç æ˜¾ç¤ºï¼ˆä»åç«¯è·å–çœŸå®æ•°æ®ï¼‰
        const promoCodeElement = document.getElementById('userPromoCode');
        if (promoCodeElement) {
          if (currentUserPromoCode) {
            promoCodeElement.textContent = currentUserPromoCode;
          } else {
            promoCodeElement.textContent = '--';
          }
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†é¡µé¢
        switchUserTab('nonmember');
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šæŠ¥å•æŒ‰é’®äº‹ä»¶ï¼ˆç¡®ä¿æŒ‰é’®å­˜åœ¨æ—¶èƒ½æ­£ç¡®ç»‘å®šï¼‰
        document.addEventListener('click', function(e) {
          if (e.target && (e.target.id === 'settleButton' || e.target.closest('#settleButton'))) {
            e.preventDefault();
            e.stopPropagation();
            console.log('æŠ¥å•æŒ‰é’®è¢«ç‚¹å‡»');
            settleOrders();
          }
        });
        
        // ä¹Ÿå°è¯•ç›´æ¥ç»‘å®šï¼ˆå¦‚æœæŒ‰é’®å·²å­˜åœ¨ï¼‰
        setTimeout(function() {
          const settleButton = document.getElementById('settleButton');
          if (settleButton) {
            settleButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log('æŠ¥å•æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆç›´æ¥ç»‘å®šï¼‰');
              settleOrders();
            });
            console.log('æŠ¥å•æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
          } else {
            console.warn('æŠ¥å•æŒ‰é’®æœªæ‰¾åˆ°');
          }
        }, 100);
      });
      
      // æ›´æ–°ç”¨æˆ·è§’è‰²æ˜¾ç¤º
      function updateRoleDisplay() {
        // ä»åç«¯è·å–çœŸå®çš„ä¼šå‘˜ç±»å‹
        const roleDisplay = document.getElementById('userRole');
        if (roleDisplay) {
          if (currentUserRole === 'agent') {
            roleDisplay.textContent = 'ä»£ç†ä¼šå‘˜';
          } else {
            roleDisplay.textContent = 'æ™®é€šä¼šå‘˜';
          }
        }
      }
      
      // åˆ·æ–°é‡‘å¸ä¿¡æ¯
      async function refreshPointsInfo() {
        // ä»åç«¯APIè·å–çœŸå®çš„é‡‘å¸ä¿¡æ¯
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        try {
          // è·å–é‡‘å¸ä½™é¢
          const balanceResponse = await userApiService.getPointsBalance();
          if (balanceResponse.success) {
            cachedCurrentPoints = parseFloat(balanceResponse.data.points) || 0;
            document.getElementById('currentPointsValue').textContent = cachedCurrentPoints.toFixed(2);
          }
          
          // è·å–è®¢å•ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ç›¸å…³APIï¼‰
          // æš‚æ—¶è®¾ç½®ä¸º0ï¼Œç­‰å¾…åç«¯å®ç°ç›¸å…³API
          document.getElementById('todayPoints').textContent = '0.00';
          document.getElementById('yesterdayPoints').textContent = '0.00';
          document.getElementById('monthPoints').textContent = '0.00';
          document.getElementById('lastMonthPoints').textContent = '0.00';
        } catch (error) {
          console.error('è·å–é‡‘å¸ä¿¡æ¯é”™è¯¯:', error);
          // å¦‚æœè·å–å¤±è´¥ï¼Œä¿æŒå½“å‰æ˜¾ç¤ºå€¼ä¸å˜
        }
      }
      
      // Toasté€šçŸ¥å‡½æ•°
      function showToast(message, type = 'success') {
        // ç§»é™¤å·²å­˜åœ¨çš„toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          toast.style.animation = 'toastSlideIn 0.3s ease-out reverse';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }
      
      // ç¡®è®¤å¼¹çª—å‡½æ•°
      function showConfirm(message, onConfirm, onCancel) {
        const modal = document.createElement('div');
        modal.className = 'confirm-modal active';
        modal.innerHTML = `
          <div class="confirm-modal-content">
            <div style="font-size: 16px; margin-bottom: 20px; color: #333;">${message}</div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="this.closest('.confirm-modal').remove(); ${onCancel ? onCancel() : ''}" style="padding: 8px 16px;">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="this.closest('.confirm-modal').remove(); ${onConfirm ? onConfirm() : ''}" style="padding: 8px 16px;">ç¡®è®¤</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
            if (onCancel) onCancel();
          }
        });
      }
      
      // å¤åˆ¶æ¨å¹¿ç 
      function copyPromoCode() {
        const promoCodeElement = document.getElementById('userPromoCode');
        const promoCode = promoCodeElement?.textContent?.trim();
        
        if (!promoCode || promoCode === '--') {
          alert('æ¨å¹¿ç ä¸å­˜åœ¨');
          return;
        }
        
        // ä½¿ç”¨ç°ä»£APIå¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(promoCode).then(() => {
            alert('æ¨å¹¿ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š' + promoCode);
          }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
            fallbackCopyTextToClipboard(promoCode);
          });
        } else {
          // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
          fallbackCopyTextToClipboard(promoCode);
        }
      }
      
      // é™çº§å¤åˆ¶æ–¹æ³•
      function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            alert('æ¨å¹¿ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š' + text);
          } else {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + text);
          }
        } catch (err) {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + text);
        }
        
        document.body.removeChild(textArea);
      }
      
      // ==================== 13. æ•°æ®éªŒè¯å¢å¼º ====================
      // æ³¨å†Œå¤„ç†å‡½æ•°
      async function handleRegister() {
        const name = document.getElementById('register-name').value.trim();
        const phone = document.getElementById('register-phone').value.trim();
        const password = document.getElementById('register-password').value;
        const promoCode = document.getElementById('register-promo').value.trim();
        const payPassword = document.getElementById('register-pay-password').value;
        
        // éªŒè¯å§“å
        if (!name) {
          alert('è¯·è¾“å…¥å§“å');
          return;
        }
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!validatePhone(phone)) {
          alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ï¼ˆ11ä½æ•°å­—ï¼Œä»¥1å¼€å¤´ï¼‰');
          return;
        }
        
        // éªŒè¯å¯†ç 
        if (!password || password.length < 6) {
          alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
          return;
        }
        
        // éªŒè¯æ¨å¹¿ç ï¼ˆå¿…å¡«é¡¹ï¼‰
        if (!promoCode || !/^\d{6}$/.test(promoCode)) {
          alert('æ¨å¹¿ç ä¸ºå¿…å¡«é¡¹ï¼Œå¿…é¡»æ˜¯6ä½æ•°å­—');
          return;
        }
        
        // éªŒè¯æ¨å¹¿ç æ˜¯å¦å­˜åœ¨ï¼ˆç”¨äºç»‘å®šä¸Šçº§ï¼‰
        const validateResponse = await userApiService.validatePromoCode(promoCode);
        if (!validateResponse.success || !validateResponse.data.isUnique) {
          alert('è¯¥æ¨å¹¿ç ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šä¸Šçº§å…³ç³»');
          return;
        }
        
        // éªŒè¯æ”¯ä»˜å¯†ç 
        if (!payPassword || !/^\d{6}$/.test(payPassword)) {
          alert('æ”¯ä»˜å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—');
          return;
        }
        
        // è°ƒç”¨æ³¨å†ŒAPI
        try {
          const response = await userApiService.register({
            name: name,
            phone: phone,
            password: password,
            payPassword: payPassword,
            promoCode: promoCode  // å¿…å¡«é¡¹ï¼Œç”¨äºç»‘å®šä¸Šçº§
          });
          
          if (response.success) {
            // Tokenå·²ç»åœ¨userApiService.registerä¸­ä¿å­˜äº†
            showToast('æ³¨å†ŒæˆåŠŸï¼');
            
            // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
            currentUserRole = 'ordinary';
            currentUserPromoCode = response.data.promoCode;
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('register-name').value = '';
            document.getElementById('register-phone').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-pay-password').value = '';
            const promoInput = document.getElementById('register-promo');
            if (promoInput && !promoInput.readOnly) {
              promoInput.value = '';
            }
            
            // åˆ‡æ¢åˆ°è®¢å•é¡µé¢
            showPage('orders-page');
            
            // åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆåœ¨é¡µé¢åˆ‡æ¢åå¼‚æ­¥åŠ è½½ï¼Œé¿å…é˜»å¡ï¼‰
            setTimeout(async () => {
              try {
                await loadUserData();
                await refreshPointsInfo();
              } catch (loadError) {
                console.warn('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼Œä½†æ³¨å†Œå·²æˆåŠŸ:', loadError);
                // ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œé™é»˜å¤±è´¥
              }
            }, 100);
          } else {
            alert(response.message || 'æ³¨å†Œå¤±è´¥');
          }
        } catch (error) {
          console.error('æ³¨å†Œé”™è¯¯:', error);
          alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
      }
      
      // ç”¨æˆ·ç™»å½•
      async function handleLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        const password = document.getElementById('login-password').value;
        
        if (!phone) {
          alert('è¯·è¾“å…¥æ‰‹æœºå·');
          return;
        }
        
        if (!validatePhone(phone)) {
          alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
          return;
        }
        
        if (!password) {
          alert('è¯·è¾“å…¥å¯†ç ');
          return;
        }
        
        try {
          const response = await userApiService.login(phone, password);
          
          if (response.success) {
            // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
            const user = response.data.user;
            currentUserRole = user.userType === 'agent' ? 'agent' : 'ordinary';
            currentUserPromoCode = user.promoCode;
            cachedCurrentPoints = parseFloat(user.points) || 0;
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°userApiService
            if (userApiService) {
              userApiService.userInfo = user;
              if (user.parent) {
                userApiService.parentInfo = user.parent;
              }
            }
            
            // æ›´æ–°ä¼šå‘˜ç±»å‹æ˜¾ç¤º
            const roleDisplay = document.getElementById('userRole');
            if (roleDisplay) {
              if (currentUserRole === 'agent') {
                roleDisplay.textContent = 'ä»£ç†ä¼šå‘˜';
              } else {
                roleDisplay.textContent = 'æ™®é€šä¼šå‘˜';
              }
            }
            
            // æ›´æ–°ç°é‡‘æ”¶ç›Šæ˜¾ç¤º
            if (user.cashProfit !== undefined) {
              const cashProfitElement = document.getElementById('cashProfit');
              if (cashProfitElement) {
                cashProfitElement.textContent = (user.cashProfit || 0).toFixed(2);
              }
            }
            
            showToast('ç™»å½•æˆåŠŸï¼');
            showPage('orders-page');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('login-phone').value = '';
            document.getElementById('login-password').value = '';
            // åˆ·æ–°é¡µé¢æ•°æ®
            await loadUserData();
            await refreshPointsInfo();
          } else {
            alert(response.message || 'ç™»å½•å¤±è´¥');
          }
        } catch (error) {
          console.error('ç™»å½•é”™è¯¯:', error);
          alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // æ‰‹æœºå·æ ¼å¼éªŒè¯
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
      }
      
      // æ¨å¹¿ç å”¯ä¸€æ€§éªŒè¯ï¼ˆè°ƒç”¨åç«¯APIï¼‰
      async function validatePromoCode(promoCode) {
        try {
          const response = await userApiService.validatePromoCode(promoCode);
          return response.success && response.data.isUnique;
        } catch (error) {
          console.error('éªŒè¯æ¨å¹¿ç é”™è¯¯:', error);
          return false;
        }
      }
      
      // æ•°æ®æ ¼å¼éªŒè¯ï¼ˆé˜²æ­¢XSSï¼‰
      function sanitizeInput(input) {
        if (typeof input !== 'string') return input;
        return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                   .replace(/[<>]/g, '');
      }
      
      // æ‰“å¼€è½¬è´¦å¼¹çª—ï¼ˆä»ç”¨æˆ·ç®¡ç†é¡µé¢ï¼‰
      function openTransferModal(phone, name) {
        if (!phone) {
          alert('è¯¥ç”¨æˆ·æ²¡æœ‰æ‰‹æœºå·ï¼Œæ— æ³•è½¬è´¦');
          return;
        }
        // phoneå¯èƒ½æ˜¯å®Œæ•´æ‰‹æœºå·æˆ–éšè—æ ¼å¼ï¼Œå¦‚æœæ˜¯éšè—æ ¼å¼éœ€è¦ä»userå¯¹è±¡ä¸­è·å–å®Œæ•´æ‰‹æœºå·
        // è¿™é‡Œç›´æ¥ä½¿ç”¨phoneï¼Œå› ä¸ºåç«¯å·²ç»è¿”å›å®Œæ•´æ‰‹æœºå·
        document.getElementById('transferToPhone').value = phone;
        document.getElementById('transferPointsModal').style.display = 'flex';
      }
      
      // è®¡ç®—ç”¨æˆ·è´­ä¹°å•ä»·ï¼ˆè€ƒè™‘ä¼˜æƒ ï¼‰
      function calculateUserPurchasePrice(quantity, exchangeRate, discountRules) {
        if (!discountRules || discountRules.length === 0) {
          return exchangeRate;
        }
        
        // æ‰¾åˆ°é€‚ç”¨çš„ä¼˜æƒ è§„åˆ™ï¼ˆå……å€¼é‡‘é¢æœ€å¤§çš„é€‚ç”¨è§„åˆ™ï¼‰
        const applicableRules = discountRules.filter(r => quantity * exchangeRate >= r.minAmount);
        if (applicableRules.length === 0) {
          return exchangeRate;
        }
        
        // è¿”å›å……å€¼é‡‘é¢æœ€å¤§çš„è§„åˆ™çš„æŠ˜æ‰£
        const maxRule = applicableRules.reduce((max, rule) => rule.minAmount > max.minAmount ? rule : max);
        const discount = maxRule.discount / 100; // æŠ˜æ‰£å€¼ï¼ˆä¾‹å¦‚98è¡¨ç¤º98æŠ˜ï¼Œå³0.98ï¼‰
        
        // è®¡ç®—ä¼˜æƒ åçš„å•ä»·ï¼šåŸä»· * æŠ˜æ‰£
        return exchangeRate * discount;
      }
      
      // é‡‘å¸è½¬è´¦
      async function transferPoints() {
        const toPhone = document.getElementById('transferToPhone').value;
        const quantity = parseFloat(document.getElementById('transferQuantity').value);
        const unitPrice = parseFloat(document.getElementById('transferUnitPrice').value);
        const password = document.getElementById('transferPointsPassword').value;
        
        if (!toPhone || !quantity || !unitPrice || !password) {
          alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!validatePhone(toPhone)) {
          alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
          return;
        }
        
        // ä»åç«¯è·å–æœ€æ–°ç³»ç»Ÿè®¾ç½®
        let settings;
        try {
          const settingsResponse = await userApiService.getSettings();
          if (!settingsResponse.success) {
            alert('è·å–ç³»ç»Ÿé…ç½®å¤±è´¥ï¼š' + (settingsResponse.message || 'æœªçŸ¥é”™è¯¯'));
            return;
          }
          settings = settingsResponse.data;
          
          // æ›´æ–°backendSettings
          backendSettings.transferLimits = settings.transferLimits || backendSettings.transferLimits;
          backendSettings.coinExchangeRate = settings.coinExchangeRate || 10.0;
          backendSettings.rechargeDiscountRules = settings.rechargeDiscountRules || [];
        } catch (error) {
          console.error('è·å–ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
          alert('è·å–ç³»ç»Ÿé…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
          return;
        }
        
        const minQuantity = backendSettings.transferLimits.minQuantity;
        const maxUnitPrice = backendSettings.transferLimits.maxUnitPrice;
        const exchangeRate = backendSettings.coinExchangeRate;
        const discountRules = backendSettings.rechargeDiscountRules;
        
        // éªŒè¯è½¬è´¦æ•°é‡
        if (quantity < minQuantity) {
          alert(`è½¬è´¦æ•°é‡ä¸èƒ½ä½äºåå°è®¾å®šçš„ ${minQuantity}`);
          return;
        }
        
        // è®¡ç®—ç”¨æˆ·è´­ä¹°å•ä»·ï¼ˆè€ƒè™‘ä¼˜æƒ ï¼‰
        const userPurchasePrice = calculateUserPurchasePrice(quantity, exchangeRate, discountRules);
        
        // éªŒè¯ï¼šè½¬è´¦å•ä»·ä¸èƒ½é«˜äºåå°è®¾å®šçš„æœ€é«˜å•ä»·
        if (unitPrice > maxUnitPrice) {
          alert(`è½¬è´¦å•ä»·ä¸èƒ½é«˜äºåå°è®¾å®šçš„æœ€é«˜å•ä»· ${maxUnitPrice} å…ƒ/é‡‘å¸`);
          return;
        }
        
        // éªŒè¯ï¼šè½¬è´¦å•ä»·ä¸èƒ½ä½äºç”¨æˆ·è´­ä¹°ä»·æ ¼ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
        let confirmedLowPrice = false;
        if (unitPrice < userPurchasePrice) {
          const confirmMsg = `è­¦å‘Šï¼šè½¬è´¦å•ä»· ${unitPrice} å…ƒ/é‡‘å¸ ä½äºæ‚¨çš„è´­ä¹°å•ä»· ${userPurchasePrice.toFixed(2)} å…ƒ/é‡‘å¸ï¼Œæ˜¯å¦ç¡®è®¤ç»§ç»­è½¬è´¦ï¼Ÿ`;
          if (!confirm(confirmMsg)) {
            return;
          }
          confirmedLowPrice = true;
        }
        
        // è°ƒç”¨è½¬è´¦API
        try {
          const response = await userApiService.transferPoints(toPhone, quantity, unitPrice, password, confirmedLowPrice);
          
          if (response.success) {
            alert('è½¬è´¦æˆåŠŸï¼');
            document.getElementById('transferPointsModal').style.display = 'none';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('transferToPhone').value = '';
            document.getElementById('transferQuantity').value = '';
            document.getElementById('transferUnitPrice').value = '';
            document.getElementById('transferPointsPassword').value = '';
            
            // åˆ·æ–°é‡‘å¸ä½™é¢ã€ç”¨æˆ·ä¿¡æ¯å’Œç”¨æˆ·åˆ—è¡¨
            await loadUserData(); // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ä»¥æ›´æ–°ç°é‡‘æ”¶ç›Š
            await refreshPointsInfo();
            if (currentUserRole === 'agent') {
              await loadOrdinaryMembers();
              await loadAgentMembers();
            }
          } else {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç¡®è®¤
            if (response.data && response.data.needConfirm) {
              const purchasePrice = response.data.purchaseUnitPrice;
              const confirmMsg = `è­¦å‘Šï¼šè½¬è´¦å•ä»· ${unitPrice} å…ƒ/é‡‘å¸ ä½äºæ‚¨çš„è´­ä¹°å•ä»· ${purchasePrice.toFixed(2)} å…ƒ/é‡‘å¸ï¼Œæ˜¯å¦ç¡®è®¤ç»§ç»­è½¬è´¦ï¼Ÿ`;
              if (confirm(confirmMsg)) {
                // ç”¨æˆ·ç¡®è®¤ï¼Œå†æ¬¡è°ƒç”¨API
                const retryResponse = await userApiService.transferPoints(toPhone, quantity, unitPrice, password, true);
                if (retryResponse.success) {
                  alert('è½¬è´¦æˆåŠŸï¼');
                  document.getElementById('transferPointsModal').style.display = 'none';
                  document.getElementById('transferToPhone').value = '';
                  document.getElementById('transferQuantity').value = '';
                  document.getElementById('transferUnitPrice').value = '';
                  document.getElementById('transferPointsPassword').value = '';
                  await loadUserData(); // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ä»¥æ›´æ–°ç°é‡‘æ”¶ç›Š
                  await refreshPointsInfo();
                  if (currentUserRole === 'agent') {
                    await loadOrdinaryMembers();
                    await loadAgentMembers();
                  }
                } else {
                  alert('è½¬è´¦å¤±è´¥ï¼š' + (retryResponse.message || 'æœªçŸ¥é”™è¯¯'));
                }
              }
            } else {
              alert('è½¬è´¦å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯'));
            }
          }
        } catch (error) {
          console.error('è½¬è´¦é”™è¯¯:', error);
          alert('è½¬è´¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
      
      // åŠ è½½ç³»ç»Ÿè®¾ç½®
      async function loadSystemSettings() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        try {
          const response = await userApiService.getSettings();
          if (response.success && response.data) {
            const settings = response.data;
            
            // æ›´æ–°backendSettings
            if (settings.transferLimits) {
              backendSettings.transferLimits = settings.transferLimits;
            }
            if (settings.price) {
              // å°†åç«¯è¿”å›çš„ { basePrice, fridayPrice } è½¬æ¢ä¸º { default, friday }
              backendSettings.basePointPrice = {
                default: settings.price.basePrice || 1.0,
                friday: settings.price.fridayPrice || 1.5
              };
            }
            if (settings.discountRules) {
              backendSettings.discountRules = settings.discountRules;
            }
            if (settings.rewardRates) {
              backendSettings.rewardRates = settings.rewardRates;
            }
            if (settings.coinExchangeRate !== undefined) {
              backendSettings.coinExchangeRate = settings.coinExchangeRate;
            }
            if (settings.rechargeDiscountRules) {
              backendSettings.rechargeDiscountRules = settings.rechargeDiscountRules;
            }
          }
        } catch (error) {
          console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
        }
      }
      
      // åŠ è½½å¥–åŠ±ç»Ÿè®¡ï¼ˆä»£ç†ç”¨æˆ·ï¼‰
      async function loadRewardStatistics() {
        if (!userApiService.isAuthenticated() || currentUserRole !== 'agent') {
          return;
        }
        
        try {
          const response = await userApiService.getRewardStatistics();
          if (response.success && response.data) {
            const data = response.data;
            
            // æ›´æ–°å¥–åŠ±ç»Ÿè®¡æ˜¾ç¤º
            const directRewardTodayEl = document.getElementById('directRewardToday');
            const indirectRewardTodayEl = document.getElementById('indirectRewardToday');
            const totalRewardValueEl = document.getElementById('totalRewardValue');
            
            if (directRewardTodayEl) {
              const todayDirect = parseFloat(data.today?.directReward || 0);
              directRewardTodayEl.textContent = 'Â¥' + todayDirect.toFixed(2);
            }
            
            if (indirectRewardTodayEl) {
              const todayIndirect = parseFloat(data.today?.indirectReward || 0);
              indirectRewardTodayEl.textContent = 'Â¥' + todayIndirect.toFixed(2);
            }
            
            if (totalRewardValueEl) {
              const totalDirect = parseFloat(data.total?.directReward || 0);
              const totalIndirect = parseFloat(data.total?.indirectReward || 0);
              const totalReward = totalDirect + totalIndirect;
              totalRewardValueEl.textContent = 'Â¥' + totalReward.toFixed(2);
            }
          }
        } catch (error) {
          console.error('åŠ è½½å¥–åŠ±ç»Ÿè®¡å¤±è´¥:', error);
        }
      }
      
      // åŠ è½½é‡‘å¸æŸ¥è¯¢è®°å½•
      async function loadPointsHistory() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        try {
          const response = await userApiService.getTransactions({ page: 1, pageSize: 100 });
          if (response.success && response.data) {
            const transactions = response.data.list || [];
            const tableBody = document.getElementById('pointsHistoryTable');
            
            if (tableBody) {
              tableBody.innerHTML = '';
              
              if (transactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
              } else {
                transactions.forEach(trans => {
                  const row = document.createElement('tr');
                  const typeMap = {
                    'recharge': 'å……å€¼',
                    'order_deduction': 'æŠ¥å•æ‰£é™¤',
                    'transfer_out': 'è½¬è´¦æ”¯å‡º',
                    'transfer_in': 'è½¬è´¦æ”¶å…¥',
                    'reward': 'å¥–åŠ±'
                  };
                  const typeText = typeMap[trans.transactionType] || trans.transactionType;
                  const pointsChange = parseFloat(trans.pointsChange || 0);
                  const balance = parseFloat(trans.balance || 0);
                  
                  row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${trans.createdAt || '--'}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${typeText}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; color: ${pointsChange >= 0 ? '#52c41a' : '#ff4d4f'};">${pointsChange >= 0 ? '+' : ''}${pointsChange.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${balance.toFixed(2)}</td>
                  `;
                  tableBody.appendChild(row);
                });
              }
            }
          } else {
            const tableBody = document.getElementById('pointsHistoryTable');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
            }
          }
        } catch (error) {
          console.error('åŠ è½½é‡‘å¸æŸ¥è¯¢è®°å½•å¤±è´¥:', error);
          const tableBody = document.getElementById('pointsHistoryTable');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
          }
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('pointsHistoryModal').style.display = 'flex';
      }
      
      // æ˜¾ç¤ºå¥–åŠ±æ˜ç»†
      async function showRewardDetailModal() {
        const modal = document.getElementById('rewardDetailModal');
        if (modal) {
          modal.style.display = 'flex';
          
          // åŠ è½½å¥–åŠ±æ˜ç»†
          try {
            const response = await userApiService.getRewards({ page: 1, pageSize: 100 });
            const tableBody = document.getElementById('rewardDetailTableModal');
            
            if (tableBody) {
              tableBody.innerHTML = '';
              
              if (response.success && response.data && response.data.list) {
                const rewards = response.data.list;
                
                if (rewards.length === 0) {
                  tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— å¥–åŠ±è®°å½•</td></tr>';
                } else {
                  rewards.forEach(reward => {
                    const row = document.createElement('tr');
                    const description = reward.description || '';
                    const isDirect = description.includes('ç›´æ¨');
                    const typeText = isDirect ? 'ç›´æ¨' : 'é—´æ¨';
                    const pointsChange = parseFloat(reward.pointsChange || 0);
                    
                    // ä»æè¿°ä¸­æå–ç”¨æˆ·åï¼ˆæ ¼å¼ï¼šç›´æ¨ä¸‹çº§ {user.name} æŠ¥å•å¥–åŠ± æˆ– é—´æ¨ä¸‹çº§ {user.name} æŠ¥å•å¥–åŠ±ï¼‰
                    let userName = '--';
                    if (description) {
                      // åŒ¹é… "ç›´æ¨ä¸‹çº§ å§“å æŠ¥å•å¥–åŠ±" æˆ– "é—´æ¨ä¸‹çº§ å§“å æŠ¥å•å¥–åŠ±"
                      const match = description.match(/(?:ç›´æ¨|é—´æ¨)ä¸‹çº§\s+([^\s]+)\s+æŠ¥å•å¥–åŠ±/);
                      if (match) {
                        userName = match[1].trim();
                      } else {
                        // å…¼å®¹æ—§æ ¼å¼ï¼šç”¨æˆ·ï¼šå§“å
                        const oldMatch = description.match(/ç”¨æˆ·[ï¼š:]([^ï¼Œ,ï¼Œ]+)/);
                        if (oldMatch) {
                          userName = oldMatch[1].trim();
                        }
                      }
                    }
                    
                    row.innerHTML = `
                      <td style="padding: 10px; border: 1px solid #ddd;">${reward.createdAt || '--'}</td>
                      <td style="padding: 10px; border: 1px solid #ddd;">${sanitizeInput(userName)}</td>
                      <td style="padding: 10px; border: 1px solid #ddd;">${typeText}</td>
                      <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #52c41a; font-weight: bold;">+${pointsChange.toFixed(2)}</td>
                    `;
                    tableBody.appendChild(row);
                  });
                }
              } else {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
              }
            }
          } catch (error) {
            console.error('åŠ è½½å¥–åŠ±æ˜ç»†å¤±è´¥:', error);
            const tableBody = document.getElementById('rewardDetailTableModal');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
            }
          }
        }
      }
      
      // åŠ è½½è®¢å•å†å²è®°å½•ï¼ˆæŒ‰æäº¤æ—¶é—´åˆ†ç»„æ±‡æ€»ï¼‰
      async function loadOrderHistory() {
        if (!userApiService.isAuthenticated()) {
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œç¡®ä¿å®æ—¶æ›´æ–°
        const container = document.getElementById('order-history-list');
        if (container) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">åŠ è½½ä¸­...</div>';
        }
        
        try {
          const date = document.getElementById('historyDate')?.value || '';
          const settlementDate = document.getElementById('settlementDateFilter')?.value || '';
          const statusFilter = document.getElementById('orderStatusFilter')?.value || '';
          const keyword = document.getElementById('orderKeywordSearch')?.value.trim() || '';
          
          const params = {};
          if (date) {
            params.queryDate = date;  // ä½¿ç”¨queryDateå‚æ•°ï¼ŒæŒ‰æäº¤æ—¶é—´æŸ¥è¯¢
          }
          if (settlementDate) {
            params.settlementDate = settlementDate;  // æŠ¥å•æ—¥æœŸç­›é€‰
          }
          if (statusFilter) {
            params.status = statusFilter;  // çŠ¶æ€ç­›é€‰
          }
          if (keyword) {
            params.keyword = keyword;  // å…³é”®è¯æœç´¢
          }
          
          const response = await userApiService.getOrders(params);
          if (response.success) {
            const summaryList = response.data.list || [];
            const statistics = response.data.statistics;
            const statsContainer = document.getElementById('order-statistics');
            
            // æ˜¾ç¤º/éšè—ç»Ÿè®¡ä¿¡æ¯ï¼ˆæœ‰æ—¥æœŸç­›é€‰æ—¶æ˜¾ç¤ºï¼‰
            if (statistics && (date || settlementDate)) {
              if (statsContainer) {
                statsContainer.style.display = 'block';
                document.getElementById('stat-submission-count').textContent = statistics.submissionCount || 0;
                document.getElementById('stat-total-quantity').textContent = statistics.totalQuantity || 0;
                document.getElementById('stat-total-points').textContent = (statistics.totalPoints || 0).toFixed(2);
              }
            } else {
              if (statsContainer) {
                statsContainer.style.display = 'none';
              }
            }
            
            if (summaryList.length === 0) {
              if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— è®¢å•è®°å½•</div>';
              }
              return;
            }
            
            // æ¸²æŸ“æ±‡æ€»å¡ç‰‡åˆ—è¡¨
            container.innerHTML = summaryList.map((summary, index) => {
              const dateLabel = summary.settlementDateShort || summary.settlementDate || 'æœªçŸ¥';
              return `
                <div class="order-summary-card" style="margin-bottom: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow: hidden;">
                  <div style="padding: 15px; cursor: pointer;" onclick="toggleOrderDetail(${index})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${dateLabel} è®¢å•${index + 1}</div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æäº¤æ—¶é—´: ${summary.submissionTime || '-'}</div>
                        <div style="font-size: 12px; color: #999;">æŠ¥å•æ—¥æœŸ: ${summary.settlementDate || '-'}</div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">æ•°é‡: <strong style="color: #28a745;">${summary.quantity}</strong></div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">é‡‘å¸: <strong style="color: #ff4d4f;">${summary.totalPoints.toFixed(2)}</strong></div>
                        <div style="font-size: 14px; color: #666;">ä¼˜æƒ å•ä»·: <strong style="color: #007bff;">${(summary.avgDiscountPrice || 0).toFixed(2)}</strong></div>
                      </div>
                      <div style="margin-left: 10px; color: #999;">
                        <span id="expand-icon-${index}">â–¼</span>
                      </div>
                    </div>
                  </div>
                  <div id="order-detail-${index}" style="display: none; padding: 15px; background: #f8f9fa; border-top: 1px solid #e9ecef;">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333;">è®¢å•è¯¦æƒ… (å…±${summary.orderCount}æ¡)</div>
                    ${summary.orders.map((order, orderIndex) => {
                      // åˆ¤æ–­è®¢å•çŠ¶æ€æ˜¾ç¤º
                      let statusText = 'å¾…å®¡æ ¸';
                      let statusColor = '#ff9800';
                      let hasException = order.hasException || false;
                      let exceptionStatus = order.exceptionStatus || null;
                      
                      if (hasException) {
                        if (exceptionStatus === 'exported') {
                          statusText = 'å¼‚å¸¸å·²å—ç†';
                          statusColor = '#4caf50';
                        } else {
                          statusText = 'å¼‚å¸¸å¾…å®¡æ ¸';
                          statusColor = '#ff5722';
                        }
                      } else if (order.exported || order.status === 'approved') {
                        statusText = 'å·²é€šè¿‡';
                        statusColor = '#4caf50';
                      } else if (order.status === 'pending') {
                        statusText = 'å¾…å®¡æ ¸';
                        statusColor = '#ff9800';
                      } else if (order.status === 'rejected') {
                        statusText = 'å·²æ‹’ç»';
                        statusColor = '#f44336';
                      }
                      
                      return `
                        <div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 3px solid #007bff;">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-weight: bold;">${order.nonMemberName || '-'}</div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                              <span style="padding: 2px 6px; background: ${statusColor}; color: white; border-radius: 4px; font-size: 11px;">${statusText}</span>
                              ${!hasException ? `<button onclick="openExceptionOrderModal(${order.id})" style="padding: 2px 8px; background: #ff5722; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">å¼‚å¸¸æŠ¥å•</button>` : ''}
                            </div>
                          </div>
                          <div style="font-size: 12px; color: #666;">
                            <div>æŠ¥å•æ—¥æœŸ: ${order.settlementDate || '-'}</div>
                            <div>æ•°é‡: ${order.quantity} | å•ä»·: ${order.finalPrice.toFixed(2)} | é‡‘å¸: <strong style="color: #ff4d4f;">${order.totalPoints.toFixed(2)}</strong></div>
                            ${order.nonMemberLink ? `<div style="margin-top: 3px;">é“¾æ¥: <a href="${order.nonMemberLink}" target="_blank" style="color: #007bff; word-break: break-all;">${order.nonMemberLink}</a></div>` : ''}
                            ${order.exceptionOrder ? `<div style="margin-top: 5px; padding: 5px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
                              <div style="font-weight: bold; margin-bottom: 3px;">å¼‚å¸¸è¯´æ˜ï¼š</div>
                              <div>${sanitizeInput(order.exceptionOrder.description)}</div>
                              ${order.exceptionOrder.imageUrls && order.exceptionOrder.imageUrls.length > 0 ? `
                                <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                                  ${order.exceptionOrder.imageUrls.map(url => `<img src="http://localhost:5000${url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="window.open('http://localhost:5000${url}', '_blank')" />`).join('')}
                                </div>
                              ` : ''}
                            </div>` : ''}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('');
          } else {
            document.getElementById('order-history-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">åŠ è½½å¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
          }
        } catch (error) {
          console.error('åŠ è½½è®¢å•å†å²å¤±è´¥:', error);
          document.getElementById('order-history-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
      }
      
      // åˆ‡æ¢è®¢å•è¯¦æƒ…æ˜¾ç¤º
      function toggleOrderDetail(index) {
        const detailDiv = document.getElementById(`order-detail-${index}`);
        const iconSpan = document.getElementById(`expand-icon-${index}`);
        
        if (detailDiv && iconSpan) {
          if (detailDiv.style.display === 'none') {
            detailDiv.style.display = 'block';
            iconSpan.textContent = 'â–²';
          } else {
            detailDiv.style.display = 'none';
            iconSpan.textContent = 'â–¼';
          }
        }
      }
      
      // æ‰“å¼€å¼‚å¸¸æŠ¥å•æ¨¡æ€æ¡†
      function openExceptionOrderModal(orderId) {
        document.getElementById('exceptionOrderId').value = orderId;
        document.getElementById('exceptionDescription').value = '';
        document.getElementById('exceptionImagePreview').innerHTML = '';
        document.getElementById('exceptionImageFiles').value = '';
        document.getElementById('exceptionOrderModal').style.display = 'flex';
      }
      
      // å…³é—­å¼‚å¸¸æŠ¥å•æ¨¡æ€æ¡†
      function closeExceptionOrderModal() {
        document.getElementById('exceptionOrderModal').style.display = 'none';
      }
      
      // é¢„è§ˆä¸Šä¼ çš„å›¾ç‰‡
      function previewExceptionImages(input) {
        const preview = document.getElementById('exceptionImagePreview');
        preview.innerHTML = '';
        
        if (input.files && input.files.length > 0) {
          for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.style.marginRight = '5px';
                img.style.marginBottom = '5px';
                preview.appendChild(img);
              };
              reader.readAsDataURL(file);
            }
          }
        }
      }
      
      // æäº¤å¼‚å¸¸è®¢å•
      async function submitExceptionOrder() {
        const orderId = document.getElementById('exceptionOrderId').value;
        const description = document.getElementById('exceptionDescription').value.trim();
        const imageInput = document.getElementById('exceptionImageFiles');
        
        if (!description) {
          showToast('è¯·å¡«å†™å¼‚å¸¸è¯´æ˜', 'error');
          return;
        }
        
        if (!orderId) {
          showToast('è®¢å•IDä¸å­˜åœ¨', 'error');
          return;
        }
        
        const images = imageInput.files;
        
        try {
          const response = await userApiService.submitExceptionOrder(orderId, description, images);
          
          if (response.success) {
            showToast('å¼‚å¸¸è®¢å•æäº¤æˆåŠŸ', 'success');
            closeExceptionOrderModal();
            // é‡æ–°åŠ è½½è®¢å•å†å²
            await loadOrderHistory();
          } else {
            showToast(response.message || 'æäº¤å¤±è´¥', 'error');
          }
        } catch (error) {
          console.error('æäº¤å¼‚å¸¸è®¢å•å¤±è´¥:', error);
          showToast('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
      }
      
      // ç­›é€‰å†å²è®¢å•ï¼ˆç›´æ¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºå¼¹çª—ï¼‰
      function filterHistoryOrders() {
        // ç›´æ¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºä»»ä½•æç¤º
        loadOrderHistory();
      }
      
      // ä¿®æ”¹ç™»å½•å¯†ç 
      async function confirmChangePassword() {
        const oldPassword = document.getElementById('old-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!oldPassword || !newPassword || !confirmPassword) {
          alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }
        
        if (newPassword.length < 6) {
          alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
          return;
        }
        
        try {
          const response = await userApiService.changePassword(oldPassword, newPassword);
          if (response.success) {
            alert('ä¿®æ”¹ç™»å½•å¯†ç æˆåŠŸ');
            document.getElementById('changePasswordModal').style.display = 'none';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
          } else {
            alert(response.message || 'ä¿®æ”¹ç™»å½•å¯†ç å¤±è´¥');
          }
        } catch (error) {
          console.error('ä¿®æ”¹ç™»å½•å¯†ç å¤±è´¥:', error);
          alert('ä¿®æ”¹ç™»å½•å¯†ç å¤±è´¥ï¼š' + error.message);
        }
      }
      
      // ä¿®æ”¹æ”¯ä»˜å¯†ç 
      async function confirmChangePayPassword() {
        const oldPassword = document.getElementById('old-pay-password').value;
        const newPassword = document.getElementById('new-pay-password').value;
        const confirmPassword = document.getElementById('confirm-pay-password').value;
        
        if (!oldPassword || !newPassword || !confirmPassword) {
          alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }
        
        if (!/^\d{6}$/.test(newPassword)) {
          alert('æ”¯ä»˜å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
          return;
        }
        
        try {
          const response = await userApiService.changePayPassword(oldPassword, newPassword);
          if (response.success) {
            alert('ä¿®æ”¹æ”¯ä»˜å¯†ç æˆåŠŸ');
            document.getElementById('changePayPasswordModal').style.display = 'none';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('old-pay-password').value = '';
            document.getElementById('new-pay-password').value = '';
            document.getElementById('confirm-pay-password').value = '';
          } else {
            alert(response.message || 'ä¿®æ”¹æ”¯ä»˜å¯†ç å¤±è´¥');
          }
        } catch (error) {
          console.error('ä¿®æ”¹æ”¯ä»˜å¯†ç å¤±è´¥:', error);
          alert('ä¿®æ”¹æ”¯ä»˜å¯†ç å¤±è´¥ï¼š' + error.message);
        }
      }
      
      // æäº¤å¼‚å¸¸æŠ¥å‘Š
      function submitExceptionReport() {
        const description = document.getElementById('exceptionDescription').value;
        const image = document.getElementById('exceptionImage').files[0];
        
        if (!description) {
          alert('è¯·å¡«å†™å¼‚å¸¸è¯´æ˜');
          return;
        }
        
        // æ¨¡æ‹Ÿæäº¤é€»è¾‘
        console.log('å¼‚å¸¸è¯´æ˜:', description);
        console.log('ä¸Šä¼ å›¾ç‰‡:', image);
        
        // å…³é—­å¼‚å¸¸æŠ¥é”™æ¨¡æ€æ¡†
        document.getElementById('exceptionReportModal').style.display = 'none';
        
        // æ˜¾ç¤ºæäº¤æˆåŠŸæ¨¡æ€æ¡†
        document.getElementById('exceptionSuccessModal').style.display = 'flex';
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('exceptionDescription').value = '';
        document.getElementById('exceptionImage').value = '';
      }
      
      // ç­›é€‰è®¢å•
      function filterOrders() {
        alert('ç­›é€‰è®¢å•åŠŸèƒ½å·²è§¦å‘');
      }
      
      // ç­›é€‰å†å²è®¢å•
    </script>
  </body>
</html>