# 云端问题排查指南

## 🎯 问题类型

当本地运行正常，但云端出现问题时的排查方法。

---

## 📋 排查步骤（按顺序执行）

### 第1步：检查服务状态

```bash
# SSH到服务器
ssh root@175.24.47.45

# 检查服务是否运行
systemctl status order-system

# 检查服务日志（最近50行）
journalctl -u order-system -n 50 --no-pager

# 检查端口是否监听
netstat -tlnp | grep 5000
```

**常见问题：**
- 服务未启动 → `systemctl start order-system`
- 端口被占用 → 查找并关闭占用进程
- 服务崩溃 → 查看日志找出错误

---

### 第2步：检查代码版本一致性

```bash
# 在服务器上检查Git状态
ssh root@175.24.47.45 "cd /var/www/order-system && git status"

# 检查最后一次提交
ssh root@175.24.47.45 "cd /var/www/order-system && git log -1"

# 对比本地和服务器代码
# 本地执行：
git log -1
# 服务器执行：
ssh root@175.24.47.45 "cd /var/www/order-system && git log -1"
```

**如果版本不一致：**
```bash
# 服务器拉取最新代码
ssh root@175.24.47.45 "cd /var/www/order-system && git pull origin master && systemctl restart order-system"
```

---

### 第3步：检查配置文件

```bash
# 检查生产环境配置
ssh root@175.24.47.45 "cat /var/www/order-system/backend/.env.production"

# 检查数据库连接
ssh root@175.24.47.45 "cd /var/www/order-system/backend && python3 -c 'from app import create_app; from models import db; app = create_app(); app.app_context().push(); db.engine.connect(); print(\"数据库连接成功\")'"
```

**常见问题：**
- 数据库配置错误
- 环境变量未加载
- 配置文件路径错误

---

### 第4步：检查API接口

```bash
# 测试API是否可访问
curl -X GET http://175.24.47.45/api/v1/user/register

# 测试登录接口（需要有效数据）
curl -X POST http://175.24.47.45/api/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'

# 检查API响应
curl -v http://175.24.47.45/api/v1/user/settings \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**常见问题：**
- API返回404 → 检查路由配置
- API返回500 → 查看服务器日志
- API返回401 → 检查Token或认证

---

### 第5步：检查前端文件

```bash
# 检查前端文件是否存在
ssh root@175.24.47.45 "ls -la /var/www/order-system/all_pages.html"

# 检查文件内容（前几行）
ssh root@175.24.47.45 "head -20 /var/www/order-system/all_pages.html"

# 检查文件大小（对比本地）
# 本地：
ls -lh all_pages.html
# 服务器：
ssh root@175.24.47.45 "ls -lh /var/www/order-system/all_pages.html"
```

---

### 第6步：检查浏览器控制台

**在浏览器中：**
1. 按 `F12` 打开开发者工具
2. 查看 `Console` 标签页的错误信息
3. 查看 `Network` 标签页的请求状态
4. 检查请求URL是否正确
5. 检查响应内容

**常见错误：**
- `Failed to fetch` → 后端服务未运行或网络问题
- `401 Unauthorized` → Token过期或无效
- `404 Not Found` → API路径错误
- `500 Internal Server Error` → 后端代码错误

---

### 第7步：对比本地和服务器代码

```bash
# 方法1：使用diff对比文件
diff all_pages.html <(ssh root@175.24.47.45 "cat /var/www/order-system/all_pages.html")

# 方法2：下载服务器文件对比
scp root@175.24.47.45:/var/www/order-system/all_pages.html ./all_pages.html.server
diff all_pages.html all_pages.html.server

# 方法3：检查关键函数
ssh root@175.24.47.45 "grep -n 'function handleLogin' /var/www/order-system/all_pages.html"
grep -n 'function handleLogin' all_pages.html
```

---

### 第8步：检查数据库数据

```bash
# 检查数据库连接
ssh root@175.24.47.45 "mysql -u order_user -pljx19921022.. order_system -e 'SELECT COUNT(*) FROM users;'"

# 检查管理员账户
ssh root@175.24.47.45 "mysql -u order_user -pljx19921022.. order_system -e 'SELECT * FROM admins;'"

# 检查系统设置
ssh root@175.24.47.45 "mysql -u order_user -pljx19921022.. order_system -e 'SELECT * FROM system_settings;'"
```

---

## 🔧 常见问题及解决方案

### 问题1：API返回404

**排查：**
```bash
# 检查路由注册
ssh root@175.24.47.45 "cd /var/www/order-system/backend && grep -r 'register_blueprint' ."

# 检查API路径
curl -v http://175.24.47.45/api/v1/user/login
```

**解决：**
- 检查 `backend/api/__init__.py` 是否导入所有路由
- 检查Nginx配置是否正确代理 `/api/`
- 重启服务

---

### 问题2：前端功能不工作

**排查：**
```bash
# 检查JavaScript错误
# 在浏览器控制台查看

# 检查函数是否存在
ssh root@175.24.47.45 "grep -n 'function handleLogin' /var/www/order-system/all_pages.html"
```

**解决：**
- 检查文件是否完整上传
- 检查浏览器缓存（Ctrl+F5强制刷新）
- 检查JavaScript语法错误

---

### 问题3：数据库连接失败

**排查：**
```bash
# 测试数据库连接
ssh root@175.24.47.45 "mysql -u order_user -pljx19921022.. order_system -e 'SELECT 1;'"

# 检查配置文件
ssh root@175.24.47.45 "cat /var/www/order-system/backend/.env.production"
```

**解决：**
- 检查数据库用户权限
- 检查数据库是否运行
- 检查配置文件中的密码

---

### 问题4：价格计算错误

**排查：**
```bash
# 检查系统设置
ssh root@175.24.47.45 "mysql -u order_user -pljx19921022.. order_system -e 'SELECT setting_value FROM system_settings WHERE setting_key=\"system_config\";'"

# 检查前端设置加载
# 在浏览器控制台执行：
console.log(backendSettings)
```

**解决：**
- 检查设置是否正确加载
- 检查折扣规则配置
- 检查价格计算函数

---

## 🛠️ 调试工具

### 1. 实时查看日志

```bash
# 实时查看服务日志
ssh root@175.24.47.45 "journalctl -u order-system -f"

# 查看最近100行日志
ssh root@175.24.47.45 "journalctl -u order-system -n 100 --no-pager"
```

### 2. 测试API接口

```bash
# 创建测试脚本
cat > test_api.sh << 'EOF'
#!/bin/bash
API_BASE="http://175.24.47.45/api/v1"

echo "测试用户注册接口..."
curl -X POST $API_BASE/user/register \
  -H "Content-Type: application/json" \
  -d '{"name":"测试","phone":"13900000000","password":"123456","payPassword":"123456","promoCode":"888888"}'

echo -e "\n\n测试用户登录接口..."
curl -X POST $API_BASE/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13900000000","password":"123456"}'
EOF

chmod +x test_api.sh
./test_api.sh
```

### 3. 对比文件差异

```bash
# 创建对比脚本
cat > compare_files.sh << 'EOF'
#!/bin/bash
FILE="all_pages.html"

echo "下载服务器文件..."
scp root@175.24.47.45:/var/www/order-system/$FILE ./${FILE}.server

echo "对比文件..."
diff -u $FILE ${FILE}.server > diff_${FILE}.txt

if [ $? -eq 0 ]; then
    echo "✅ 文件相同"
else
    echo "❌ 文件有差异，查看 diff_${FILE}.txt"
fi
EOF

chmod +x compare_files.sh
./compare_files.sh
```

---

## 📝 问题记录模板

遇到问题时，记录以下信息：

```
问题描述：
- 本地表现：
- 云端表现：
- 错误信息：

环境信息：
- 本地Git版本：
- 服务器Git版本：
- 浏览器：
- 操作系统：

排查结果：
- 服务状态：
- 日志信息：
- API测试结果：
- 代码对比结果：

解决方案：
```

---

## 🎯 快速排查清单

- [ ] 服务是否运行？
- [ ] 代码版本是否一致？
- [ ] 配置文件是否正确？
- [ ] API接口是否可访问？
- [ ] 前端文件是否完整？
- [ ] 浏览器控制台是否有错误？
- [ ] 数据库连接是否正常？
- [ ] 系统设置是否正确加载？

---

## 💡 最佳实践

1. **优先本地修改**：在本地测试通过后再部署
2. **保持版本一致**：定期同步本地和服务器代码
3. **记录修改日志**：每次修改都要提交Git
4. **测试后再部署**：重要修改先在测试环境验证
5. **保留调试信息**：添加必要的日志和错误处理

---

## 🚀 快速修复流程

```bash
# 1. 检查问题
ssh root@175.24.47.45 "journalctl -u order-system -n 50"

# 2. 如果代码问题，本地修复后推送
git add .
git commit -m "修复说明"
git push origin master

# 3. 服务器更新
ssh root@175.24.47.45 "cd /var/www/order-system && git pull origin master && systemctl restart order-system"

# 4. 验证修复
curl http://175.24.47.45/api/v1/user/register
```

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：
1. 具体的错误信息
2. 浏览器控制台截图
3. 服务器日志内容
4. 本地和服务器代码对比结果

