# 后台管理接口测试文档

## 目录
1. [环境准备](#环境准备)
2. [管理员登录](#管理员登录)
3. [会员管理接口](#会员管理接口)
4. [代理管理接口](#代理管理接口)
5. [订单管理接口](#订单管理接口)
6. [交易查询接口](#交易查询接口)
7. [异常订单接口](#异常订单接口)
8. [数据导出功能](#数据导出功能)
9. [统计接口](#统计接口)
10. [测试检查清单](#测试检查清单)

---

## 环境准备

### 1. 启动后端服务

```bash
cd backend
python app.py
```

后端服务默认运行在：`http://localhost:5000`

### 2. 初始化数据库

```bash
cd backend
python init_db.py
```

这将创建：
- 默认管理员账户（用户名：`admin`，密码：`admin123`）
- 平台用户（推广码：`888888`，作为平台代理的上级）

---

## 管理员登录

### 接口：`POST /api/v1/admin/login`

**请求体：**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "username": "admin",
      "name": "管理员",
      "role": "admin"
    }
  }
}
```

**测试命令：**
```bash
curl -X POST http://localhost:5000/api/v1/admin/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

**保存Token：**
登录成功后，将返回的`token`保存，后续所有请求都需要在请求头中添加：
```
Authorization: Bearer {token}
```

---

## 会员管理接口

### 1. 获取会员列表

**接口：** `GET /api/v1/admin/members`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**查询参数：**
- `page`: 页码（默认：1）
- `pageSize`: 每页数量（默认：20）
- `id`: 推广码（模糊查询）
- `phone`: 手机号（模糊查询）
- `date`: 注册日期（格式：YYYY-MM-DD）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": "123456",
        "name": "张三",
        "phone": "138****1234",
        "type": "普通会员",
        "parentId": "888888",
        "points": 1000.0,
        "registerDate": "2024-01-15",
        "todayOrders": 5,
        "monthOrders": 120,
        "nonmemberCount": 8
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

**测试命令：**
```bash
curl -X GET "http://localhost:5000/api/v1/admin/members?page=1&pageSize=20" \
  -H "Authorization: Bearer {admin_token}"
```

---

## 代理管理接口

### 1. 获取代理列表

**接口：** `GET /api/v1/admin/agents`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**查询参数：**
- `page`: 页码（默认：1）
- `pageSize`: 每页数量（默认：20）
- `id`: 推广码（模糊查询）
- `phone`: 手机号（模糊查询）
- `date`: 注册日期（格式：YYYY-MM-DD）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": "654321",
        "name": "王五",
        "phone": "137****9012",
        "type": "代理",
        "parentId": "888888",
        "points": 5000.0,
        "registerDate": "2024-01-15",
        "subAgents": 5,
        "subMembers": 24,
        "nonmemberCount": 15,
        "todayOrders": 15,
        "monthOrders": 450
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 20
  }
}
```

**测试命令：**
```bash
curl -X GET "http://localhost:5000/api/v1/admin/agents?page=1&pageSize=20" \
  -H "Authorization: Bearer {admin_token}"
```

### 2. 创建代理（新增代理）

**接口：** `POST /api/v1/admin/agents`

**请求头：**
```
Authorization: Bearer {admin_token}
Content-Type: application/json
```

**请求体：**
```json
{
  "name": "新代理",
  "phone": "13800138000"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "代理创建成功",
  "data": {
    "id": 10,
    "promoCode": "456789",
    "name": "新代理",
    "phone": "13800138000",
    "defaultPassword": "38000",
    "defaultPayPassword": "123456"
  }
}
```

**说明：**
- 创建的代理上级自动设置为平台（推广码：888888）
- 默认登录密码为手机号后6位
- 默认支付密码为：123456
- 系统会自动生成6位数字推广码

**测试命令：**
```bash
curl -X POST http://localhost:5000/api/v1/admin/agents \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "新代理",
    "phone": "13800138000"
  }'
```

### 3. 获取代理下级信息

**接口：** `GET /api/v1/admin/agents/{userId}/subordinates`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "nonmembers": [
      {
        "id": 1,
        "name": "非会员A",
        "link": "https://t.cn/R123456",
        "createdAt": "2024-01-15"
      }
    ],
    "ordinaryMembers": [
      {
        "id": "123456",
        "name": "普通会员A",
        "phone": "138****1234",
        "registerDate": "2024-01-15",
        "nonmemberCount": 5
      }
    ],
    "agentMembers": [
      {
        "id": "654321",
        "name": "代理会员A",
        "phone": "137****9012",
        "registerDate": "2024-01-15",
        "nonmemberCount": 10
      }
    ]
  }
}
```

**测试命令：**
```bash
curl -X GET http://localhost:5000/api/v1/admin/agents/1/subordinates \
  -H "Authorization: Bearer {admin_token}"
```

---

## 订单管理接口

### 1. 获取订单列表

**接口：** `GET /api/v1/admin/orders`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**查询参数：**
- `page`: 页码（默认：1）
- `pageSize`: 每页数量（默认：20）
- `id`: 推广码（模糊查询）
- `phone`: 手机号（模糊查询）
- `exported`: 是否已导出（true/false）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": 1,
        "promoCode": "123456",
        "name": "张三",
        "phone": "138****1234",
        "nonMemberName": "非会员A",
        "nonMemberLink": "https://t.cn/R123456",
        "points": 50.0,
        "createdAt": "2024-01-15 10:30:00",
        "exported": false
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

**测试命令：**
```bash
curl -X GET "http://localhost:5000/api/v1/admin/orders?page=1&pageSize=20" \
  -H "Authorization: Bearer {admin_token}"
```

### 2. 导出订单

**接口：** `POST /api/v1/admin/orders/export`

**请求头：**
```
Authorization: Bearer {admin_token}
Content-Type: application/json
```

**请求体：**
```json
{
  "orderIds": [1, 2, 3]
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "导出成功",
  "data": {
    "orders": [
      {
        "推广码": "123456",
        "姓名": "张三",
        "手机号": "13800138000",
        "直推用户姓名": "非会员A",
        "直推用户链接": "https://t.cn/R123456",
        "消耗金币": 50.0,
        "提交时间": "2024-01-15 10:30:00"
      }
    ],
    "count": 1
  }
}
```

**说明：**
- 导出的订单会自动标记为"已导出"（`exported = true`）
- 返回的数据可以直接用于生成Excel或CSV文件

**测试命令：**
```bash
curl -X POST http://localhost:5000/api/v1/admin/orders/export \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "orderIds": [1, 2, 3]
  }'
```

---

## 交易查询接口

### 1. 获取交易记录列表

**接口：** `GET /api/v1/admin/transactions`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**查询参数：**
- `page`: 页码（默认：1）
- `pageSize`: 每页数量（默认：20）
- `id`: 推广码（模糊查询）
- `phone`: 手机号（模糊查询）
- `type`: 交易类型（recharge, order_deduction, transfer_out, transfer_in, reward）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "promoCode": "123456",
        "name": "张三",
        "phone": "138****1234",
        "transactionType": "order_deduction",
        "pointsChange": -50.0,
        "balance": 950.0,
        "description": "报单扣除，日期: 2024-01-15, 数量: 1, 单价: 0.60, 折扣: 40%",
        "createdAt": "2024-01-15 10:30:00"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

**测试命令：**
```bash
curl -X GET "http://localhost:5000/api/v1/admin/transactions?page=1&pageSize=20&type=order_deduction" \
  -H "Authorization: Bearer {admin_token}"
```

---

## 异常订单接口

### 1. 获取异常订单列表

**接口：** `GET /api/v1/admin/exceptions`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**查询参数：**
- `page`: 页码（默认：1）
- `pageSize`: 每页数量（默认：20）
- `date`: 日期筛选（格式：YYYY-MM-DD）
- `status`: 处理状态（pending/processed）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": 1,
        "promoCode": "123456",
        "name": "张三",
        "phone": "138****1234",
        "nonMemberName": "非会员A",
        "nonMemberLink": "https://t.cn/R123456",
        "createdAt": "2024-01-15 10:30:00",
        "status": "待处理",
        "description": "订单异常，需要处理",
        "image": null
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20
  }
}
```

**测试命令：**
```bash
curl -X GET "http://localhost:5000/api/v1/admin/exceptions?page=1&pageSize=20&status=pending" \
  -H "Authorization: Bearer {admin_token}"
```

### 2. 导出异常订单

**接口：** `POST /api/v1/admin/exceptions/export`

**请求头：**
```
Authorization: Bearer {admin_token}
Content-Type: application/json
```

**请求体：**
```json
{
  "exceptionIds": [1, 2, 3]
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "导出成功",
  "data": {
    "exceptions": [
      {
        "推广码": "123456",
        "姓名": "张三",
        "手机号": "13800138000",
        "直推用户姓名": "非会员A",
        "直推用户链接": "https://t.cn/R123456",
        "提交时间": "2024-01-15 10:30:00",
        "异常说明": "订单异常，需要处理",
        "处理状态": "已处理"
      }
    ],
    "count": 1
  }
}
```

**说明：**
- 导出的异常订单会自动标记为"已处理"（`exported = true`）

**测试命令：**
```bash
curl -X POST http://localhost:5000/api/v1/admin/exceptions/export \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "exceptionIds": [1, 2, 3]
  }'
```

---

## 数据导出功能

### 导出格式说明

导出的数据为JSON格式，包含以下字段：

**订单导出字段：**
- 推广码
- 姓名
- 手机号
- 直推用户姓名
- 直推用户链接
- 消耗金币
- 提交时间

**异常订单导出字段：**
- 推广码
- 姓名
- 手机号
- 直推用户姓名
- 直推用户链接
- 提交时间
- 异常说明
- 处理状态

### 前端导出实现示例

```javascript
// 导出订单
async function exportOrders(orderIds) {
  const response = await apiService.exportOrders(orderIds);
  if (response.success) {
    // 将数据转换为CSV格式
    const csv = convertToCSV(response.data.orders);
    // 下载文件
    downloadFile(csv, '订单导出.csv');
  }
}

// 转换为CSV
function convertToCSV(data) {
  if (!data || data.length === 0) return '';
  
  const headers = Object.keys(data[0]);
  const rows = data.map(item => 
    headers.map(header => `"${item[header] || ''}"`).join(',')
  );
  
  return [headers.join(','), ...rows].join('\n');
}

// 下载文件
function downloadFile(content, filename) {
  const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
```

---

## 统计接口

### 1. 订单统计

**接口：** `GET /api/v1/admin/statistics/orders`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "todayTotal": 156,
    "todayUsers": 45,
    "todayPoints": 234.0
  }
}
```

**测试命令：**
```bash
curl -X GET http://localhost:5000/api/v1/admin/statistics/orders \
  -H "Authorization: Bearer {admin_token}"
```

### 2. 交易统计

**接口：** `GET /api/v1/admin/statistics/transactions`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "today": {
      "recharge": 5000.0,
      "revenue": 5000.0,
      "deduction": 2340.0
    },
    "month": {
      "recharge": 50000.0,
      "revenue": 50000.0,
      "deduction": 23400.0
    }
  }
}
```

**测试命令：**
```bash
curl -X GET http://localhost:5000/api/v1/admin/statistics/transactions \
  -H "Authorization: Bearer {admin_token}"
```

### 3. 异常订单统计

**接口：** `GET /api/v1/admin/statistics/exceptions`

**请求头：**
```
Authorization: Bearer {admin_token}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "todayExceptions": 10,
    "todayPending": 5,
    "todayProcessed": 5
  }
}
```

**测试命令：**
```bash
curl -X GET http://localhost:5000/api/v1/admin/statistics/exceptions \
  -H "Authorization: Bearer {admin_token}"
```

---

## 测试检查清单

### 管理员功能
- [ ] 管理员登录
- [ ] 获取会员列表（支持筛选）
- [ ] 获取代理列表（支持筛选）
- [ ] 创建代理（新增代理）
- [ ] 获取代理下级信息（非会员、普通会员、代理会员）
- [ ] 获取订单列表（支持筛选）
- [ ] 导出订单（标记为已导出）
- [ ] 获取交易记录列表（支持筛选）
- [ ] 获取异常订单列表（支持筛选）
- [ ] 导出异常订单（标记为已处理）
- [ ] 获取订单统计
- [ ] 获取交易统计
- [ ] 获取异常订单统计

### 数据验证
- [ ] 创建代理时验证手机号格式
- [ ] 创建代理时检查手机号是否已注册
- [ ] 创建的代理上级自动设置为平台（888888）
- [ ] 导出的订单自动标记为已导出
- [ ] 导出的异常订单自动标记为已处理

### 权限验证
- [ ] 所有接口需要管理员Token
- [ ] Token过期后自动清除
- [ ] 非管理员Token返回403错误

---

## 常见问题

### 1. Token无效或过期
**解决方法：** 重新登录获取新的Token

### 2. 平台用户不存在
**解决方法：** 运行 `python init_db.py` 初始化数据库

### 3. 创建代理失败（手机号已注册）
**解决方法：** 使用未注册的手机号，或先删除已存在的用户

### 4. 导出数据为空
**解决方法：** 确保选择了要导出的订单/异常订单ID

---

## 更新日志

### 2024-01-15
- ✅ 完成管理员登录接口
- ✅ 完成会员管理接口
- ✅ 完成代理管理接口（包括新增代理）
- ✅ 完成订单管理接口
- ✅ 完成交易查询接口
- ✅ 完成异常订单接口
- ✅ 完成数据导出功能
- ✅ 完成统计接口
- ✅ 创建平台用户（推广码888888）

---

## 注意事项

1. **平台用户**：系统初始化时会自动创建平台用户（推广码：888888），作为平台创建代理的上级
2. **默认密码**：新创建的代理默认登录密码为手机号后6位，支付密码为123456
3. **导出标记**：导出的订单和异常订单会自动标记为已导出/已处理
4. **数据精度**：所有金币相关数值保留2位小数
5. **分页**：所有列表接口支持分页，默认每页20条

