<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>私域报单系统 - 后台管理</title>
    <script src="api.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }
      
      .admin-container {
        display: flex;
        min-height: 100vh;
      }
      
      /* 侧边栏 */
      .sidebar {
        width: 250px;
        background: #001529;
        color: white;
        padding: 20px 0;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }
      
      .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }
      
      .sidebar-header h2 {
        font-size: 20px;
        font-weight: 600;
      }
      
      .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s;
        border-left: 3px solid transparent;
      }
      
      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      
      .menu-item.active {
        background: rgba(24, 144, 255, 0.2);
        border-left-color: #1890ff;
        color: #1890ff;
      }
      
      /* 主内容区 */
      .main-content {
        flex: 1;
        margin-left: 250px;
        padding: 20px 20px 20px 10px;
      }
      
      .page-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .page-header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 10px;
      }
      
      .page-content {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* 统计卡片 */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .stat-card.blue {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .stat-card.green {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      
      .stat-card.orange {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      
      .stat-card.purple {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
      }
      
      .stat-value {
        font-size: 28px;
        font-weight: 600;
      }
      
      /* 搜索筛选栏 */
      .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }
      
      .filter-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .filter-item label {
        font-size: 14px;
        white-space: nowrap;
      }
      
      .form-control {
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-size: 14px;
        min-width: 150px;
      }
      
      .form-control:focus {
        border-color: #40a9ff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }
      
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }
      
      .btn-primary {
        background: #1890ff;
        color: white;
      }
      
      .btn-primary:hover {
        background: #40a9ff;
      }
      
      .btn-danger {
        background: #ff4d4f;
        color: white;
      }
      
      .btn-danger:hover {
        background: #ff7875;
      }
      
      .btn-success {
        background: #52c41a;
        color: white;
      }
      
      .btn-success:hover {
        background: #73d13d;
      }
      
      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }
      
      .btn-secondary:hover {
        background: #d9d9d9;
      }
      
      /* 操作栏 */
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      /* 表格 */
      .table-container {
        overflow-x: auto;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
      }
      
      thead {
        background: #fafafa;
      }
      
      th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
      }
      
      th {
        font-weight: 600;
        color: #333;
      }
      
      tbody tr:hover {
        background: #fafafa;
      }
      
      .checkbox-cell {
        width: 50px;
        text-align: center;
      }
      
      /* 状态标签 */
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      
      .status-badge.ordinary {
        background: #e6f7ff;
        color: #1890ff;
      }
      
      .status-badge.agent {
        background: #f6ffed;
        color: #52c41a;
      }
      
      .status-badge.exported {
        background: #f6ffed;
        color: #52c41a;
      }
      
      .status-badge.unexported {
        background: #fff7e6;
        color: #fa8c16;
      }
      
      .status-badge.processed {
        background: #f6ffed;
        color: #52c41a;
      }
      
      .status-badge.pending {
        background: #fff1f0;
        color: #ff4d4f;
      }
      
      /* 分页 */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
      }
      
      .pagination button {
        padding: 6px 12px;
        border: 1px solid #d9d9d9;
        background: white;
        cursor: pointer;
        border-radius: 4px;
      }
      
      .pagination button:hover:not(:disabled) {
        border-color: #1890ff;
        color: #1890ff;
      }
      
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .pagination .active {
        background: #1890ff;
        color: white;
        border-color: #1890ff;
      }
      
      /* 模态框 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal.active {
        display: flex;
      }
      
      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modal-header h3 {
        font-size: 18px;
        font-weight: 600;
      }
      
      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        font-size: 14px;
      }
      
      /* 隐藏页面 */
      .page-section {
        display: none;
      }
      
      .page-section.active {
        display: block;
      }
      
      /* 登录页面样式 */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .login-box {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }
      
      .login-title {
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 30px;
        color: #333;
      }
      
      .error-message {
        color: #ff4d4f;
        font-size: 14px;
        margin-top: 5px;
        display: none;
      }
      
      .error-message.show {
        display: block;
      }
      
      /* 图片预览模态框 */
      .image-preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      
      .image-preview-modal.active {
        display: flex;
      }
      
      .image-preview-content {
        max-width: 90%;
        max-height: 90%;
      }
      
      .image-preview-content img {
        width: 100%;
        height: auto;
        border-radius: 4px;
      }
      
      /* 分页样式增强 */
      .pagination-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 20px;
      }
      
      .pagination-input {
        width: 60px;
        padding: 4px 8px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- 登录页面 -->
    <div id="login-page" class="login-container" style="display: none;">
      <div class="login-box">
        <h2 class="login-title">管理员登录</h2>
        <div class="form-group">
          <label>用户名</label>
          <input type="text" class="form-control" id="login-username" placeholder="请输入用户名" />
        </div>
        <div class="form-group">
          <label>密码</label>
          <input type="password" class="form-control" id="login-password" placeholder="请输入密码" />
        </div>
        <div class="error-message" id="login-error"></div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="handleLogin()">登录</button>
        <div style="margin-top: 15px; text-align: center; color: #999; font-size: 12px;">
          默认账号：admin / admin123
        </div>
      </div>
    </div>
    
    <div class="admin-container" id="admin-container" style="display: none;">
      <!-- 侧边栏 -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>后台管理</h2>
        </div>
        <div class="menu-item active" onclick="showPage('members')">会员管理</div>
        <div class="menu-item" onclick="showPage('agents')">代理管理</div>
        <div class="menu-item" onclick="showPage('orders')">报单管理</div>
        <div class="menu-item" onclick="showPage('transactions')">交易查询</div>
        <div class="menu-item" onclick="showPage('exceptions')">异常订单</div>
        <div class="menu-item" onclick="showPage('settings')">后台配置</div>
      </div>
      
      <!-- 主内容区 -->
      <div class="main-content">
        <!-- 会员管理 -->
        <div id="members-page" class="page-section active">
          <div class="page-header">
            <h1>会员管理</h1>
            <p>管理平台内所有普通会员</p>
          </div>
          
          <div class="page-content">
            <!-- 搜索筛选 -->
            <div class="filter-bar">
              <div class="filter-item">
                <label>推广码ID:</label>
                <input type="text" class="form-control" id="member-search-id" placeholder="输入推广码">
              </div>
              <div class="filter-item">
                <label>手机号:</label>
                <input type="text" class="form-control" id="member-search-phone" placeholder="输入手机号">
              </div>
              <div class="filter-item">
                <label>注册日期:</label>
                <input type="date" class="form-control" id="member-search-date">
              </div>
              <button class="btn btn-primary" onclick="searchMembers()">查询</button>
              <button class="btn btn-secondary" onclick="resetMemberSearch()">重置</button>
            </div>
            
            <!-- 操作栏 -->
            <div class="action-bar">
              <div class="action-buttons">
                <button class="btn btn-danger" onclick="batchDeleteMembers()">批量删除</button>
              </div>
              <div>
                <span>共 <strong id="member-total">0</strong> 条记录</span>
              </div>
            </div>
            
            <!-- 表格 -->
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="select-all-members" onchange="toggleSelectAllMembers()">
                    </th>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>会员类型</th>
                    <th>上级推广码</th>
                    <th>金币余额</th>
                    <th>注册日期</th>
                    <th>非会员数</th>
                    <th>今日报单数</th>
                    <th>本月累计报单数</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="members-table-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination" id="members-pagination"></div>
          </div>
        </div>
        
        <!-- 代理管理 -->
        <div id="agents-page" class="page-section">
          <div class="page-header">
            <h1>代理管理</h1>
            <p>管理平台内所有代理用户</p>
          </div>
          
          <div class="page-content">
            <!-- 搜索筛选 -->
            <div class="filter-bar">
              <div class="filter-item">
                <label>推广码ID:</label>
                <input type="text" class="form-control" id="agent-search-id" placeholder="输入推广码">
              </div>
              <div class="filter-item">
                <label>手机号:</label>
                <input type="text" class="form-control" id="agent-search-phone" placeholder="输入手机号">
              </div>
              <div class="filter-item">
                <label>注册日期:</label>
                <input type="date" class="form-control" id="agent-search-date">
              </div>
              <button class="btn btn-primary" onclick="searchAgents()">查询</button>
              <button class="btn btn-secondary" onclick="resetAgentSearch()">重置</button>
            </div>
            
            <!-- 操作栏 -->
            <div class="action-bar">
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddAgentModal()">新增代理</button>
                <button class="btn btn-danger" onclick="batchDeleteAgents()">批量删除</button>
              </div>
              <div>
                <span>共 <strong id="agent-total">0</strong> 条记录</span>
              </div>
            </div>
            
            <!-- 表格 -->
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="select-all-agents" onchange="toggleSelectAllAgents()">
                    </th>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>会员类型</th>
                    <th>上级推广码</th>
                    <th>金币余额</th>
                    <th>注册日期</th>
                    <th>下级代理数</th>
                    <th>下级会员数</th>
                    <th>非会员数</th>
                    <th>今日报单数</th>
                    <th>本月累计报单数</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="agents-table-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination" id="agents-pagination"></div>
          </div>
        </div>
        
        <!-- 报单管理 -->
        <div id="orders-page" class="page-section">
          <div class="page-header">
            <h1>报单管理</h1>
            <p>展示和管理所有会员和代理的报单信息</p>
          </div>
          
          <div class="page-content">
            <!-- 数据统计 -->
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-label">今日报单总量</div>
                <div class="stat-value" id="today-order-total">0</div>
              </div>
              <div class="stat-card green">
                <div class="stat-label">今日报单总人数</div>
                <div class="stat-value" id="today-order-users">0</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-label">今日消耗总金币</div>
                <div class="stat-value" id="today-order-points">0</div>
              </div>
            </div>
            
            <!-- 搜索筛选 -->
            <div class="filter-bar">
              <div class="filter-item">
                <label>报单日期:</label>
                <input type="date" class="form-control" id="order-search-date" placeholder="选择报单日期">
              </div>
              <div class="filter-item">
                <label>推广码ID:</label>
                <input type="text" class="form-control" id="order-search-id" placeholder="输入推广码">
              </div>
              <div class="filter-item">
                <label>手机号:</label>
                <input type="text" class="form-control" id="order-search-phone" placeholder="输入手机号">
              </div>
              <div class="filter-item">
                <label>导出状态:</label>
                <select class="form-control" id="order-search-export">
                  <option value="">全部</option>
                  <option value="exported">已导出</option>
                  <option value="unexported">未导出</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="searchOrders()">查询</button>
              <button class="btn btn-secondary" onclick="resetOrderSearch()">重置</button>
            </div>
            
            <!-- 操作栏 -->
            <div class="action-bar">
              <div class="action-buttons">
                <button class="btn btn-success" onclick="exportSelectedOrders()">导出选中</button>
              </div>
              <div>
                <span>共 <strong id="order-total">0</strong> 条记录</span>
              </div>
            </div>
            
            <!-- 表格 -->
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="select-all-orders" onchange="toggleSelectAllOrders()">
                    </th>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>报单日期</th>
                    <th>直推用户姓名</th>
                    <th>直推用户碰碰链接</th>
                    <th>消耗金币</th>
                    <th>提交时间</th>
                    <th>导出状态</th>
                  </tr>
                </thead>
                <tbody id="orders-table-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination" id="orders-pagination"></div>
          </div>
        </div>
        
        <!-- 交易查询 -->
        <div id="transactions-page" class="page-section">
          <div class="page-header">
            <h1>交易查询</h1>
            <p>显示平台充值信息和所有用户消费记录</p>
          </div>
          
          <div class="page-content">
            <!-- 数据统计 -->
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-label">今日充值金币</div>
                <div class="stat-value" id="today-recharge">0</div>
              </div>
              <div class="stat-card green">
                <div class="stat-label">今日收益（人民币）</div>
                <div class="stat-value" id="today-revenue">¥0</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-label">今日消耗总金币</div>
                <div class="stat-value" id="today-consumption">0</div>
              </div>
              <div class="stat-card purple">
                <div class="stat-label">本月充值金币</div>
                <div class="stat-value" id="month-recharge">0</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-label">本月收益</div>
                <div class="stat-value" id="month-revenue">¥0</div>
              </div>
              <div class="stat-card green">
                <div class="stat-label">本月消耗总金币</div>
                <div class="stat-value" id="month-consumption">0</div>
              </div>
            </div>
            
            <!-- 搜索筛选 -->
            <div class="filter-bar">
              <div class="filter-item">
                <label>推广码ID:</label>
                <input type="text" class="form-control" id="transaction-search-id" placeholder="输入推广码">
              </div>
              <div class="filter-item">
                <label>手机号:</label>
                <input type="text" class="form-control" id="transaction-search-phone" placeholder="输入手机号">
              </div>
              <div class="filter-item">
                <label>交易类型:</label>
                <select class="form-control" id="transaction-search-type">
                  <option value="">全部</option>
                  <option value="recharge">充值</option>
                  <option value="order_deduct">报单扣除</option>
                  <option value="transfer_out">转账支出</option>
                  <option value="transfer_in">转账收益</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="searchTransactions()">查询</button>
              <button class="btn btn-secondary" onclick="resetTransactionSearch()">重置</button>
            </div>
            
            <!-- 表格 -->
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>交易类型</th>
                    <th>积分变动</th>
                    <th>交易余额</th>
                    <th>交易时间</th>
                    <th>描述</th>
                  </tr>
                </thead>
                <tbody id="transactions-table-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination" id="transactions-pagination"></div>
          </div>
        </div>
        
        <!-- 异常订单查询 -->
        <div id="exceptions-page" class="page-section">
          <div class="page-header">
            <h1>异常订单查询</h1>
            <p>处理和管理异常订单</p>
          </div>
          
          <div class="page-content">
            <!-- 数据统计 -->
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-label">今日异常订单</div>
                <div class="stat-value" id="today-exceptions">0</div>
              </div>
              <div class="stat-card green">
                <div class="stat-label">今日待处理</div>
                <div class="stat-value" id="today-pending">0</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-label">今日已处理</div>
                <div class="stat-value" id="today-processed">0</div>
              </div>
            </div>
            
            <!-- 搜索筛选 -->
            <div class="filter-bar">
              <div class="filter-item">
                <label>日期筛选:</label>
                <input type="date" class="form-control" id="exception-search-date">
              </div>
              <div class="filter-item">
                <label>处理状态:</label>
                <select class="form-control" id="exception-search-status">
                  <option value="">全部</option>
                  <option value="pending">待处理</option>
                  <option value="processed">已处理</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="searchExceptions()">查询</button>
              <button class="btn btn-secondary" onclick="resetExceptionSearch()">重置</button>
            </div>
            
            <!-- 操作栏 -->
            <div class="action-bar">
              <div class="action-buttons">
                <button class="btn btn-success" onclick="exportSelectedExceptions()">导出选中</button>
              </div>
              <div>
                <span>共 <strong id="exception-total">0</strong> 条记录</span>
              </div>
            </div>
            
            <!-- 表格 -->
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="select-all-exceptions" onchange="toggleSelectAllExceptions()">
                    </th>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>直推用户姓名</th>
                    <th>直推用户碰碰链接</th>
                    <th>提交时间</th>
                    <th>异常说明</th>
                    <th>图片</th>
                    <th>处理状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="exceptions-table-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination" id="exceptions-pagination"></div>
          </div>
        </div>
        
        <!-- 后台配置 -->
        <div id="settings-page" class="page-section">
          <div class="page-header">
            <h1>后台配置</h1>
            <p>系统配置和参数设置</p>
          </div>
          
          <div class="page-content">
            <!-- 商家联系方式 -->
            <div style="margin-bottom: 30px;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">商家联系方式</h2>
              <div class="form-group">
                <label>客服微信</label>
                <input type="text" class="form-control" id="setting-wechat" placeholder="请输入客服微信">
              </div>
              <div class="form-group">
                <label>客服电话</label>
                <input type="text" class="form-control" id="setting-phone" placeholder="请输入客服电话">
              </div>
              <div class="form-group">
                <label>QQ群</label>
                <input type="text" class="form-control" id="setting-qq" placeholder="请输入QQ群">
              </div>
              <button class="btn btn-primary" onclick="saveContactSettings()">保存联系方式</button>
            </div>
            
            <!-- 报单消耗金币配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">报单消耗金币配置</h2>
              <div class="form-group">
                <label>默认基础单价（金币）</label>
                <input type="number" step="0.1" class="form-control" id="setting-base-price" placeholder="请输入默认基础单价">
                <small style="color: #999;">非周五的报单基础单价</small>
              </div>
              <div class="form-group">
                <label>周五基础单价（金币）</label>
                <input type="number" step="0.1" class="form-control" id="setting-friday-price" placeholder="请输入周五基础单价">
                <small style="color: #999;">周五的报单基础单价</small>
              </div>
              <button class="btn btn-primary" onclick="savePriceSettings()">保存价格设置</button>
            </div>
            
            <!-- 金币与现金兑换配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">金币与现金兑换配置</h2>
              <div class="form-group">
                <label>现金兑换比例（元/金币）</label>
                <input type="number" step="0.1" class="form-control" id="setting-coin-exchange-rate" placeholder="请输入兑换比例，例如：10表示10元=1金币">
                <small style="color: #999;">代理从平台购买金币时的基础兑换比例，默认10元=1金币</small>
              </div>
              <button class="btn btn-primary" onclick="saveExchangeRateSettings()">保存兑换比例</button>
            </div>
            
            <!-- 报单优惠规则配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">报单优惠规则配置</h2>
              <div id="discount-rules-container">
                <!-- 优惠规则将通过JavaScript动态生成 -->
              </div>
              <button class="btn btn-success" onclick="addDiscountRule()" style="margin-top: 10px;">添加优惠规则</button>
              <button class="btn btn-primary" onclick="saveDiscountSettings()" style="margin-top: 10px;">保存优惠规则</button>
            </div>
            
            <!-- 充值金币优惠配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">充值金币优惠配置</h2>
              <div id="recharge-discount-rules-container">
                <!-- 充值优惠规则将通过JavaScript动态生成 -->
              </div>
              <button class="btn btn-success" onclick="addRechargeDiscountRule()" style="margin-top: 10px;">添加充值优惠规则</button>
              <button class="btn btn-primary" onclick="saveRechargeDiscountSettings()" style="margin-top: 10px;">保存充值优惠规则</button>
              <div style="margin-top: 10px; color: #999; font-size: 13px;">
                说明：例如充值100优惠98折，表示充值100金币时，实际收取98%的现金（即98元，假设1金币=1元）
              </div>
            </div>
            
            <!-- 奖励比例配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">奖励比例配置</h2>
              <div class="form-group">
                <label>直推奖励比例（%）</label>
                <input type="number" step="0.1" class="form-control" id="setting-direct-reward" placeholder="请输入直推奖励比例">
                <small style="color: #999;">代理用户可获得下级当日实付金币的奖励比例</small>
              </div>
              <div class="form-group">
                <label>间推奖励比例（%）</label>
                <input type="number" step="0.1" class="form-control" id="setting-indirect-reward" placeholder="请输入间推奖励比例">
                <small style="color: #999;">代理用户可获得下下级当日实付金币的奖励比例</small>
              </div>
              <button class="btn btn-primary" onclick="saveRewardSettings()">保存奖励设置</button>
            </div>
            
            <!-- 转账限制配置 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">转账限制配置</h2>
              <div class="form-group">
                <label>最低转账数量</label>
                <input type="number" class="form-control" id="setting-min-quantity" placeholder="请输入最低转账数量">
                <small style="color: #999;">代理给下级转账时，数量不能低于此值</small>
              </div>
              <div class="form-group">
                <label>最高转账单价（元/金币）</label>
                <input type="number" step="0.1" class="form-control" id="setting-max-price" placeholder="请输入最高转账单价">
                <small style="color: #999;">代理给下级转账时，单价不能高于此值</small>
              </div>
              <button class="btn btn-primary" onclick="saveTransferSettings()">保存转账设置</button>
            </div>
            
            
            <!-- 数据备份与恢复 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">数据备份与恢复</h2>
              <div class="action-buttons" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="backupData()">创建数据备份</button>
                <button class="btn btn-primary" onclick="showBackupList()">查看备份列表</button>
              </div>
              <div id="backup-list-container" style="display: none;">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>备份时间</th>
                        <th>备份文件</th>
                        <th>文件大小</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="backup-list-body">
                      <!-- 备份列表将通过JavaScript动态填充 -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- 系统通知管理 -->
            <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
              <h2 style="margin-bottom: 15px; font-size: 18px;">系统通知管理</h2>
              <div class="action-buttons" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showSendNotificationModal()">发送通知</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>通知标题</th>
                      <th>通知内容</th>
                      <th>发送时间</th>
                      <th>接收对象</th>
                      <th>状态</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="notification-list-body">
                    <!-- 通知列表将通过JavaScript动态填充 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 更换上级 -->
    <div class="modal" id="change-parent-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>更换上级</h3>
          <button class="modal-close" onclick="closeModal('change-parent-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新的上级推广码ID</label>
            <input type="text" class="form-control" id="new-parent-id" placeholder="请输入新的上级推广码">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('change-parent-modal')">取消</button>
          <button class="btn btn-primary" onclick="confirmChangeParent()">确认更换</button>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 查看订单详情 -->
    <div class="modal" id="order-detail-modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3>订单详情</h3>
          <button class="modal-close" onclick="closeModal('order-detail-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="filter-bar">
            <div class="filter-item">
              <label>开始日期:</label>
              <input type="date" class="form-control" id="order-detail-start-date">
            </div>
            <div class="filter-item">
              <label>结束日期:</label>
              <input type="date" class="form-control" id="order-detail-end-date">
            </div>
            <div class="filter-item">
              <label>订单状态:</label>
              <select class="form-control" id="order-detail-status">
                <option value="">全部</option>
                <option value="approved">已通过</option>
                <option value="pending">待审核</option>
                <option value="rejected">已拒绝</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="filterOrderDetail()">筛选</button>
            <button class="btn btn-secondary" onclick="resetOrderDetailFilter()">重置</button>
          </div>
          <div class="table-container" style="margin-top: 20px;">
            <table>
              <thead>
                <tr>
                  <th>报单日期</th>
                  <th>直推用户</th>
                  <th>消耗金币</th>
                  <th>状态</th>
                </tr>
              </thead>
              <tbody id="order-detail-table-body">
                <!-- 数据将通过JavaScript动态填充 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('order-detail-modal')">关闭</button>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 充值 -->
    <div class="modal" id="recharge-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>充值金币</h3>
          <button class="modal-close" onclick="closeModal('recharge-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>充值金币数量</label>
            <input type="number" class="form-control" id="recharge-amount" placeholder="请输入充值金币数量" oninput="calculateRechargeCash()">
          </div>
          <div class="form-group">
            <label>需要收取的现金（元）</label>
            <input type="text" class="form-control" id="recharge-cash" placeholder="自动计算" readonly style="background-color: #f5f5f5; font-weight: 600; color: #ff4d4f;">
            <small style="color: #999;" id="recharge-discount-info"></small>
          </div>
          <div class="form-group">
            <label>管理员密码</label>
            <input type="password" class="form-control" id="admin-password" placeholder="请输入管理员密码">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('recharge-modal')">取消</button>
          <button class="btn btn-primary" onclick="confirmRecharge()">确认充值</button>
        </div>
      </div>
    </div>
    
    
    <!-- 模态框 - 查看代理详情 -->
    <div class="modal" id="agent-detail-modal">
      <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
          <h3>会员详情 - 下级信息</h3>
          <button class="modal-close" onclick="closeModal('agent-detail-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Tab切换 -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0;">
            <div style="padding: 10px 20px; cursor: pointer; border-bottom: 2px solid #1890ff; color: #1890ff; font-weight: 500;" id="agent-detail-tab-nonmember" onclick="switchAgentDetailTab('nonmember')">非会员</div>
            <div style="padding: 10px 20px; cursor: pointer; color: #666;" id="agent-detail-tab-ordinary" onclick="switchAgentDetailTab('ordinary')">普通会员</div>
            <div style="padding: 10px 20px; cursor: pointer; color: #666;" id="agent-detail-tab-agent" onclick="switchAgentDetailTab('agent')">代理会员</div>
          </div>
          
          <!-- 非会员列表 -->
          <div id="agent-detail-nonmember" class="agent-detail-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>姓名</th>
                    <th>碰碰链接</th>
                    <th>添加时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="agent-detail-nonmember-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- 普通会员列表 -->
          <div id="agent-detail-ordinary" class="agent-detail-content" style="display: none;">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>注册日期</th>
                    <th>非会员数</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="agent-detail-ordinary-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- 代理会员列表 -->
          <div id="agent-detail-agent" class="agent-detail-content" style="display: none;">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>注册日期</th>
                    <th>非会员数</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="agent-detail-agent-body">
                  <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('agent-detail-modal')">关闭</button>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 发送系统通知 -->
    <div class="modal" id="send-notification-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>发送系统通知</h3>
          <button class="modal-close" onclick="closeModal('send-notification-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>通知标题</label>
            <input type="text" class="form-control" id="notification-title" placeholder="请输入通知标题">
          </div>
          <div class="form-group">
            <label>通知内容</label>
            <textarea class="form-control" id="notification-content" rows="4" placeholder="请输入通知内容"></textarea>
          </div>
          <div class="form-group">
            <label>接收对象</label>
            <select class="form-control" id="notification-target">
              <option value="all">全部用户</option>
              <option value="agents">代理用户</option>
              <option value="members">普通会员</option>
              <option value="specific">指定用户</option>
            </select>
          </div>
          <div class="form-group" id="specific-user-group" style="display: none;">
            <label>用户推广码/手机号（多个用逗号分隔）</label>
            <input type="text" class="form-control" id="notification-users" placeholder="例如：123456,234567 或 138****1234,139****5678">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('send-notification-modal')">取消</button>
          <button class="btn btn-primary" onclick="sendNotification()">发送通知</button>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 查看会员详情 -->
    <div class="modal" id="member-detail-modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3>会员详情</h3>
          <button class="modal-close" onclick="closeModal('member-detail-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                    <th>推广码</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>注册日期</th>
                    <th>非会员数</th>
                    <th>操作</th>
                </tr>
              </thead>
              <tbody id="member-detail-table-body">
                <!-- 数据将通过JavaScript动态填充 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('member-detail-modal')">关闭</button>
        </div>
      </div>
    </div>
    
    <!-- 模态框 - 新增代理 -->
    <div class="modal" id="add-agent-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>新增代理</h3>
          <button class="modal-close" onclick="closeModal('add-agent-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>代理姓名 <span style="color: red;">*</span></label>
            <input type="text" class="form-control" id="add-agent-name" placeholder="请输入代理姓名">
          </div>
          <div class="form-group">
            <label>手机号 <span style="color: red;">*</span></label>
            <input type="text" class="form-control" id="add-agent-phone" placeholder="请输入11位手机号" maxlength="11">
            <small style="color: #999;">平台创建的代理，上级为平台（推广码：888888）</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('add-agent-modal')">取消</button>
          <button class="btn btn-primary" onclick="confirmAddAgent()">确认添加</button>
        </div>
      </div>
    </div>
    
    <script>
      // 当前选中的用户ID（用于操作）
      let currentSelectedId = null;
      let currentSelectedType = null; // 'member' 或 'agent'
      
      // 页面切换
      function showPage(pageId) {
        // 隐藏所有页面
        document.querySelectorAll('.page-section').forEach(page => {
          page.classList.remove('active');
        });
        
        // 显示指定页面
        document.getElementById(pageId + '-page').classList.add('active');
        
        // 更新菜单高亮
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 加载页面数据
        loadPageData(pageId);
      }
      
      // 加载页面数据
      function loadPageData(pageId) {
        switch(pageId) {
          case 'members':
            loadMembersData();
            break;
          case 'agents':
            loadAgentsData();
            break;
          case 'orders':
            loadOrdersData();
            break;
          case 'transactions':
            loadTransactionsData();
            break;
          case 'exceptions':
            loadExceptionsData();
            break;
          case 'settings':
            loadSettingsData();
            break;
        }
      }
      
      // 加载会员数据（使用API）
      async function loadMembersData() {
        const config = paginationConfig.members;
        const params = {
          page: config.page,
          pageSize: config.pageSize,
          id: document.getElementById('member-search-id')?.value || '',
          phone: document.getElementById('member-search-phone')?.value || '',
          date: document.getElementById('member-search-date')?.value || ''
        };
        
        try {
          const response = await apiService.getMembers(params);
          if (response.success) {
            config.total = response.data.total;
            renderMembersTable(response.data.list);
            renderPagination('members', config);
            document.getElementById('member-total').textContent = response.data.total;
          } else {
            alert(response.message || '加载会员数据失败');
          }
        } catch (error) {
          console.error('加载会员数据失败:', error);
          alert('加载会员数据失败：' + error.message);
        }
      }
      
      // 渲染会员表格
      function renderMembersTable(data) {
        const tbody = document.getElementById('members-table-body');
        tbody.innerHTML = data.map(item => `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" class="member-checkbox" value="${item.id}">
            </td>
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.phone}</td>
            <td><span class="status-badge ordinary">${item.type}</span></td>
            <td>${item.parentId || '-'}</td>
            <td>${item.points}</td>
            <td>${item.registerDate}</td>
            <td>${item.nonmemberCount || 0}</td>
            <td>${item.todayOrders}</td>
            <td>${item.monthOrders}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="viewMemberOrders('${item.id}')">订单详情</button>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="changeParent('${item.id}', 'member')">更换上级</button>
              <button class="btn btn-info" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="resetPassword('${item.id}', 'member')">重置登录密码</button>
              <button class="btn btn-info" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="resetPayPassword('${item.id}', 'member')">重置支付密码</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteMember('${item.id}')">删除</button>
            </td>
          </tr>
        `).join('');
      }
      
      // 加载代理数据（使用API）
      async function loadAgentsData() {
        const config = paginationConfig.agents;
        const params = {
          page: config.page,
          pageSize: config.pageSize,
          id: document.getElementById('agent-search-id')?.value || '',
          phone: document.getElementById('agent-search-phone')?.value || '',
          date: document.getElementById('agent-search-date')?.value || ''
        };
        
        try {
          const response = await apiService.getAgents(params);
          if (response.success) {
            config.total = response.data.total;
            renderAgentsTable(response.data.list);
            renderPagination('agents', config);
            document.getElementById('agent-total').textContent = response.data.total;
          } else {
            alert(response.message || '加载代理数据失败');
          }
        } catch (error) {
          console.error('加载代理数据失败:', error);
          alert('加载代理数据失败：' + error.message);
        }
      }
      
      // 渲染代理表格
      function renderAgentsTable(data) {
        const tbody = document.getElementById('agents-table-body');
        tbody.innerHTML = data.map(item => `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" class="agent-checkbox" value="${item.id}">
            </td>
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.phone}</td>
            <td><span class="status-badge agent">${item.type}</span></td>
            <td>${item.parentId || '-'}</td>
            <td>${item.points}</td>
            <td>${item.registerDate}</td>
            <td>${item.subAgents}</td>
            <td>${item.subMembers}</td>
            <td>${item.nonmemberCount || 0}</td>
            <td>${item.todayOrders}</td>
            <td>${item.monthOrders}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="viewAgentOrders('${item.id}')">订单详情</button>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="viewAgentDetail('${item.id}')">会员详情</button>
              <button class="btn btn-success" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="rechargeAgent('${item.id}')">充值</button>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="changeParent('${item.id}', 'agent')">更换上级</button>
              <button class="btn btn-info" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="resetPassword('${item.id}', 'agent')">重置登录密码</button>
              <button class="btn btn-info" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="resetPayPassword('${item.id}', 'agent')">重置支付密码</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteAgent('${item.id}')">删除</button>
            </td>
          </tr>
        `).join('');
      }
      
      // 加载报单数据（使用API）
      async function loadOrdersData() {
        const config = paginationConfig.orders;
        const params = {
          page: config.page,
          pageSize: config.pageSize,
          settlementDate: document.getElementById('order-search-date')?.value || '',
          id: document.getElementById('order-search-id')?.value || '',
          phone: document.getElementById('order-search-phone')?.value || '',
          exported: document.getElementById('order-search-export')?.value || ''
        };
        
        try {
          const response = await apiService.getOrders(params);
          if (response.success) {
            config.total = response.data.total;
            renderOrdersTable(response.data.list);
            renderPagination('orders', config);
            document.getElementById('order-total').textContent = response.data.total;
          } else {
            alert(response.message || '加载订单数据失败');
          }
          
          // 加载统计数据
          const statsResponse = await apiService.getOrderStatistics();
          if (statsResponse.success) {
            const stats = statsResponse.data;
            document.getElementById('today-order-total').textContent = stats.todayTotal || 0;
            document.getElementById('today-order-users').textContent = stats.todayUsers || 0;
            document.getElementById('today-order-points').textContent = stats.todayPoints || 0;
          }
        } catch (error) {
          console.error('加载订单数据失败:', error);
          alert('加载订单数据失败：' + error.message);
        }
      }
      
      // 渲染报单表格
      function renderOrdersTable(data) {
        const tbody = document.getElementById('orders-table-body');
        tbody.innerHTML = data.map(item => `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" class="order-checkbox" value="${item.id}">
            </td>
            <td>${item.promoCode}</td>
            <td>${item.name}</td>
            <td>${item.phone}</td>
            <td>${item.settlementDate || '-'}</td>
            <td>${item.nonMemberName || '-'}</td>
            <td><a href="${item.nonMemberLink || '#'}" target="_blank" style="display: inline-block; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.nonMemberLink || '-'}">${item.nonMemberLink ? (item.nonMemberLink.length > 30 ? item.nonMemberLink.substring(0, 30) + '...' : item.nonMemberLink) : '-'}</a></td>
            <td>${item.points.toFixed(2)}</td>
            <td>${item.createdAt || '-'}</td>
            <td>
              <span class="status-badge ${item.exported ? 'exported' : 'unexported'}">
                ${item.exported ? '已导出' : '未导出'}
              </span>
            </td>
          </tr>
        `).join('');
      }
      
      // 加载交易数据
      async function loadTransactionsData() {
        const config = paginationConfig.transactions;
        const params = {
          page: config.page,
          pageSize: config.pageSize,
          id: document.getElementById('transaction-search-id')?.value || '',
          phone: document.getElementById('transaction-search-phone')?.value || '',
          type: document.getElementById('transaction-search-type')?.value || ''
        };
        
        try {
          const response = await apiService.getTransactions(params);
          if (response.success) {
            config.total = response.data.total;
            renderTransactionsTable(response.data.list);
            renderPagination('transactions', config);
          } else {
            alert(response.message || '加载交易数据失败');
          }
          
          // 加载统计数据
          const statsResponse = await apiService.getTransactionStatistics();
          if (statsResponse.success) {
            const stats = statsResponse.data;
            document.getElementById('today-recharge').textContent = stats.today?.recharge || 0;
            document.getElementById('today-revenue').textContent = '¥' + (stats.today?.revenue || 0);
            document.getElementById('today-consumption').textContent = stats.today?.deduction || 0;
            document.getElementById('month-recharge').textContent = stats.month?.recharge || 0;
            document.getElementById('month-revenue').textContent = '¥' + (stats.month?.revenue || 0);
            document.getElementById('month-consumption').textContent = stats.month?.deduction || 0;
          }
        } catch (error) {
          console.error('加载交易数据失败:', error);
          alert('加载交易数据失败：' + error.message);
        }
      }
      
      // 渲染交易表格
      function renderTransactionsTable(data) {
        const tbody = document.getElementById('transactions-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">暂无数据</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.map(item => {
          const pointsChange = parseFloat(item.pointsChange);
          const isPositive = pointsChange > 0;
          const typeMap = {
            'recharge': '充值',
            'order_deduction': '报单扣除',
            'transfer_out': '转账支出',
            'transfer_in': '转账收益',
            'reward': '奖励'
          };
          return `
          <tr>
            <td>${item.promoCode}</td>
            <td>${item.name}</td>
            <td>${item.phone}</td>
            <td>${typeMap[item.transactionType] || item.transactionType}</td>
            <td style="color: ${isPositive ? '#52c41a' : '#ff4d4f'}">${isPositive ? '+' : ''}${item.pointsChange}</td>
            <td>${item.balance}</td>
            <td>${item.createdAt || '-'}</td>
            <td>${item.description || '-'}</td>
          </tr>
        `;
        }).join('');
      }
      
      // 加载异常订单数据（使用API）
      async function loadExceptionsData() {
        const config = paginationConfig.exceptions;
        const params = {
          page: config.page,
          pageSize: config.pageSize,
          date: document.getElementById('exception-search-date')?.value || '',
          status: document.getElementById('exception-search-status')?.value || ''
        };
        
        try {
          const response = await apiService.getExceptions(params);
          if (response.success) {
            config.total = response.data.total;
            renderExceptionsTable(response.data.list);
            renderPagination('exceptions', config);
            document.getElementById('exception-total').textContent = response.data.total;
          } else {
            alert(response.message || '加载异常订单数据失败');
          }
          
          // 加载统计数据
          const statsResponse = await apiService.getExceptionStatistics();
          if (statsResponse.success) {
            const stats = statsResponse.data;
            document.getElementById('today-exceptions').textContent = stats.todayExceptions || 0;
            document.getElementById('today-pending').textContent = stats.todayPending || 0;
            document.getElementById('today-processed').textContent = stats.todayProcessed || 0;
          }
        } catch (error) {
          console.error('加载异常订单数据失败:', error);
          alert('加载异常订单数据失败：' + error.message);
        }
      }
      
      // 渲染异常订单表格
      function renderExceptionsTable(data) {
        const tbody = document.getElementById('exceptions-table-body');
        tbody.innerHTML = data.map(item => {
          // 处理图片显示
          let imageHtml = '-';
          if (item.imageUrls && item.imageUrls.length > 0) {
            const imageLinks = item.imageUrls.map(url => {
              const fullUrl = url.startsWith('http') ? url : `http://localhost:5000${url}`;
              return `<a href="${fullUrl}" target="_blank" style="color: #1890ff; cursor: pointer; margin-right: 5px;">查看图片${item.imageUrls.length > 1 ? item.imageUrls.indexOf(url) + 1 : ''}</a>`;
            }).join('');
            imageHtml = imageLinks;
          }
          
          const status = item.status || 'pending';
          const isExported = status === 'exported';
          
          return `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" class="exception-checkbox" value="${item.id}" ${isExported ? 'disabled' : ''}>
            </td>
            <td>${item.promoCode || '-'}</td>
            <td>${item.name || '-'}</td>
            <td>${item.phone || '-'}</td>
            <td>${item.nonMemberName || '-'}</td>
            <td>${item.nonMemberLink && item.nonMemberLink !== '-' ? `<a href="${item.nonMemberLink}" target="_blank" style="display: inline-block; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.nonMemberLink}">${item.nonMemberLink.length > 30 ? item.nonMemberLink.substring(0, 30) + '...' : item.nonMemberLink}</a>` : '-'}</td>
            <td>${item.createdAt || '-'}</td>
            <td>${item.description || '-'}</td>
            <td>${imageHtml}</td>
            <td>
              <span class="status-badge ${isExported ? 'processed' : 'pending'}">
                ${isExported ? '已受理' : '待处理'}
              </span>
            </td>
            <td>
              ${!isExported ? '<button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="exportException(\'' + item.id + '\')">导出</button>' : ''}
            </td>
          </tr>
        `;
        }).join('');
      }
      
      // 加载配置数据
      async function loadSettingsData() {
        try {
          const response = await apiService.getSettings();
          if (response.success) {
            const settings = response.data || {};
            
            // 加载联系方式
            const contact = settings.contact || {};
            document.getElementById('setting-wechat').value = contact.wechat || '';
            document.getElementById('setting-phone').value = contact.phone || '';
            document.getElementById('setting-qq').value = contact.qq || '';
            
            // 加载价格配置
            const price = settings.price || {};
            document.getElementById('setting-base-price').value = price.basePrice || '1';
            document.getElementById('setting-friday-price').value = price.fridayPrice || '1.5';
            
            // 加载金币与现金兑换配置
            document.getElementById('setting-coin-exchange-rate').value = settings.coinExchangeRate || '10';
            
            // 加载奖励比例（每次刷新都更新，确保显示最新值）
            const rewardRates = settings.rewardRates || {};
            const directRewardInput = document.getElementById('setting-direct-reward');
            const indirectRewardInput = document.getElementById('setting-indirect-reward');
            // 后端存储的是小数（0.03），前端显示为百分比（3），需要乘以100
            if (directRewardInput) {
              const directValue = (rewardRates.direct || 0.03) * 100;
              directRewardInput.value = directValue.toFixed(2);
            }
            if (indirectRewardInput) {
              const indirectValue = (rewardRates.indirect || 0.01) * 100;
              indirectRewardInput.value = indirectValue.toFixed(2);
            }
            
            // 加载转账限制配置
            const transferLimits = settings.transferLimits || {};
            document.getElementById('setting-min-quantity').value = transferLimits.minQuantity || '10';
            document.getElementById('setting-max-price').value = transferLimits.maxUnitPrice || '1.5';
            
            // 加载优惠规则
            if (settings.discountRules) {
              loadDiscountRules(settings.discountRules);
            } else {
              loadDiscountRules();
            }
            
            // 加载充值优惠规则
            if (settings.rechargeDiscountRules) {
              loadRechargeDiscountRules(settings.rechargeDiscountRules);
            } else {
              loadRechargeDiscountRules();
            }
          } else {
            alert('加载配置失败：' + (response.message || '未知错误'));
            // 使用默认值
            loadDefaultSettings();
          }
        } catch (error) {
          console.error('加载配置失败:', error);
          let errorMsg = error.message || '未知错误';
          if (errorMsg.includes('Failed to fetch') || errorMsg.includes('无法连接')) {
            errorMsg = '无法连接到服务器，请检查后端服务是否运行（http://localhost:5000）';
          }
          alert('加载配置失败：' + errorMsg);
          // 使用默认值
          loadDefaultSettings();
        }
      }
      
      function loadDefaultSettings() {
        // 默认配置
        document.getElementById('setting-wechat').value = 'kefu123456';
        document.getElementById('setting-phone').value = '400-123-4567';
        document.getElementById('setting-qq').value = '123456789';
        document.getElementById('setting-base-price').value = '1';
        document.getElementById('setting-friday-price').value = '1.5';
        document.getElementById('setting-coin-exchange-rate').value = '10';
        // 不再设置默认值，避免覆盖用户输入
        document.getElementById('setting-min-quantity').value = '10';
        document.getElementById('setting-max-price').value = '1.5';
        loadDiscountRules();
        loadRechargeDiscountRules();
      }
      
      // 加载报单优惠规则
      function loadDiscountRules(rules) {
        if (!rules) {
          rules = [];
        }
        
        const container = document.getElementById('discount-rules-container');
        container.innerHTML = rules.map((rule, index) => `
          <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div style="flex: 1;">
              <label>订单数达到</label>
              <input type="number" class="form-control" value="${rule.minOrders}" data-index="${index}" data-field="minOrders">
            </div>
            <div style="flex: 1;">
              <label>折扣（%）</label>
              <input type="number" step="0.1" min="0" max="100" class="form-control" value="${(rule.discount || 0) * 100}" data-index="${index}" data-field="discount">
              <small style="color: #999;">输入百分比，如90表示90%折扣（即打9折）</small>
            </div>
            <button class="btn btn-danger" onclick="removeDiscountRule(${index})" style="margin-top: 20px;">删除</button>
          </div>
        `).join('');
      }
      
      // 加载充值优惠规则
      function loadRechargeDiscountRules(rules) {
        if (!rules) {
          rules = [
            { minAmount: 200, discount: 95 },
            { minAmount: 100, discount: 98 }
          ];
        }
        
        const container = document.getElementById('recharge-discount-rules-container');
        container.innerHTML = rules.map((rule, index) => `
          <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div style="flex: 1;">
              <label>充值金额达到（金币）</label>
              <input type="number" class="form-control" value="${rule.minAmount}" data-index="${index}" data-field="minAmount">
            </div>
            <div style="flex: 1;">
              <label>优惠折扣（折）</label>
              <input type="number" step="0.1" class="form-control" value="${rule.discount}" data-index="${index}" data-field="discount" placeholder="例如：98表示98折">
            </div>
            <button class="btn btn-danger" onclick="removeRechargeDiscountRule(${index})" style="margin-top: 20px;">删除</button>
          </div>
        `).join('');
      }
      
      // 操作函数
      function changeParent(id, type) {
        currentSelectedId = id;
        currentSelectedType = type;
        document.getElementById('new-parent-id').value = '';
        document.getElementById('change-parent-modal').classList.add('active');
      }
      
      async function confirmChangeParent() {
        const newParentId = document.getElementById('new-parent-id').value.trim();
        if (!newParentId) {
          alert('请输入新的上级推广码');
          return;
        }
        
        try {
          const response = await apiService.changeParent(currentSelectedId, newParentId);
          if (response.success) {
            alert(response.message || '更换上级成功');
            closeModal('change-parent-modal');
            // 刷新数据
            if (currentSelectedType === 'member') {
              loadMembersData();
            } else {
              loadAgentsData();
            }
          } else {
            alert(response.message || '更换上级失败');
          }
        } catch (error) {
          alert('更换上级失败：' + error.message);
        }
      }
      
      function viewMemberOrders(id) {
        currentSelectedId = id;
        document.getElementById('order-detail-modal').classList.add('active');
        // 加载订单详情数据
        loadOrderDetailData(id);
      }
      
      function viewAgentOrders(id) {
        currentSelectedId = id;
        document.getElementById('order-detail-modal').classList.add('active');
        // 加载订单详情数据
        loadOrderDetailData(id);
      }
      
      async function loadOrderDetailData(id, filters = {}) {
        try {
          const params = {};
          if (filters.startDate) params.startDate = filters.startDate;
          if (filters.endDate) params.endDate = filters.endDate;
          if (filters.status) params.status = filters.status;
          
          const response = await apiService.getUserOrders(id, params);
          if (response.success) {
            const data = response.data.list || [];
            const tbody = document.getElementById('order-detail-table-body');
            if (data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无数据</td></tr>';
            } else {
              tbody.innerHTML = data.map(item => `
                <tr>
                  <td>${item.settlementDate || '-'}</td>
                  <td>${item.nonMemberName || '-'}</td>
                  <td>${item.points}</td>
                  <td>${item.status || '-'}</td>
                </tr>
              `).join('');
            }
          } else {
            alert(response.message || '加载订单详情失败');
          }
        } catch (error) {
          console.error('加载订单详情失败:', error);
          alert('加载订单详情失败：' + error.message);
        }
      }
      
      function filterOrderDetail() {
        const startDate = document.getElementById('order-detail-start-date').value;
        const endDate = document.getElementById('order-detail-end-date').value;
        const status = document.getElementById('order-detail-status').value;
        loadOrderDetailData(currentSelectedId, { startDate, endDate, status });
      }
      
      function resetOrderDetailFilter() {
        document.getElementById('order-detail-start-date').value = '';
        document.getElementById('order-detail-end-date').value = '';
        document.getElementById('order-detail-status').value = '';
        loadOrderDetailData(currentSelectedId);
      }
      
      async function rechargeAgent(id) {
        currentSelectedId = id;
        document.getElementById('recharge-amount').value = '';
        document.getElementById('recharge-cash').value = '';
        document.getElementById('recharge-discount-info').textContent = '';
        document.getElementById('admin-password').value = '';
        
        // 确保配置已加载（如果还没有加载）
        const exchangeRateInput = document.getElementById('setting-coin-exchange-rate');
        if (!exchangeRateInput || !exchangeRateInput.value) {
          await loadSettingsData();
        }
        
        document.getElementById('recharge-modal').classList.add('active');
      }
      
      async function confirmRecharge() {
        const amount = parseFloat(document.getElementById('recharge-amount').value);
        const password = document.getElementById('admin-password').value;
        
        if (!amount || amount <= 0) {
          alert('请输入有效的充值金额');
          return;
        }
        
        if (!password) {
          alert('请输入管理员密码');
          return;
        }
        
        try {
          const response = await apiService.recharge(currentSelectedId, amount, password);
          if (response.success) {
            alert('充值成功');
            closeModal('recharge-modal');
            // 刷新代理列表（更新余额）
            loadAgentsData();
            // 刷新交易查询列表（显示充值记录）
            loadTransactionsData();
          } else {
            alert(response.message || '充值失败');
          }
        } catch (error) {
          alert('充值失败：' + error.message);
        }
      }
      
      // 计算充值现金
      function calculateRechargeCash() {
        const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
        if (amount <= 0) {
          document.getElementById('recharge-cash').value = '';
          document.getElementById('recharge-discount-info').textContent = '';
          return;
        }
        
        // 获取现金兑换比例（元/金币）
        const exchangeRateInput = document.getElementById('setting-coin-exchange-rate');
        const exchangeRate = parseFloat(exchangeRateInput?.value || '10.0') || 10.0;
        
        // 获取充值优惠规则（从配置中获取）
        const rechargeRules = getRechargeDiscountRules();
        
        // 找到适用的优惠规则（找到金额最大的适用规则）
        let applicableRule = null;
        for (let rule of rechargeRules) {
          if (amount >= rule.minAmount) {
            if (!applicableRule || rule.minAmount > applicableRule.minAmount) {
              applicableRule = rule;
            }
          }
        }
        
        // 计算基础现金（根据兑换比例）
        let baseCash = amount * exchangeRate;
        
        // 计算实际需要支付的现金（应用优惠折扣）
        let cashAmount = baseCash;
        let discountInfo = '';
        
        if (applicableRule) {
          // 应用折扣，例如98折就是乘以0.98
          const discount = applicableRule.discount / 100.0;
          cashAmount = baseCash * discount;
          discountInfo = `适用优惠：充值${applicableRule.minAmount}以上享受${applicableRule.discount}折`;
        }
        
        document.getElementById('recharge-cash').value = cashAmount.toFixed(2);
        document.getElementById('recharge-discount-info').textContent = discountInfo;
      }
      
      // 获取充值优惠规则（从配置中读取）
      function getRechargeDiscountRules() {
        const container = document.getElementById('recharge-discount-rules-container');
        const rules = [];
        const inputs = container.querySelectorAll('input[data-field]');
        const ruleMap = {};
        
        // 按索引分组
        inputs.forEach(input => {
          const index = input.getAttribute('data-index');
          const field = input.getAttribute('data-field');
          if (!ruleMap[index]) {
            ruleMap[index] = {};
          }
          ruleMap[index][field] = parseFloat(input.value) || 0;
        });
        
        // 转换为数组
        Object.keys(ruleMap).forEach(key => {
          if (ruleMap[key].minAmount > 0 && ruleMap[key].discount > 0) {
            rules.push(ruleMap[key]);
          }
        });
        
        // 如果没有配置，使用默认值
        if (rules.length === 0) {
          return [
            { minAmount: 200, discount: 95 },
            { minAmount: 100, discount: 98 }
          ];
        }
        
        return rules;
      }
      
      function viewAgentDetail(id) {
        currentSelectedId = id;
        document.getElementById('agent-detail-modal').classList.add('active');
        // 切换到非会员tab
        switchAgentDetailTab('nonmember');
        // 加载代理详情数据
        loadAgentDetailData(id);
      }
      
      // 切换代理详情Tab
      function switchAgentDetailTab(tab) {
        // 重置所有tab样式
        document.getElementById('agent-detail-tab-nonmember').style.cssText = 'padding: 10px 20px; cursor: pointer; color: #666;';
        document.getElementById('agent-detail-tab-ordinary').style.cssText = 'padding: 10px 20px; cursor: pointer; color: #666;';
        document.getElementById('agent-detail-tab-agent').style.cssText = 'padding: 10px 20px; cursor: pointer; color: #666;';
        
        // 隐藏所有内容
        document.getElementById('agent-detail-nonmember').style.display = 'none';
        document.getElementById('agent-detail-ordinary').style.display = 'none';
        document.getElementById('agent-detail-agent').style.display = 'none';
        
        // 显示对应内容并高亮tab
        if (tab === 'nonmember') {
          document.getElementById('agent-detail-tab-nonmember').style.cssText = 'padding: 10px 20px; cursor: pointer; border-bottom: 2px solid #1890ff; color: #1890ff; font-weight: 500;';
          document.getElementById('agent-detail-nonmember').style.display = 'block';
        } else if (tab === 'ordinary') {
          document.getElementById('agent-detail-tab-ordinary').style.cssText = 'padding: 10px 20px; cursor: pointer; border-bottom: 2px solid #1890ff; color: #1890ff; font-weight: 500;';
          document.getElementById('agent-detail-ordinary').style.display = 'block';
        } else if (tab === 'agent') {
          document.getElementById('agent-detail-tab-agent').style.cssText = 'padding: 10px 20px; cursor: pointer; border-bottom: 2px solid #1890ff; color: #1890ff; font-weight: 500;';
          document.getElementById('agent-detail-agent').style.display = 'block';
        }
        
        // 加载对应数据
        loadAgentDetailData(currentSelectedId, tab);
      }
      
      // 加载代理详情数据
      async function loadAgentDetailData(agentId, tab = 'nonmember') {
        // agentId 是推广码
        try {
          const response = await apiService.getAgentSubordinates(agentId);
          if (!response.success) {
            alert(response.message || '加载代理详情失败');
            return;
          }
          
          const data = response.data;
          
          if (tab === 'nonmember') {
            // 加载非会员数据
            const tbody = document.getElementById('agent-detail-nonmember-body');
            if (!data.nonmembers || data.nonmembers.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无数据</td></tr>';
            } else {
              tbody.innerHTML = data.nonmembers.map(item => `
                <tr>
                  <td>${item.name}</td>
                  <td><a href="${item.link || '#'}" target="_blank" style="display: inline-block; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.link || '-'}">${item.link ? (item.link.length > 30 ? item.link.substring(0, 30) + '...' : item.link) : '-'}</a></td>
                  <td>${item.createdAt || '-'}</td>
                  <td><button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">查看详情</button></td>
                </tr>
              `).join('');
            }
          } else if (tab === 'ordinary') {
            // 加载普通会员数据
            const tbody = document.getElementById('agent-detail-ordinary-body');
            if (!data.ordinaryMembers || data.ordinaryMembers.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无数据</td></tr>';
            } else {
              tbody.innerHTML = data.ordinaryMembers.map(item => `
                <tr>
                  <td>${item.id}</td>
                  <td>${item.name}</td>
                  <td>${item.phone}</td>
                  <td>${item.registerDate || '-'}</td>
                  <td>${item.nonmemberCount || 0}</td>
                  <td><button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewMemberInfo('${item.id}')">查看详情</button></td>
                </tr>
              `).join('');
            }
          } else if (tab === 'agent') {
            // 加载代理会员数据
            const tbody = document.getElementById('agent-detail-agent-body');
            if (!data.agentMembers || data.agentMembers.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无数据</td></tr>';
            } else {
              tbody.innerHTML = data.agentMembers.map(item => `
                <tr>
                  <td>${item.id}</td>
                  <td>${item.name}</td>
                  <td>${item.phone}</td>
                  <td>${item.registerDate || '-'}</td>
                  <td>${item.nonmemberCount || 0}</td>
                  <td><button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewAgentInfo('${item.id}')">查看详情</button></td>
                </tr>
              `).join('');
            }
          }
        } catch (error) {
          console.error('加载代理详情失败:', error);
          alert('加载代理详情失败：' + error.message);
        }
      }
      
      // 通过推广码查找用户ID
      async function findUserByPromoCode(promoCode) {
        try {
          // 先尝试从代理列表查找
          let response = await apiService.getAgents({ id: promoCode, pageSize: 1 });
          if (response.success && response.data.list && response.data.list.length > 0) {
            // 需要从后端获取实际用户ID，这里先使用推广码作为标识
            // 后端接口应该返回用户ID，但当前接口只返回推广码
            // 临时方案：使用推广码，后端接口需要根据推广码查找用户
            return { id: promoCode, promoCode: promoCode };
          }
          // 如果代理列表找不到，尝试会员列表
          response = await apiService.getMembers({ id: promoCode, pageSize: 1 });
          if (response.success && response.data.list && response.data.list.length > 0) {
            return { id: promoCode, promoCode: promoCode };
          }
        } catch (error) {
          console.error('查找用户失败:', error);
        }
        return null;
      }
      
      // 会员详情使用代理详情逻辑
      function viewMemberDetail(id) {
        viewAgentDetail(id);
      }
      
      async function deleteMember(id) {
        if (confirm('确定要删除该会员吗？')) {
          try {
            const response = await apiService.deleteMember(id);
            if (response.success) {
              alert('删除成功');
              loadMembersData();
            } else {
              alert(response.message || '删除失败');
            }
          } catch (error) {
            alert('删除失败：' + error.message);
          }
        }
      }
      
      async function deleteAgent(id) {
        if (confirm('确定要删除该代理吗？')) {
          try {
            const response = await apiService.deleteAgent(id);
            if (response.success) {
              alert('删除成功');
              loadAgentsData();
            } else {
              alert(response.message || '删除失败');
            }
          } catch (error) {
            alert('删除失败：' + error.message);
          }
        }
      }
      
      // 打开新增代理模态框
      function openAddAgentModal() {
        document.getElementById('add-agent-name').value = '';
        document.getElementById('add-agent-phone').value = '';
        document.getElementById('add-agent-modal').classList.add('active');
      }
      
      // 确认添加代理
      async function confirmAddAgent() {
        const name = document.getElementById('add-agent-name').value.trim();
        const phone = document.getElementById('add-agent-phone').value.trim();
        
        if (!name) {
          alert('请输入代理姓名');
          return;
        }
        
        if (!phone || !phone.match(/^1[3-9]\d{9}$/)) {
          alert('请输入正确的11位手机号');
          return;
        }
        
        try {
          const response = await apiService.createAgent({ name, phone });
          if (response.success) {
            alert('代理创建成功');
            closeModal('add-agent-modal');
            loadAgentsData();
          } else {
            alert(response.message || '创建失败');
          }
        } catch (error) {
          alert('创建失败：' + error.message);
        }
      }
      
      // 导出单个异常订单
      async function exportException(id) {
        if (confirm('确定要导出该异常订单吗？导出后将自动标记为已受理。')) {
          try {
            const response = await apiService.exportExceptions([id]);
            if (response.success) {
              // 下载CSV文件
              if (response.data && response.data.csv) {
                const blob = new Blob(['\ufeff' + response.data.csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `异常订单_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }
              alert('导出成功，订单已标记为已受理');
              loadExceptionsData();
            } else {
              alert(response.message || '导出失败');
            }
          } catch (error) {
            console.error('导出异常订单失败:', error);
            alert('导出失败：' + (error.message || '未知错误'));
          }
        }
      }
      
      // 全选功能
      function toggleSelectAllMembers() {
        const checkbox = document.getElementById('select-all-members');
        const checkboxes = document.querySelectorAll('.member-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      }
      
      function toggleSelectAllAgents() {
        const checkbox = document.getElementById('select-all-agents');
        const checkboxes = document.querySelectorAll('.agent-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      }
      
      function toggleSelectAllOrders() {
        const checkbox = document.getElementById('select-all-orders');
        const checkboxes = document.querySelectorAll('.order-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      }
      
      function toggleSelectAllExceptions() {
        const checkbox = document.getElementById('select-all-exceptions');
        const checkboxes = document.querySelectorAll('.exception-checkbox:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      }
      
      // 批量操作
      function batchDeleteMembers() {
        const selected = Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
          alert('请选择要删除的会员');
          return;
        }
        if (confirm(`确定要删除选中的 ${selected.length} 个会员吗？`)) {
          // 调用后端API
          alert(`批量删除会员：${selected.join(', ')}`);
          loadMembersData();
        }
      }
      
      function batchDeleteAgents() {
        const selected = Array.from(document.querySelectorAll('.agent-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
          alert('请选择要删除的代理');
          return;
        }
        if (confirm(`确定要删除选中的 ${selected.length} 个代理吗？`)) {
          // 调用后端API
          alert(`批量删除代理：${selected.join(', ')}`);
          loadAgentsData();
        }
      }
      
      
      async function exportSelectedOrders() {
        const selected = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selected.length === 0) {
          alert('请选择要导出的订单');
          return;
        }
        
        try {
          const response = await apiService.exportOrders(selected);
          if (response.success) {
            // 创建下载链接
            const blob = new Blob(['\ufeff' + response.data.csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `订单导出_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`已导出 ${selected.length} 个订单`);
            loadOrdersData();
          } else {
            alert(response.message || '导出失败');
          }
        } catch (error) {
          console.error('导出订单失败:', error);
          alert('导出失败：' + error.message);
        }
      }
      
      // 搜索功能
      function searchMembers() {
        const id = document.getElementById('member-search-id').value;
        const phone = document.getElementById('member-search-phone').value;
        const date = document.getElementById('member-search-date').value;
        // 调用后端API搜索
        loadMembersData();
      }
      
      function resetMemberSearch() {
        document.getElementById('member-search-id').value = '';
        document.getElementById('member-search-phone').value = '';
        document.getElementById('member-search-date').value = '';
        loadMembersData();
      }
      
      function searchAgents() {
        const id = document.getElementById('agent-search-id').value;
        const phone = document.getElementById('agent-search-phone').value;
        const date = document.getElementById('agent-search-date').value;
        // 调用后端API搜索
        loadAgentsData();
      }
      
      function resetAgentSearch() {
        document.getElementById('agent-search-id').value = '';
        document.getElementById('agent-search-phone').value = '';
        document.getElementById('agent-search-date').value = '';
        loadAgentsData();
      }
      
      function searchOrders() {
        const id = document.getElementById('order-search-id').value;
        const phone = document.getElementById('order-search-phone').value;
        const exportStatus = document.getElementById('order-search-export').value;
        // 调用后端API搜索
        loadOrdersData();
      }
      
      function resetOrderSearch() {
        document.getElementById('order-search-date').value = '';
        document.getElementById('order-search-id').value = '';
        document.getElementById('order-search-phone').value = '';
        document.getElementById('order-search-export').value = '';
        loadOrdersData();
      }
      
      function searchTransactions() {
        const id = document.getElementById('transaction-search-id').value;
        const phone = document.getElementById('transaction-search-phone').value;
        const type = document.getElementById('transaction-search-type').value;
        // 调用后端API搜索
        loadTransactionsData();
      }
      
      function resetTransactionSearch() {
        document.getElementById('transaction-search-id').value = '';
        document.getElementById('transaction-search-phone').value = '';
        document.getElementById('transaction-search-type').value = '';
        loadTransactionsData();
      }
      
      function searchExceptions() {
        const date = document.getElementById('exception-search-date').value;
        const status = document.getElementById('exception-search-status').value;
        // 调用后端API搜索，传递日期和状态参数
        console.log('搜索异常订单 - 日期:', date, '状态:', status);
        loadExceptionsData();
      }
      
      function resetExceptionSearch() {
        document.getElementById('exception-search-date').value = '';
        document.getElementById('exception-search-status').value = '';
        loadExceptionsData();
      }
      
      // 导出选中的异常订单
      async function exportSelectedExceptions() {
        const selected = Array.from(document.querySelectorAll('.exception-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
          alert('请选择要导出的异常订单');
          return;
        }
        
        if (confirm(`确定要导出选中的 ${selected.length} 个异常订单吗？导出后将自动标记为已受理。`)) {
          try {
            const response = await apiService.exportExceptions(selected);
            if (response.success) {
              // 下载CSV文件
              if (response.data && response.data.csv) {
                const blob = new Blob(['\ufeff' + response.data.csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `异常订单_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }
              alert(`已导出 ${selected.length} 个异常订单，并标记为已受理`);
              loadExceptionsData();
            } else {
              alert(response.message || '导出失败');
            }
          } catch (error) {
            console.error('导出异常订单失败:', error);
            alert('导出失败：' + (error.message || '未知错误'));
          }
        }
      }
      
      // 配置保存功能
      async function saveContactSettings() {
        const wechat = document.getElementById('setting-wechat').value.trim();
        const phone = document.getElementById('setting-phone').value.trim();
        const qq = document.getElementById('setting-qq').value.trim();
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新联系方式配置
          const settings = currentSettings.data || {};
          settings.contact = {
            wechat: wechat,
            phone: phone,
            qq: qq
          };
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('联系方式保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存联系方式失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      async function savePriceSettings() {
        const basePrice = parseFloat(document.getElementById('setting-base-price').value);
        const fridayPrice = parseFloat(document.getElementById('setting-friday-price').value);
        
        if (!basePrice || basePrice <= 0) {
          alert('请输入有效的默认基础单价');
          return;
        }
        
        if (!fridayPrice || fridayPrice <= 0) {
          alert('请输入有效的周五基础单价');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新价格配置
          const settings = currentSettings.data || {};
          settings.price = {
            basePrice: basePrice,
            fridayPrice: fridayPrice
          };
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('报单消耗金币配置保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存价格设置失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      async function saveExchangeRateSettings() {
        const exchangeRate = parseFloat(document.getElementById('setting-coin-exchange-rate').value);
        
        if (!exchangeRate || exchangeRate <= 0) {
          alert('请输入有效的兑换比例');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新兑换比例配置
          const settings = currentSettings.data || {};
          settings.coinExchangeRate = exchangeRate;
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('金币与现金兑换配置保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存兑换比例失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      async function saveRechargeDiscountSettings() {
        const rules = [];
        const inputs = document.querySelectorAll('#recharge-discount-rules-container input[data-field]');
        const ruleMap = {};
        
        // 按索引分组
        inputs.forEach(input => {
          const index = input.getAttribute('data-index');
          const field = input.getAttribute('data-field');
          if (!ruleMap[index]) {
            ruleMap[index] = {};
          }
          ruleMap[index][field] = parseFloat(input.value) || 0;
        });
        
        // 转换为数组
        Object.keys(ruleMap).forEach(key => {
          if (ruleMap[key].minAmount > 0 && ruleMap[key].discount > 0) {
            rules.push({
              minAmount: ruleMap[key].minAmount,
              discount: ruleMap[key].discount
            });
          }
        });
        
        if (rules.length === 0) {
          alert('请至少添加一条充值优惠规则');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新充值优惠规则配置
          const settings = currentSettings.data || {};
          settings.rechargeDiscountRules = rules;
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('充值金币优惠规则保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存充值优惠规则失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      function addRechargeDiscountRule() {
        const container = document.getElementById('recharge-discount-rules-container');
        const index = container.children.length;
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
        div.innerHTML = `
          <div style="flex: 1;">
            <label>充值金额达到（金币）</label>
            <input type="number" class="form-control" value="0" data-index="${index}" data-field="minAmount">
          </div>
          <div style="flex: 1;">
            <label>优惠折扣（折）</label>
            <input type="number" step="0.1" class="form-control" value="100" data-index="${index}" data-field="discount" placeholder="例如：98表示98折">
          </div>
          <button class="btn btn-danger" onclick="removeRechargeDiscountRule(${index})" style="margin-top: 20px;">删除</button>
        `;
        container.appendChild(div);
      }
      
      function removeRechargeDiscountRule(index) {
        const container = document.getElementById('recharge-discount-rules-container');
        if (container.children.length > 1) {
          container.removeChild(container.children[index]);
        } else {
          alert('至少保留一条充值优惠规则');
        }
      }
      
      async function saveDiscountSettings() {
        const rules = [];
        const inputs = document.querySelectorAll('#discount-rules-container input');
        const ruleMap = {};
        
        // 按索引分组
        inputs.forEach(input => {
          const index = input.getAttribute('data-index');
          const field = input.getAttribute('data-field');
          if (!ruleMap[index]) {
            ruleMap[index] = {};
          }
          ruleMap[index][field] = parseFloat(input.value) || 0;
        });
        
        // 转换为数组（将百分比转换为小数）
        Object.keys(ruleMap).forEach(key => {
          const discountPercent = ruleMap[key].discount || 0;
          const discountDecimal = discountPercent / 100; // 将百分比转换为小数
          if (ruleMap[key].minOrders > 0 && discountPercent >= 0 && discountPercent <= 100) {
            rules.push({
              minOrders: ruleMap[key].minOrders,
              discount: discountDecimal  // 存储为小数（0-1之间）
            });
          }
        });
        
        if (rules.length === 0) {
          alert('请至少添加一条优惠规则');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新优惠规则配置
          const settings = currentSettings.data || {};
          settings.discountRules = rules;
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('报单优惠规则保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存优惠规则失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      async function saveRewardSettings() {
        const directReward = parseFloat(document.getElementById('setting-direct-reward').value);
        const indirectReward = parseFloat(document.getElementById('setting-indirect-reward').value);
        
        if (directReward < 0 || directReward > 100) {
          alert('直推奖励比例必须在0-100之间');
          return;
        }
        
        if (indirectReward < 0 || indirectReward > 100) {
          alert('间推奖励比例必须在0-100之间');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新奖励比例配置（前端输入的是百分比，后端存储的是小数）
          const settings = currentSettings.data || {};
          settings.rewardRates = {
            direct: directReward / 100,
            indirect: indirectReward / 100
          };
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('奖励比例配置保存成功');
            // 保存成功后重新加载配置，确保显示最新值
            await loadSettingsData();
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存奖励设置失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      async function saveTransferSettings() {
        const minQuantity = parseFloat(document.getElementById('setting-min-quantity').value);
        const maxPrice = parseFloat(document.getElementById('setting-max-price').value);
        
        if (!minQuantity || minQuantity <= 0) {
          alert('请输入有效的最低转账数量');
          return;
        }
        
        if (!maxPrice || maxPrice <= 0) {
          alert('请输入有效的最高转账单价');
          return;
        }
        
        try {
          // 先获取当前配置
          const currentSettings = await apiService.getSettings();
          if (!currentSettings.success) {
            alert('获取当前配置失败：' + currentSettings.message);
            return;
          }
          
          // 更新转账限制配置
          const settings = currentSettings.data || {};
          settings.transferLimits = {
            minQuantity: minQuantity,
            maxUnitPrice: maxPrice
          };
          
          // 保存配置
          const response = await apiService.updateSettings(settings);
          if (response.success) {
            alert('转账设置保存成功');
          } else {
            alert('保存失败：' + (response.message || '未知错误'));
          }
        } catch (error) {
          console.error('保存转账设置失败:', error);
          alert('保存失败：' + error.message);
        }
      }
      
      function addDiscountRule() {
        const container = document.getElementById('discount-rules-container');
        const index = container.children.length;
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
        div.innerHTML = `
          <div style="flex: 1;">
            <label>订单数达到</label>
            <input type="number" class="form-control" value="0" data-index="${index}" data-field="minOrders">
          </div>
          <div style="flex: 1;">
            <label>折扣（金币）</label>
            <input type="number" step="0.1" class="form-control" value="0" data-index="${index}" data-field="discount">
          </div>
          <button class="btn btn-danger" onclick="removeDiscountRule(${index})" style="margin-top: 20px;">删除</button>
        `;
        container.appendChild(div);
      }
      
      function removeDiscountRule(index) {
        const container = document.getElementById('discount-rules-container');
        if (container.children.length > 1) {
          container.removeChild(container.children[index]);
        } else {
          alert('至少保留一条优惠规则');
        }
      }
      
      // 关闭模态框
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }
      
      // ==================== 1. 后端API对接 ====================
      // API服务已在api.js中定义，这里直接使用
      
      // ==================== 2. 管理员登录系统 ====================
      // 检查登录状态
      function checkAuth() {
        if (!apiService.isAuthenticated()) {
          showLoginPage();
          return false;
        }
        showAdminPage();
        return true;
      }
      
      // 显示登录页面
      function showLoginPage() {
        document.getElementById('login-page').style.display = 'flex';
        document.getElementById('admin-container').style.display = 'none';
      }
      
      // 显示管理页面
      function showAdminPage() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('admin-container').style.display = 'flex';
      }
      
      // 处理登录
      async function handleLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        
        if (!username || !password) {
          errorEl.textContent = '请输入用户名和密码';
          errorEl.classList.add('show');
          return;
        }
        
        errorEl.classList.remove('show');
        
        const response = await apiService.login(username, password);
        
        if (response.success) {
          showAdminPage();
          loadPageData('members');
        } else {
          errorEl.textContent = response.message || '登录失败';
          errorEl.classList.add('show');
        }
      }
      
      // 处理登出
      function handleLogout() {
        if (confirm('确定要退出登录吗？')) {
          apiService.logout();
          showLoginPage();
        }
      }
      
      // 在侧边栏添加登出按钮
      function addLogoutButton() {
        const sidebar = document.querySelector('.sidebar');
        const logoutBtn = document.createElement('div');
        logoutBtn.className = 'menu-item';
        logoutBtn.style.cssText = 'position: absolute; bottom: 20px; left: 0; right: 0; border-top: 1px solid rgba(255, 255, 255, 0.1);';
        logoutBtn.innerHTML = '<div onclick="handleLogout()" style="padding: 12px 20px; cursor: pointer;">退出登录</div>';
        sidebar.style.position = 'relative';
        sidebar.appendChild(logoutBtn);
      }
      
      // ==================== 3. 数据分页功能 ====================
      // 分页配置
      const paginationConfig = {
        members: { page: 1, pageSize: 20, total: 0 },
        agents: { page: 1, pageSize: 20, total: 0 },
        orders: { page: 1, pageSize: 20, total: 0 },
        transactions: { page: 1, pageSize: 20, total: 0 },
        exceptions: { page: 1, pageSize: 20, total: 0 }
      };
      
      // 渲染分页
      function renderPagination(pageId, config) {
        const container = document.getElementById(`${pageId}-pagination`);
        if (!container) return;
        
        const totalPages = Math.ceil(config.total / config.pageSize);
        const currentPage = config.page;
        
        let html = `
          <div class="pagination-info">
            <span>共 ${config.total} 条，每页</span>
            <select class="pagination-input" onchange="changePageSize('${pageId}', this.value)">
              <option value="10" ${config.pageSize === 10 ? 'selected' : ''}>10</option>
              <option value="20" ${config.pageSize === 20 ? 'selected' : ''}>20</option>
              <option value="50" ${config.pageSize === 50 ? 'selected' : ''}>50</option>
              <option value="100" ${config.pageSize === 100 ? 'selected' : ''}>100</option>
            </select>
            <span>条</span>
          </div>
          <button onclick="goToPage('${pageId}', 1)" ${currentPage === 1 ? 'disabled' : ''}>首页</button>
          <button onclick="goToPage('${pageId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>
          <span>第 ${currentPage} / ${totalPages || 1} 页</span>
          <button onclick="goToPage('${pageId}', ${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>下一页</button>
          <button onclick="goToPage('${pageId}', ${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''}>末页</button>
          <div style="display: inline-flex; align-items: center; gap: 5px; margin-left: 10px;">
            <span>跳转到</span>
            <input type="number" class="pagination-input" id="${pageId}-jump-page" min="1" max="${totalPages}" value="${currentPage}">
            <span>页</span>
            <button onclick="jumpToPage('${pageId}')">跳转</button>
          </div>
        `;
        
        container.innerHTML = html;
      }
      
      // 跳转页面
      function goToPage(pageId, page) {
        const config = paginationConfig[pageId];
        if (page < 1 || page > Math.ceil(config.total / config.pageSize)) return;
        config.page = page;
        loadPageData(pageId);
      }
      
      // 跳转到指定页
      function jumpToPage(pageId) {
        const input = document.getElementById(`${pageId}-jump-page`);
        const page = parseInt(input.value);
        if (page) {
          goToPage(pageId, page);
        }
      }
      
      // 修改每页条数
      function changePageSize(pageId, pageSize) {
        paginationConfig[pageId].pageSize = parseInt(pageSize);
        paginationConfig[pageId].page = 1;
        loadPageData(pageId);
      }
      
      // ==================== 7. 图片功能完善 ====================
      // 图片预览
      function previewImage(imageUrl) {
        const modal = document.getElementById('image-preview-modal');
        if (!modal) {
          // 创建图片预览模态框
          const imageModal = document.createElement('div');
          imageModal.id = 'image-preview-modal';
          imageModal.className = 'image-preview-modal';
          imageModal.innerHTML = `
            <div class="image-preview-content">
              <img src="${imageUrl}" alt="预览图片" />
            </div>
          `;
          imageModal.onclick = function(e) {
            if (e.target === imageModal) {
              closeImagePreview();
            }
          };
          document.body.appendChild(imageModal);
        }
        const img = document.querySelector('#image-preview-modal img');
        if (img) img.src = imageUrl;
        document.getElementById('image-preview-modal').classList.add('active');
      }
      
      function closeImagePreview() {
        const modal = document.getElementById('image-preview-modal');
        if (modal) modal.classList.remove('active');
      }
      
      // ==================== 10. 订单详情优化 ====================
      // 订单详情时间范围筛选（已在上面实现，这里删除重复）
      
      // ==================== 11. 充值功能完善 ====================
      // 充值记录查询（在交易查询模块中已实现）
      // 充值统计（在交易查询模块的统计数据中已实现）
      
      // ==================== 12. 奖励系统完善 ====================
      // 奖励记录查询和统计（在用户端个人中心已实现，后台可查看）
      
      // ==================== 13. 数据验证增强 ====================
      // 推广码唯一性验证
      async function validatePromoCode(promoCode) {
        // 调用API验证推广码是否唯一
        // const response = await apiService.validatePromoCode(promoCode);
        // 模拟验证
        const existingCodes = ['123456', '234567', '654321'];
        return !existingCodes.includes(promoCode);
      }
      
      // 手机号格式验证
      function validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
      }
      
      // 数据格式验证
      function sanitizeInput(input) {
        if (typeof input !== 'string') return input;
        return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                   .replace(/[<>]/g, '');
      }
      
      // ==================== 14. 重置密码功能 ====================
      async function resetPassword(promoCode, type) {
        if (!confirm(`确定要重置该${type === 'member' ? '会员' : '代理'}的登录密码吗？重置后密码为：123456`)) {
          return;
        }
        
        try {
          const response = await apiService.resetUserPassword(promoCode);
          if (response.success) {
            alert(response.message || '重置登录密码成功');
          } else {
            alert(response.message || '重置登录密码失败');
          }
        } catch (error) {
          console.error('重置登录密码失败:', error);
          alert('重置登录密码失败：' + error.message);
        }
      }
      
      async function resetPayPassword(promoCode, type) {
        if (!confirm(`确定要重置该${type === 'member' ? '会员' : '代理'}的支付密码吗？重置后密码为：123456`)) {
          return;
        }
        
        try {
          const response = await apiService.resetUserPayPassword(promoCode);
          if (response.success) {
            alert(response.message || '重置支付密码成功');
          } else {
            alert(response.message || '重置支付密码失败');
          }
        } catch (error) {
          console.error('重置支付密码失败:', error);
          alert('重置支付密码失败：' + error.message);
        }
      }
      
      // ==================== 15. 数据备份与恢复 ====================
      async function backupData() {
        if (confirm('确定要创建数据备份吗？')) {
          // 调用API创建备份
          // const response = await apiService.createBackup();
          alert('数据备份创建成功');
          showBackupList();
        }
      }
      
      async function showBackupList() {
        const container = document.getElementById('backup-list-container');
        container.style.display = container.style.display === 'none' ? 'block' : 'block';
        
        // 调用API获取备份列表
        // const response = await apiService.getBackupList();
        const mockBackups = [
          { id: 1, time: '2023-06-15 10:30:00', filename: 'backup_20230615_103000.sql', size: '2.5 MB' },
          { id: 2, time: '2023-06-14 15:20:00', filename: 'backup_20230614_152000.sql', size: '2.4 MB' }
        ];
        
        const tbody = document.getElementById('backup-list-body');
        tbody.innerHTML = mockBackups.map(item => `
          <tr>
            <td>${item.time}</td>
            <td>${item.filename}</td>
            <td>${item.size}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="downloadBackup(${item.id})">下载</button>
              <button class="btn btn-success" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;" onclick="restoreBackup(${item.id})">恢复</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteBackup(${item.id})">删除</button>
            </td>
          </tr>
        `).join('');
      }
      
      async function downloadBackup(backupId) {
        // 调用API下载备份
        alert(`下载备份文件：${backupId}`);
      }
      
      async function restoreBackup(backupId) {
        if (confirm('确定要恢复此备份吗？恢复操作将覆盖当前数据，请谨慎操作！')) {
          // 调用API恢复备份
          alert(`恢复备份：${backupId}`);
        }
      }
      
      async function deleteBackup(backupId) {
        if (confirm('确定要删除此备份吗？')) {
          // 调用API删除备份
          alert(`删除备份：${backupId}`);
          showBackupList();
        }
      }
      
      // ==================== 16. 系统通知 ====================
      function showSendNotificationModal() {
        document.getElementById('send-notification-modal').classList.add('active');
        document.getElementById('notification-target').addEventListener('change', function() {
          const specificGroup = document.getElementById('specific-user-group');
          specificGroup.style.display = this.value === 'specific' ? 'block' : 'none';
        });
      }
      
      async function sendNotification() {
        const title = document.getElementById('notification-title').value;
        const content = document.getElementById('notification-content').value;
        const target = document.getElementById('notification-target').value;
        const users = document.getElementById('notification-users').value;
        
        if (!title || !content) {
          alert('请填写通知标题和内容');
          return;
        }
        
        if (target === 'specific' && !users) {
          alert('请指定接收用户');
          return;
        }
        
        // 调用API发送通知
        // const response = await apiService.sendNotification({ title, content, target, users });
        alert('通知发送成功');
        closeModal('send-notification-modal');
        
        // 清空表单
        document.getElementById('notification-title').value = '';
        document.getElementById('notification-content').value = '';
        document.getElementById('notification-target').value = 'all';
        document.getElementById('notification-users').value = '';
        document.getElementById('specific-user-group').style.display = 'none';
        
        // 刷新通知列表
        loadNotificationList();
      }
      
      function loadNotificationList() {
        // 调用API获取通知列表
        // const response = await apiService.getNotificationList();
        const mockNotifications = [
          {
            id: 1,
            title: '系统维护通知',
            content: '系统将于今晚进行维护',
            sendTime: '2023-06-15 10:30',
            target: '全部用户',
            status: '已发送'
          }
        ];
        
        const tbody = document.getElementById('notification-list-body');
        tbody.innerHTML = mockNotifications.map(item => `
          <tr>
            <td>${item.title}</td>
            <td>${item.content}</td>
            <td>${item.sendTime}</td>
            <td>${item.target}</td>
            <td><span class="status-badge processed">${item.status}</span></td>
            <td>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewNotification(${item.id})">查看</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteNotification(${item.id})">删除</button>
            </td>
          </tr>
        `).join('');
      }
      
      function viewNotification(id) {
        // 查看通知详情
        alert(`查看通知：${id}`);
      }
      
      function deleteNotification(id) {
        if (confirm('确定要删除此通知吗？')) {
          // 调用API删除通知
          alert(`删除通知：${id}`);
          loadNotificationList();
        }
      }
      
      // 更新loadSettingsData函数，加载通知列表
      const originalLoadSettingsData = loadSettingsData;
      function loadSettingsDataWithNotifications() {
        if (originalLoadSettingsData) originalLoadSettingsData();
        loadNotificationList();
      }
      
      // 重写loadSettingsData
      loadSettingsData = loadSettingsDataWithNotifications;
      
      // ==================== 页面加载时初始化 ====================
      document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        if (checkAuth()) {
          addLogoutButton();
          loadPageData('members');
        }
        
        // 添加回车键登录
        document.getElementById('login-password')?.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
      });
    </script>
  </body>
</html>

