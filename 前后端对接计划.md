# 前后端对接计划

## 一、项目概述

### 1.1 技术栈建议
- **后端框架**: Python Flask/Django 或 Node.js Express/Koa
- **数据库**: MySQL/PostgreSQL
- **认证方式**: JWT Token
- **API格式**: RESTful API, JSON格式

### 1.2 项目结构
```
project/
├── backend/          # 后端代码
│   ├── api/         # API路由
│   ├── models/      # 数据模型
│   ├── services/    # 业务逻辑
│   └── utils/       # 工具函数
├── frontend/         # 前端代码
│   ├── all_pages.html
│   ├── admin.html
│   └── api.js
└── database/         # 数据库脚本
```

## 二、数据库设计

### 2.1 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    promo_code VARCHAR(6) UNIQUE NOT NULL COMMENT '推广码（6位数字）',
    name VARCHAR(50) NOT NULL COMMENT '姓名',
    phone VARCHAR(11) UNIQUE NOT NULL COMMENT '手机号',
    password VARCHAR(255) NOT NULL COMMENT '登录密码（加密）',
    pay_password VARCHAR(6) NOT NULL COMMENT '支付密码（6位数字，加密）',
    user_type ENUM('ordinary', 'agent') DEFAULT 'ordinary' COMMENT '用户类型：普通会员/代理会员',
    parent_id INT COMMENT '上级用户ID',
    points DECIMAL(10,2) DEFAULT 0 COMMENT '金币余额',
    register_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_promo_code (promo_code),
    INDEX idx_phone (phone),
    INDEX idx_parent_id (parent_id)
);
```

#### 非会员用户表 (non_members)
```sql
CREATE TABLE non_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '姓名',
    link VARCHAR(500) COMMENT '碰碰链接',
    owner_id INT NOT NULL COMMENT '所属用户ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_owner_id (owner_id)
);
```

#### 订单表 (orders)
```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT '报单用户ID',
    non_member_id INT COMMENT '非会员用户ID',
    settlement_date DATE NOT NULL COMMENT '报单日期',
    base_price DECIMAL(10,2) NOT NULL COMMENT '基础单价',
    discount_rate DECIMAL(5,2) DEFAULT 0 COMMENT '优惠折扣率',
    final_price DECIMAL(10,2) NOT NULL COMMENT '最终单价',
    quantity INT NOT NULL COMMENT '报单数量',
    total_points DECIMAL(10,2) NOT NULL COMMENT '消耗总金币',
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending' COMMENT '订单状态',
    exported BOOLEAN DEFAULT FALSE COMMENT '是否已导出',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_settlement_date (settlement_date),
    INDEX idx_status (status)
);
```

#### 交易记录表 (transactions)
```sql
CREATE TABLE transactions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT '用户ID',
    transaction_type ENUM('recharge', 'order_deduction', 'transfer_out', 'transfer_in', 'reward') NOT NULL,
    points_change DECIMAL(10,2) NOT NULL COMMENT '金币变动（正数为收入，负数为支出）',
    balance DECIMAL(10,2) NOT NULL COMMENT '交易后余额',
    description VARCHAR(500) COMMENT '交易描述',
    related_user_id INT COMMENT '关联用户ID（转账时使用）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_created_at (created_at)
);
```

#### 异常订单表 (exception_orders)
```sql
CREATE TABLE exception_orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT COMMENT '关联订单ID',
    user_id INT NOT NULL,
    non_member_id INT COMMENT '非会员用户ID',
    description TEXT COMMENT '异常说明',
    image_url VARCHAR(500) COMMENT '异常图片URL',
    status ENUM('pending', 'processed') DEFAULT 'pending' COMMENT '处理状态',
    processed_at DATETIME COMMENT '处理时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);
```

#### 系统配置表 (system_settings)
```sql
CREATE TABLE system_settings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    setting_key VARCHAR(50) UNIQUE NOT NULL,
    setting_value TEXT NOT NULL COMMENT 'JSON格式存储',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 管理员表 (admins)
```sql
CREATE TABLE admins (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL COMMENT '加密密码',
    name VARCHAR(50) NOT NULL,
    role ENUM('super_admin', 'admin') DEFAULT 'admin',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 系统通知表 (notifications)
```sql
CREATE TABLE notifications (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    target_type ENUM('all', 'agents', 'members', 'specific') DEFAULT 'all',
    target_users TEXT COMMENT 'JSON数组，存储用户ID列表',
    status ENUM('sent', 'draft') DEFAULT 'sent',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_target_type (target_type)
);
```

## 三、API接口设计

### 3.1 用户端API

#### 认证相关
- `POST /api/v1/user/register` - 用户注册
- `POST /api/v1/user/login` - 用户登录
- `POST /api/v1/user/logout` - 用户登出
- `GET /api/v1/user/profile` - 获取用户信息
- `PUT /api/v1/user/profile` - 更新用户信息

#### 报单相关
- `GET /api/v1/orders` - 获取订单列表
- `POST /api/v1/orders` - 创建报单
- `GET /api/v1/orders/:id` - 获取订单详情
- `POST /api/v1/orders/:id/exception` - 提交异常订单

#### 用户管理相关
- `GET /api/v1/users/nonmembers` - 获取非会员列表
- `POST /api/v1/users/nonmembers` - 添加非会员
- `DELETE /api/v1/users/nonmembers/:id` - 删除非会员
- `GET /api/v1/users/ordinary` - 获取普通会员列表
- `GET /api/v1/users/agents` - 获取代理会员列表
- `POST /api/v1/users/upgrade-to-ordinary` - 升级为普通会员
- `POST /api/v1/users/upgrade-to-agent` - 升级为代理会员

#### 金币相关
- `GET /api/v1/points/balance` - 获取金币余额
- `GET /api/v1/points/history` - 获取金币历史记录
- `POST /api/v1/points/transfer` - 转账金币

#### 奖励相关
- `GET /api/v1/rewards/summary` - 获取奖励汇总
- `GET /api/v1/rewards/details` - 获取奖励明细

### 3.2 后台管理API

#### 管理员认证
- `POST /api/v1/admin/login` - 管理员登录
- `POST /api/v1/admin/logout` - 管理员登出

#### 会员管理
- `GET /api/v1/admin/members` - 获取会员列表（分页、筛选）
- `DELETE /api/v1/admin/members/:id` - 删除会员
- `PUT /api/v1/admin/members/:id/parent` - 更换上级
- `GET /api/v1/admin/members/:id/orders` - 获取会员订单详情

#### 代理管理
- `GET /api/v1/admin/agents` - 获取代理列表（分页、筛选）
- `DELETE /api/v1/admin/agents/:id` - 删除代理
- `PUT /api/v1/admin/agents/:id/parent` - 更换上级
- `POST /api/v1/admin/agents/:id/recharge` - 代理充值
- `GET /api/v1/admin/agents/:id/subordinates` - 获取下级列表

#### 报单管理
- `GET /api/v1/admin/orders` - 获取报单列表（分页、筛选）
- `POST /api/v1/admin/orders/export` - 导出报单
- `PUT /api/v1/admin/orders/:id/export-status` - 更新导出状态

#### 交易查询
- `GET /api/v1/admin/transactions` - 获取交易记录（分页、筛选）
- `GET /api/v1/admin/transactions/stats` - 获取交易统计

#### 异常订单
- `GET /api/v1/admin/exceptions` - 获取异常订单列表
- `PUT /api/v1/admin/exceptions/:id/process` - 处理异常订单
- `POST /api/v1/admin/exceptions/export` - 导出异常订单

#### 系统配置
- `GET /api/v1/admin/settings` - 获取系统配置
- `PUT /api/v1/admin/settings` - 更新系统配置
- `PUT /api/v1/admin/settings/pay-password` - 修改用户支付密码

#### 数据备份
- `POST /api/v1/admin/backup` - 创建数据备份
- `GET /api/v1/admin/backups` - 获取备份列表
- `POST /api/v1/admin/backups/:id/restore` - 恢复备份
- `DELETE /api/v1/admin/backups/:id` - 删除备份

#### 系统通知
- `GET /api/v1/admin/notifications` - 获取通知列表
- `POST /api/v1/admin/notifications` - 发送通知
- `DELETE /api/v1/admin/notifications/:id` - 删除通知

## 四、前端API调用改造

### 4.1 改造步骤

#### 第一步：启用真实API调用
在 `api.js` 中，将 `request` 方法改为真实API调用：

```javascript
async request(url, options = {}) {
  const config = {
    method: options.method || 'GET',
    headers: {
      'Content-Type': 'application/json',
      ...(this.token && { 'Authorization': `Bearer ${this.token}` }),
      ...options.headers
    }
  };

  // 处理GET请求的查询参数
  if (config.method === 'GET' && options.params) {
    const params = new URLSearchParams(options.params);
    url += '?' + params.toString();
  } else if (options.body) {
    config.body = options.body;
  }

  try {
    const response = await fetch(`${API_BASE_URL}${url}`, config);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('API请求失败:', error);
    return new APIResponse(false, null, error.message);
  }
}
```

#### 第二步：添加用户端API方法
在 `api.js` 中添加用户端API方法：

```javascript
// 用户注册
async register(userData) {
  return await this.request('/user/register', {
    method: 'POST',
    body: JSON.stringify(userData)
  });
}

// 用户登录
async userLogin(phone, password) {
  const response = await this.request('/user/login', {
    method: 'POST',
    body: JSON.stringify({ phone, password })
  });
  
  if (response.success && response.data) {
    this.token = response.data.token;
    this.userInfo = response.data.user;
    localStorage.setItem('user_token', this.token);
    localStorage.setItem('user_info', JSON.stringify(this.userInfo));
  }
  
  return response;
}

// 创建报单
async createOrder(orderData) {
  return await this.request('/orders', {
    method: 'POST',
    body: JSON.stringify(orderData)
  });
}

// 转账金币
async transferPoints(transferData) {
  return await this.request('/points/transfer', {
    method: 'POST',
    body: JSON.stringify(transferData)
  });
}
```

#### 第三步：改造前端调用
在 `all_pages.html` 中，取消注释并修改所有API调用：

```javascript
// 注册功能
async function handleRegister() {
  // ... 验证逻辑 ...
  
  const response = await apiService.register({ 
    name, phone, password, promoCode, payPassword 
  });
  
  if (response.success) {
    alert('注册成功');
    showPage('orders-page');
  } else {
    alert(response.message || '注册失败');
  }
}

// 报单功能
async function confirmPointsDeduction() {
  // ... 验证逻辑 ...
  
  const orderData = {
    nonMemberIds: selectedNonMemberIds,
    settlementDate: settlementDateInput.value,
    quantity: pendingOrderCount
  };
  
  const response = await apiService.createOrder(orderData);
  
  if (response.success) {
    // 更新本地状态
    // 显示成功提示
  }
}
```

## 五、测试计划

### 5.1 单元测试
- API接口测试
- 数据验证测试
- 业务逻辑测试

### 5.2 集成测试
- 前后端联调测试
- 数据流测试
- 异常情况测试

### 5.3 功能测试清单

#### 用户端功能
- [ ] 用户注册（推广码唯一性验证）
- [ ] 用户登录
- [ ] 报单功能（日期验证、金币计算）
- [ ] 添加非会员/普通会员/代理会员
- [ ] 金币转账（价格验证）
- [ ] 查看订单历史
- [ ] 查看奖励明细

#### 后台管理功能
- [ ] 管理员登录
- [ ] 会员管理（增删改查、更换上级）
- [ ] 代理管理（充值、查看下级）
- [ ] 报单管理（筛选、导出）
- [ ] 交易查询（统计、筛选）
- [ ] 异常订单处理
- [ ] 系统配置管理
- [ ] 支付密码修改
- [ ] 数据备份恢复
- [ ] 系统通知发送

## 六、部署方案

### 6.1 开发环境
- 本地开发服务器
- 本地数据库
- 前端使用本地文件或简单HTTP服务器

### 6.2 测试环境
- 测试服务器
- 测试数据库
- 前后端分离部署

### 6.3 生产环境
- 生产服务器（建议使用云服务器）
- 生产数据库（建议使用云数据库）
- CDN加速静态资源
- HTTPS证书
- 数据备份策略

## 七、实施步骤

### 阶段一：后端基础搭建（1-2天）
1. 搭建后端框架
2. 创建数据库表结构
3. 实现基础API接口（登录、注册）
4. 配置JWT认证

### 阶段二：核心功能开发（3-5天）
1. 用户管理API
2. 报单功能API
3. 金币系统API
4. 奖励计算API

### 阶段三：后台管理API（2-3天）
1. 会员管理API
2. 代理管理API
3. 报单管理API
4. 系统配置API

### 阶段四：前端对接（2-3天）
1. 改造api.js使用真实API
2. 取消注释前端API调用
3. 处理API响应和错误
4. 更新UI状态

### 阶段五：测试和优化（2-3天）
1. 功能测试
2. 性能优化
3. 安全加固
4. 文档完善

## 八、注意事项

### 8.1 安全考虑
- 密码加密存储（使用bcrypt等）
- JWT Token过期时间设置
- API请求频率限制
- SQL注入防护
- XSS攻击防护

### 8.2 性能优化
- 数据库索引优化
- API响应缓存
- 分页查询优化
- 图片上传优化

### 8.3 错误处理
- 统一的错误响应格式
- 前端错误提示
- 日志记录
- 异常监控

## 九、API响应格式规范

### 成功响应
```json
{
  "success": true,
  "data": {
    // 数据内容
  },
  "message": "操作成功",
  "timestamp": "2023-06-15T10:30:00Z"
}
```

### 错误响应
```json
{
  "success": false,
  "data": null,
  "message": "错误信息",
  "timestamp": "2023-06-15T10:30:00Z",
  "error_code": "ERROR_CODE"
}
```

## 十、下一步行动

1. **确认后端技术栈** - 选择Python/Node.js等
2. **创建后端项目** - 搭建基础框架
3. **设计数据库** - 创建表结构
4. **实现核心API** - 按优先级实现接口
5. **前端对接** - 逐步替换模拟数据
6. **测试验证** - 完整功能测试
7. **部署上线** - 部署到服务器

---

**建议**: 可以先实现一个最小可用版本（MVP），包括用户注册、登录、报单等核心功能，然后再逐步完善其他功能。

